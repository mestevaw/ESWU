<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESWU</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary: #1a365d; --primary-dark: #0f2744; --secondary: #2c5282;
            --accent: #3182ce; --success: #38a169; --danger: #e53e3e; --warning: #dd6b20;
            --bg: #f7fafc; --card-bg: #ffffff; --text: #2d3748; --text-light: #718096;
            --border: #e2e8f0; --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); line-height: 1.6; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center; z-index: 10000; }
        .loading-overlay.hidden { display: none; }
        .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .login-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); }
        .login-container.hidden { display: none; }
        .login-box { background: white; padding: 3rem; border-radius: 12px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); width: 90%; max-width: 400px; }
        .login-box h1 { color: var(--primary); margin-bottom: 2rem; text-align: center; font-size: 2rem; }
        .app-container { display: none; min-height: 100vh; }
        .app-container.active { display: block; }
        .header { background: var(--primary); color: white; padding: 1rem 2rem; box-shadow: var(--shadow); display: flex; justify-content: space-between; align-items: center; position: relative; }
        .header-title { font-size: 2rem; font-weight: 700; flex: 1; text-align: center; }
        .header-menu { position: absolute; left: 2rem; display: flex; flex-direction: column; gap: 0.5rem; align-items: flex-start; }
        .home-icon { font-size: 1.5rem; cursor: pointer; color: white; text-decoration: none; }
        .home-icon:hover { opacity: 0.8; }
        .main-content { padding: 2rem; max-width: 1400px; margin: 0 auto; }
        .page { display: none; }
        .page.active { display: block; }
        .card { background: var(--card-bg); border-radius: 8px; box-shadow: var(--shadow); margin-bottom: 2rem; overflow: hidden; }
        .card-header { padding: 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .card-title { font-size: 1.5rem; color: var(--primary); font-weight: 600; }
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .summary-card { background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: white; padding: 1.5rem; border-radius: 8px; box-shadow: var(--shadow); cursor: pointer; transition: transform 0.2s; }
        .summary-card:hover { transform: translateY(-2px); }
        .summary-card.active { border: 3px solid white; }
        .summary-label { font-size: 0.875rem; margin-bottom: 0.5rem; opacity: 0.9; }
        .summary-value { font-size: 2rem; font-weight: 700; }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; table-layout: auto; }
        thead { background: var(--bg); }
        th { padding: 1rem; text-align: left; font-weight: 600; color: var(--text); border-bottom: 2px solid var(--border); white-space: nowrap; }
        td { padding: 1rem; border-bottom: 1px solid var(--border); white-space: nowrap; }
        tr:hover { background: var(--bg); }
        .currency { text-align: right; font-variant-numeric: tabular-nums; }
        .vencimiento-proximo { color: var(--danger); font-weight: bold; }
        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 6px; font-size: 1rem; font-weight: 500; cursor: pointer; transition: all 0.2s; text-decoration: none; display: inline-block; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { filter: brightness(1.1); }
        .btn-secondary { background: var(--text-light); color: white; }
        .btn-secondary:hover { filter: brightness(0.9); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { filter: brightness(1.1); }
        .btn-sm { padding: 0.5rem 1rem; font-size: 0.875rem; }
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text); }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 6px; font-size: 1rem; font-family: inherit; transition: border-color 0.2s; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--primary); }
        .form-group textarea { resize: vertical; min-height: 100px; }
        .filter-section { display: flex; gap: 1rem; margin-bottom: 1.5rem; align-items: center; flex-wrap: wrap; }
        .filter-section label { font-weight: 500; }
        .filter-section select { padding: 0.5rem 1rem; border: 2px solid var(--border); border-radius: 6px; font-size: 1rem; }
        .hidden { display: none !important; }
        .tables-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 2rem; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000; overflow-y: auto; }
        .modal.active { display: flex; align-items: center; justify-content: center; padding: 2rem; }
        .modal-content { background: white; border-radius: 12px; width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); }
        .modal-header { padding: 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; position: relative; }
        .modal-header-left { display: flex; align-items: center; gap: 1rem; }
        .modal-title { font-size: 1.25rem; color: var(--primary); font-weight: 600; flex: 1; }
        .close-modal { background: none; border: none; font-size: 2rem; color: white; cursor: pointer; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; position: absolute; left: 1.5rem; }
        .close-modal:hover { opacity: 0.8; }
        .modal-content form { padding: 1.5rem; }
        .modal-actions { padding: 1.5rem; border-top: 1px solid var(--border); display: flex; gap: 1rem; justify-content: flex-end; }
        .file-upload { border: 2px dashed var(--border); border-radius: 6px; padding: 2rem; text-align: center; cursor: pointer; transition: all 0.2s; }
        .file-upload:hover { border-color: var(--primary); background: var(--bg); }
        .file-upload input[type="file"] { display: none; }
        .info-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1rem; }
        .info-item { padding: 0.75rem; background: var(--bg); border-radius: 6px; }
        .info-label { font-size: 0.875rem; color: var(--text-light); margin-bottom: 0.25rem; }
        .info-value { font-weight: 600; color: var(--text); }
        .payment-item { display: flex; justify-content: space-between; padding: 1rem; border-bottom: 1px solid var(--border); transition: background 0.2s; }
        .payment-item:hover { background: var(--bg); }
        .doc-item { display: flex; justify-content: space-between; padding: 1rem; border-bottom: 1px solid var(--border); cursor: pointer; transition: background 0.2s; }
        .doc-item:hover { background: var(--bg); }
        .badge { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.875rem; font-weight: 500; }
        .badge-success { background: #c6f6d5; color: #22543d; }
        .badge-warning { background: #feebc8; color: #7c2d12; }
        .badge-danger { background: #fed7d7; color: #742a2a; }
        .dropdown { position: relative; display: inline-block; }
        .dropdown-toggle { background: var(--primary); color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 6px; cursor: pointer; font-size: 1.2rem; font-weight: 500; }
        .dropdown-toggle:hover { background: var(--primary-dark); }
        .dropdown-content { display: none; position: absolute; right: 0; background: white; min-width: 220px; box-shadow: 0 8px 16px rgba(0,0,0,0.2); z-index: 1000; border-radius: 6px; overflow: hidden; margin-top: 0.5rem; }
        .dropdown-content.show { display: block; }
        .dropdown-content a { color: var(--text); padding: 12px 16px; text-decoration: none; display: block; transition: background 0.2s; }
        .dropdown-content a:hover { background: var(--bg); }
        .photo-gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; margin: 1rem 0; }
        .photo-item { position: relative; border-radius: 8px; overflow: hidden; aspect-ratio: 1; }
        .photo-item img { width: 100%; height: 100%; object-fit: cover; }
        .main-menu-dropdown { position: relative; }
        .main-menu-content { display: none; position: absolute; left: 0; top: 100%; background: white; min-width: 200px; box-shadow: 0 8px 16px rgba(0,0,0,0.2); z-index: 1000; border-radius: 6px; overflow: hidden; margin-top: 0.5rem; }
        .main-menu-content.show { display: block; }
        .main-menu-content a { color: var(--text); padding: 12px 16px; text-decoration: none; display: block; transition: background 0.2s; font-weight: 500; }
        .main-menu-content a:hover { background: var(--bg); }
        .total-row { font-weight: bold; background: #e6f2ff; }
        @media (max-width: 768px) {
            .header { padding: 0.75rem 1rem; }
            .header-title { font-size: 1.5rem; text-align: right; }
            .header-menu { left: 1rem; }
            .main-content { padding: 1rem; }
            .summary-grid { grid-template-columns: 1fr; gap: 1rem; }
            .summary-card { padding: 1.25rem; }
            .summary-label { font-size: 0.875rem; }
            .summary-value { font-size: 1.5rem; }
            .tables-grid { grid-template-columns: 1fr; }
            .info-grid { grid-template-columns: 1fr; }
            table { font-size: 0.875rem; }
            th, td { padding: 0.5rem; }
            .card-header { flex-direction: column; gap: 1rem; align-items: flex-start; }
            .dropdown { display: none; }
            .proveedor-truncate { max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        }
    </style>
</head>
<body>
    <div id="loadingOverlay" class="loading-overlay hidden"><div class="loading-spinner"></div></div>
    <div id="loginContainer" class="login-container">
        <div class="login-box">
            <h1>ESWU</h1>
            <form id="loginForm">
                <div class="form-group">
                    <select id="username" required style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 6px;">
                        <option value="">Usuario</option>
                        <option value="Anabel">Anabel</option>
                        <option value="Doris">Doris</option>
                        <option value="Miguel">Miguel</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Iniciar Sesi√≥n</button>
            </form>
        </div>
    </div>
    <div id="appContainer" class="app-container">
        <div class="header">
            <div class="header-menu">
                <a href="#" class="home-icon" onclick="event.preventDefault(); showPageFromMenu('home');" title="Home">üè†</a>
                <div class="main-menu-dropdown">
                    <button class="dropdown-toggle" onclick="toggleMainMenu()">‚ò∞</button>
                    <div id="mainMenuDropdown" class="main-menu-content"></div>
                </div>
            </div>
            <div class="header-title" id="headerTitle">ESWU</div>
        </div>
        <div class="main-content">
            <div id="homePage" class="page active">
                <div class="summary-grid">
                    <div class="summary-card" onclick="toggleHomeTable('ingresos')">
                        <div class="summary-label">Ingresos</div>
                        <div class="summary-value currency" id="summaryIngresos">$0</div>
                    </div>
                    <div class="summary-card" onclick="toggleHomeTable('pagos')">
                        <div class="summary-label">Pagos a Terceros</div>
                        <div class="summary-value currency" id="summaryGastos">$0</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">Ingreso Neto</div>
                        <div class="summary-value currency" id="summaryNeto">$0</div>
                    </div>
                </div>
                <div class="filter-section">
                    <label>Ver por:</label>
                    <select id="homeFilter" onchange="updateHomeView()"><option value="anual">Anual</option><option value="mensual">Mensual</option></select>
                    <select id="homeYear" onchange="updateHomeView()"></select>
                    <select id="homeMonth" onchange="updateHomeView()" class="hidden">
                        <option value="0">Enero</option><option value="1">Febrero</option><option value="2">Marzo</option><option value="3">Abril</option>
                        <option value="4">Mayo</option><option value="5">Junio</option><option value="6">Julio</option><option value="7">Agosto</option>
                        <option value="8">Septiembre</option><option value="9">Octubre</option><option value="10">Noviembre</option><option value="11">Diciembre</option>
                    </select>
                </div>
                <div id="homeTablesContainer">
                    <div id="homeIngresosContainer" class="hidden">
                        <div class="card">
                            <div class="card-header"><h2 class="card-title">Ingresos por Renta</h2></div>
                            <div class="table-container"><table id="homeIngresosTable"><thead><tr><th>Inquilino</th><th>Fecha</th><th>Monto</th></tr></thead><tbody></tbody></table></div>
                        </div>
                    </div>
                    <div id="homePagosContainer" class="hidden">
                        <div class="card">
                            <div class="card-header"><h2 class="card-title">Facturas Por Pagar</h2></div>
                            <div class="table-container"><table id="homeFacturasPorPagarTable"><thead><tr><th>Proveedor</th><th>Monto</th><th>Vencimiento</th></tr></thead><tbody></tbody></table></div>
                        </div>
                        <div class="card">
                            <div class="card-header"><h2 class="card-title">Facturas Pagadas</h2></div>
                            <div class="table-container"><table id="homeFacturasPagadasTable"><thead><tr><th>Proveedor</th><th>Monto</th><th>Fecha Pago</th></tr></thead><tbody></tbody></table></div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="inquilinosPage" class="page">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title" id="inquilinosTitulo">Inquilinos - Listado</h2>
                    </div>
                    <div id="inquilinosListView">
                        <div class="table-container">
                            <table id="inquilinosTable">
                                <thead><tr><th>Empresa</th><th style="text-align:right">Renta Mensual</th><th>Vencimiento Contrato</th><th>Contrato</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                    <div id="inquilinosRentasRecibidasView" class="hidden">
                        <div style="padding: 1rem;">
                            <div class="filter-section">
                                <select id="inquilinosRentasFilter" onchange="renderInquilinosRentasRecibidas()"><option value="anual">Anual</option><option value="mensual">Mensual</option></select>
                                <select id="inquilinosRentasYear" onchange="renderInquilinosRentasRecibidas()"></select>
                                <select id="inquilinosRentasMonth" onchange="renderInquilinosRentasRecibidas()" class="hidden">
                                    <option value="0">Enero</option><option value="1">Febrero</option><option value="2">Marzo</option><option value="3">Abril</option>
                                    <option value="4">Mayo</option><option value="5">Junio</option><option value="6">Julio</option><option value="7">Agosto</option>
                                    <option value="8">Septiembre</option><option value="9">Octubre</option><option value="10">Noviembre</option><option value="11">Diciembre</option>
                                </select>
                            </div>
                            <div class="table-container">
                                <table id="inquilinosRentasRecibidasTable">
                                    <thead><tr><th>Empresa</th><th>Renta Recibida</th><th>Fecha de Pago</th></tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div id="inquilinosVencimientoContratosView" class="hidden">
                        <div style="padding: 1rem;">
                            <div class="table-container">
                                <table id="inquilinosVencimientoContratosTable">
                                    <thead><tr><th>Inquilino</th><th>Fecha Inicio</th><th>Fecha Vencimiento</th><th>D√≠as Restantes</th><th>Estado</th></tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="proveedoresPage" class="page">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title" id="proveedoresTitulo">Proveedores - Listado</h2>
                    </div>
                    <div id="proveedoresListView">
                        <div class="table-container">
                            <table id="proveedoresTable">
                                <thead><tr><th>Nombre</th><th>Servicio</th><th>Nombre de Contacto</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                    <div id="proveedoresFacturasPagadasView" class="hidden">
                        <div style="padding: 1rem;">
                            <div class="table-container">
                                <table id="proveedoresFacturasPagadasTable">
                                    <thead><tr><th>Proveedor</th><th>Factura</th><th style="text-align:right">Monto</th><th>Fecha Pago</th></tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div id="proveedoresFacturasPorPagarView" class="hidden">
                        <div style="padding: 1rem;">
                            <div class="table-container">
                                <table id="proveedoresFacturasPorPagarTable">
                                    <thead><tr><th>Proveedor</th><th>Factura</th><th style="text-align:right">Monto</th><th>Vencimiento</th><th>Estado</th></tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="activosPage" class="page">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Activos</h2>
                    </div>
                    <div class="table-container">
                        <table id="activosTable">
                            <thead><tr><th>Nombre</th><th>√öltimo Mantenimiento</th><th>Pr√≥ximo Mantenimiento</th><th>Proveedor</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div id="chatPage" class="page">
                <div class="card">
                    <div class="card-header"><h2 class="card-title">Chat</h2></div>
                    <div style="padding: 2rem; text-align: center; color: var(--text-light);"><p>Funcionalidad de Chat - Pr√≥ximamente</p></div>
                </div>
            </div>
            <div id="addInquilinoModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title" id="addInquilinoTitle">Agregar Inquilino</h2>
                        <button class="close-modal" onclick="closeModal('addInquilinoModal')">√ó</button>
                    </div>
                    <form id="inquilinoForm" onsubmit="saveInquilino(event)">
                        <div class="form-group"><label>Nombre de la Empresa *</label><input type="text" id="inquilinoNombre" required autocomplete="off"></div>
                        <div class="form-group"><label>Contacto *</label><input type="text" id="inquilinoContacto" required autocomplete="off"></div>
                        <div class="form-group"><label>Tel√©fono</label><input type="tel" id="inquilinoTelefono" autocomplete="off"></div>
                        <div class="form-group"><label>Email</label><input type="email" id="inquilinoEmail" autocomplete="off"></div>
                        <div class="form-group"><label>CLABE</label><input type="text" id="inquilinoClabe" autocomplete="off"></div>
                        <div class="form-group"><label>RFC</label><input type="text" id="inquilinoRFC" autocomplete="off"></div>
                        <div class="form-group"><label>M¬≤</label><input type="text" id="inquilinoM2" autocomplete="off"></div>
                        <div class="form-group"><label>Renta Mensual *</label><input type="number" id="inquilinoRenta" step="0.01" required autocomplete="off"></div>
                        <div class="form-group"><label>Fecha Inicio Contrato *</label><input type="date" id="inquilinoFechaInicio" required></div>
                        <div class="form-group"><label>Fecha Vencimiento Contrato *</label><input type="date" id="inquilinoFechaVenc" required></div>
                        <div class="form-group">
                            <label>Contrato (PDF)</label>
                            <div class="file-upload" onclick="document.getElementById('inquilinoContrato').click()">
                                <input type="file" id="inquilinoContrato" accept=".pdf">
                                <p>Click para seleccionar PDF del contrato</p>
                                <p id="contratoFileName" style="color: var(--success); margin-top: 0.5rem;"></p>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Documentos Adicionales (PDF)</label>
                            <div class="file-upload" onclick="document.getElementById('inquilinoDocAdicional').click()">
                                <input type="file" id="inquilinoDocAdicional" accept=".pdf">
                                <p>Click para seleccionar PDF adicional</p>
                                <p id="docAdicionalFileName" style="color: var(--success); margin-top: 0.5rem;"></p>
                            </div>
                        </div>
                        <div class="form-group hidden" id="nombreDocGroup">
                            <label>Nombre del Documento *</label>
                            <input type="text" id="inquilinoNombreDoc" autocomplete="off">
                        </div>
                        <div class="form-group"><label>Notas</label><textarea id="inquilinoNotas"></textarea></div>
                        <div class="modal-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeModal('addInquilinoModal')">Cancelar</button>
                            <button type="submit" class="btn btn-success">Guardar</button>
                        </div>
                    </form>
                </div>
            </div>
            <div id="inquilinoDetailModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-header-left">
                            <button class="close-modal" onclick="closeModal('inquilinoDetailModal')">√ó</button>
                            <div class="dropdown">
                                <button class="dropdown-toggle" onclick="toggleDropdown('inquilinoDetailDropdown')" style="font-size: 1rem; padding: 0.5rem 1rem;">‚ò∞</button>
                                <div id="inquilinoDetailDropdown" class="dropdown-content">
                                    <a href="#" onclick="event.preventDefault(); showRegistrarPagoModal();">Dar Renta X Pagada</a>
                                    <a href="#" onclick="event.preventDefault(); editInquilino();">Modificar</a>
                                    <a href="#" onclick="event.preventDefault(); deleteInquilino();">Eliminar</a>
                                </div>
                            </div>
                        </div>
                        <h2 class="modal-title" id="inquilinoDetailNombre"></h2>
                    </div>
                    <div style="padding: 1.5rem;">
                        <div class="info-grid">
                            <div class="info-item"><div class="info-label">Contacto</div><div class="info-value" id="detailContacto"></div></div>
                            <div class="info-item"><div class="info-label">Tel√©fono</div><div class="info-value" id="detailTelefono"></div></div>
                            <div class="info-item"><div class="info-label">Email</div><div class="info-value" id="detailEmail"></div></div>
                            <div class="info-item"><div class="info-label">CLABE</div><div class="info-value" id="detailClabe"></div></div>
                            <div class="info-item"><div class="info-label">RFC</div><div class="info-value" id="detailRFC"></div></div>
                            <div class="info-item"><div class="info-label">M¬≤</div><div class="info-value" id="detailM2"></div></div>
                            <div class="info-item"><div class="info-label">Renta Mensual</div><div class="info-value currency" id="detailRenta"></div></div>
                            <div class="info-item"><div class="info-label">Fecha Inicio</div><div class="info-value" id="detailFechaInicio"></div></div>
                            <div class="info-item"><div class="info-label">Fecha Vencimiento</div><div class="info-value" id="detailFechaVenc"></div></div>
                        </div>
                        <div id="contratoSection" class="hidden" style="margin-top: 1rem;">
                            <button class="btn btn-sm btn-primary" onclick="viewContrato()">Ver Contrato PDF</button>
                        </div>
                        <h3 style="margin: 1.5rem 0 1rem 0;">Historial de Pagos</h3>
                        <div id="historialPagos"></div>
                        <h3 style="margin: 1.5rem 0 1rem 0;">Documentos Adicionales</h3>
                        <div id="documentosAdicionales"></div>
                    </div>
                </div>
            </div>
            <div id="registrarPagoModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title">Dar Renta X Pagada</h2>
                        <button class="close-modal" onclick="closeModal('registrarPagoModal')">√ó</button>
                    </div>
                    <form onsubmit="savePagoRenta(event)">
                        <div style="padding: 1.5rem;">
                            <div class="form-group"><label>Fecha de Pago *</label><input type="date" id="pagoFecha" required></div>
                            <div class="form-group">
                                <label>¬øPago Completo? *</label>
                                <select id="pagoCompleto" onchange="toggleMontoInput()">
                                    <option value="si">S√≠</option>
                                    <option value="no">No</option>
                                </select>
                            </div>
                            <div class="form-group hidden" id="pagoMontoGroup">
                                <label>Monto Pagado *</label>
                                <input type="number" id="pagoMonto" step="0.01">
                            </div>
                        </div>
                        <div class="modal-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeModal('registrarPagoModal')">Cancelar</button>
                            <button type="submit" class="btn btn-success">Guardar Pago</button>
                        </div>
                    </form>
                </div>
            </div>
            <div id="addProveedorModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title" id="addProveedorTitle">Agregar Proveedor</h2>
                        <button class="close-modal" onclick="closeModal('addProveedorModal')">√ó</button>
                    </div>
                    <form id="proveedorForm" onsubmit="saveProveedor(event)">
                        <div class="form-group"><label>Nombre *</label><input type="text" id="proveedorNombre" required autocomplete="off"></div>
                        <div class="form-group"><label>Servicio *</label><input type="text" id="proveedorServicio" required autocomplete="off"></div>
                        <div class="form-group"><label>Nombre de Contacto *</label><input type="text" id="proveedorContacto" required autocomplete="off"></div>
                        <div class="form-group"><label>Tel√©fono</label><input type="tel" id="proveedorTelefono" autocomplete="off"></div>
                        <div class="form-group"><label>Email</label><input type="email" id="proveedorEmail" autocomplete="off"></div>
                        <div class="form-group"><label>CLABE</label><input type="text" id="proveedorClabe" autocomplete="off"></div>
                        <div class="form-group"><label>RFC</label><input type="text" id="proveedorRFC" autocomplete="off"></div>
                        <div class="form-group">
                            <label>Documentos Adicionales (PDF)</label>
                            <div class="file-upload" onclick="document.getElementById('proveedorDocAdicional').click()">
                                <input type="file" id="proveedorDocAdicional" accept=".pdf">
                                <p>Click para seleccionar PDF adicional</p>
                                <p id="provDocAdicionalFileName" style="color: var(--success); margin-top: 0.5rem;"></p>
                            </div>
                        </div>
                        <div class="form-group hidden" id="nombreProvDocGroup">
                            <label>Nombre del Documento *</label>
                            <input type="text" id="proveedorNombreDoc" autocomplete="off">
                        </div>
                        <div class="form-group"><label>Notas</label><textarea id="proveedorNotas"></textarea></div>
                        <div class="modal-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeModal('addProveedorModal')">Cancelar</button>
                            <button type="submit" class="btn btn-success">Guardar</button>
                        </div>
                    </form>
                </div>
            </div>
            <div id="proveedorDetailModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-header-left">
                            <button class="close-modal" onclick="closeModal('proveedorDetailModal')">√ó</button>
                            <div class="dropdown">
                                <button class="dropdown-toggle" onclick="toggleDropdown('proveedorDetailDropdown')" style="font-size: 1rem; padding: 0.5rem 1rem;">‚ò∞</button>
                                <div id="proveedorDetailDropdown" class="dropdown-content">
                                    <a href="#" onclick="event.preventDefault(); showRegistrarFacturaModal();">Registrar Factura</a>
                                    <a href="#" onclick="event.preventDefault(); editProveedor();">Modificar Datos</a>
                                    <a href="#" onclick="event.preventDefault(); deleteProveedor();">Eliminar</a>
                                </div>
                            </div>
                        </div>
                        <h2 class="modal-title" id="proveedorDetailNombre"></h2>
                    </div>
                    <div style="padding: 1.5rem;">
                        <div class="info-grid">
                            <div class="info-item"><div class="info-label">Servicio</div><div class="info-value" id="detailServicio"></div></div>
                            <div class="info-item"><div class="info-label">Nombre de Contacto</div><div class="info-value" id="detailProvContacto"></div></div>
                            <div class="info-item"><div class="info-label">Tel√©fono</div><div class="info-value" id="detailProvTelefono"></div></div>
                            <div class="info-item"><div class="info-label">Email</div><div class="info-value" id="detailProvEmail"></div></div>
                            <div class="info-item"><div class="info-label">CLABE</div><div class="info-value" id="detailProvClabe"></div></div>
                            <div class="info-item"><div class="info-label">RFC</div><div class="info-value" id="detailProvRFC"></div></div>
                        </div>
                        <h3 style="margin: 1.5rem 0 1rem 0;">Facturas X Pagar</h3>
                        <div id="historialFacturas"></div>
                        <h3 style="margin: 1.5rem 0 1rem 0;">Documentos Adicionales</h3>
                        <div id="proveedorDocumentosAdicionales"></div>
                    </div>
                </div>
            </div>
            <div id="facturaDetailModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title">Detalle de Factura</h2>
                        <button class="close-modal" onclick="closeModal('facturaDetailModal')">√ó</button>
                    </div>
                    <div style="padding: 1.5rem;">
                        <div class="info-grid">
                            <div class="info-item"><div class="info-label">Proveedor</div><div class="info-value" id="factDetailProveedor"></div></div>
                            <div class="info-item"><div class="info-label">N√∫mero</div><div class="info-value" id="factDetailNumero"></div></div>
                            <div class="info-item"><div class="info-label">Fecha</div><div class="info-value" id="factDetailFecha"></div></div>
                            <div class="info-item"><div class="info-label">Vencimiento</div><div class="info-value" id="factDetailVencimiento"></div></div>
                            <div class="info-item"><div class="info-label">Monto</div><div class="info-value currency" id="factDetailMonto"></div></div>
                            <div class="info-item"><div class="info-label">IVA</div><div class="info-value currency" id="factDetailIVA"></div></div>
                        </div>
                        <div style="margin-top: 1.5rem; text-align: center;">
                            <button class="btn btn-success" onclick="showPagarFacturaModalFromDetail()">Dar X Pagada</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="registrarFacturaModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title">Registrar Factura</h2>
                        <button class="close-modal" onclick="closeModal('registrarFacturaModal')">√ó</button>
                    </div>
                    <form onsubmit="saveFactura(event)">
                        <div style="padding: 1.5rem;">
                            <div class="form-group"><label>N√∫mero de Factura</label><input type="text" id="facturaNumero" autocomplete="off"></div>
                            <div class="form-group"><label>Fecha Factura *</label><input type="date" id="facturaFecha" required></div>
                            <div class="form-group"><label>Vencimiento *</label><input type="date" id="facturaVencimiento" required></div>
                            <div class="form-group"><label>Monto *</label><input type="number" id="facturaMonto" step="0.01" required autocomplete="off" onchange="calculateIVA()"></div>
                            <div class="form-group"><label>IVA</label><input type="number" id="facturaIVA" step="0.01" autocomplete="off"></div>
                            <div class="form-group">
                                <label>Factura (PDF)</label>
                                <div class="file-upload" onclick="document.getElementById('facturaDocumento').click()">
                                    <input type="file" id="facturaDocumento" accept=".pdf">
                                    <p>Click para seleccionar PDF de la factura</p>
                                    <p id="facturaDocumentoFileName" style="color: var(--success); margin-top: 0.5rem;"></p>
                                </div>
                            </div>
                        </div>
                        <div class="modal-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeModal('registrarFacturaModal')">Cancelar</button>
                            <button type="submit" class="btn btn-success">Guardar</button>
                        </div>
                    </form>
                </div>
            </div>
            <div id="pagarFacturaModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title">Dar Factura X Pagada</h2>
                        <button class="close-modal" onclick="closeModal('pagarFacturaModal')">√ó</button>
                    </div>
                    <form onsubmit="savePagoFactura(event)">
                        <div style="padding: 1.5rem;">
                            <div class="form-group"><label>Fecha de Pago *</label><input type="date" id="fechaPagoFactura" required></div>
                            <div class="form-group">
                                <label>Comprobante de Pago (PDF)</label>
                                <div class="file-upload" onclick="document.getElementById('pagoPDFFactura').click()">
                                    <input type="file" id="pagoPDFFactura" accept=".pdf">
                                    <p>Click para seleccionar PDF del comprobante</p>
                                    <p id="pagoPDFFacturaFileName" style="color: var(--success); margin-top: 0.5rem;"></p>
                                </div>
                            </div>
                        </div>
                        <div class="modal-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeModal('pagarFacturaModal')">Cancelar</button>
                            <button type="submit" class="btn btn-success">Guardar Pago</button>
                        </div>
                    </form>
                </div>
            </div>
            <div id="addActivoModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title" id="addActivoTitle">Agregar Activo</h2>
                        <button class="close-modal" onclick="closeModal('addActivoModal')">√ó</button>
                    </div>
                    <form id="activoForm" onsubmit="saveActivo(event)">
                        <div class="form-group"><label>Nombre *</label><input type="text" id="activoNombre" required autocomplete="off"></div>
                        <div class="form-group"><label>√öltimo Mantenimiento</label><input type="date" id="activoUltimoMant"></div>
                        <div class="form-group"><label>Pr√≥ximo Mantenimiento</label><input type="date" id="activoProximoMant"></div>
                        <div class="form-group">
                            <label>Proveedor</label>
                            <select id="activoProveedor">
                                <option value="">-- Seleccione un proveedor --</option>
                            </select>
                        </div>
                        <div class="form-group"><label>Notas</label><textarea id="activoNotas"></textarea></div>
                        <div class="form-group">
                            <label>Fotos</label>
                            <div class="file-upload" onclick="document.getElementById('activoFotos').click()">
                                <input type="file" id="activoFotos" accept="image/*" multiple>
                                <p>Click para seleccionar fotos</p>
                                <p id="activoFotosFileName" style="color: var(--success); margin-top: 0.5rem;"></p>
                            </div>
                        </div>
                        <div class="modal-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeModal('addActivoModal')">Cancelar</button>
                            <button type="submit" class="btn btn-success">Guardar</button>
                        </div>
                    </form>
                </div>
            </div>
            <div id="activoDetailModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title" id="activoDetailNombre"></h2>
                        <button class="close-modal" onclick="closeModal('activoDetailModal')">√ó</button>
                    </div>
                    <div style="padding: 1.5rem;">
                        <div class="info-grid">
                            <div class="info-item"><div class="info-label">√öltimo Mantenimiento</div><div class="info-value" id="detailUltimoMant"></div></div>
                            <div class="info-item"><div class="info-label">Pr√≥ximo Mantenimiento</div><div class="info-value" id="detailProximoMant"></div></div>
                            <div class="info-item"><div class="info-label">Proveedor</div><div class="info-value" id="detailActivoProveedor"></div></div>
                        </div>
                        <div class="info-item" style="margin-top: 1rem;"><div class="info-label">Notas</div><div class="info-value" id="detailActivoNotas"></div></div>
                        <h3 style="margin: 1.5rem 0 1rem 0;">Fotos</h3>
                        <div id="photoGallery" class="photo-gallery"></div>
                        <div class="modal-actions" style="margin-top: 1.5rem;">
                            <button class="btn btn-primary" onclick="editActivo()">Editar</button>
                            <button class="btn btn-danger" onclick="deleteActivo()">Eliminar</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        const SUPABASE_URL = 'https://tzuvoceilkqurnujrraq.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR6dXZvY2VpbGtxdXJudWpycmFxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1Mjg3NDIsImV4cCI6MjA4NTEwNDc0Mn0.2bGNuh7nVhAFGULlXBT85wsKUMgJJbEEGtUq0jerqno';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let currentUser = '';
        let inquilinos = [];
        let proveedores = [];
        let activos = [];
        let currentInquilinoId = null;
        let currentProveedorId = null;
        let currentActivoId = null;
        let currentFacturaId = null;
        let isEditMode = false;
        let currentContratoFile = null;
        let currentFacturaDocFile = null;
        let currentPagoFacturaFile = null;
        let currentActivoFotos = [];
        let currentPageContext = 'home';
        let currentHomeTable = null;
        let currentDocAdicionalFile = null;
        let currentProvDocAdicionalFile = null;

        function showLoading() { document.getElementById('loadingOverlay').classList.remove('hidden'); }
        function hideLoading() { document.getElementById('loadingOverlay').classList.add('hidden'); }

        function login(username) {
            if (!username) return;
            currentUser = username;
            document.getElementById('loginContainer').classList.add('hidden');
            document.getElementById('appContainer').classList.add('active');
            setTimeout(() => loadAllData(), 100);
        }

        function logout() {
            if (!confirm('¬øCerrar sesi√≥n?')) return;
            currentUser = '';
            document.getElementById('username').value = '';
            document.getElementById('loginContainer').classList.remove('hidden');
            document.getElementById('appContainer').classList.remove('active');
        }

        function toggleMainMenu() {
            const dropdown = document.getElementById('mainMenuDropdown');
            dropdown.classList.toggle('show');
        }

        function showPageFromMenu(pageName) {
            currentPageContext = pageName;
            document.getElementById('mainMenuDropdown').classList.remove('show');
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageName + 'Page').classList.add('active');
            
            const titleMap = {
                'home': 'ESWU',
                'inquilinos': 'ESWU - Inquilinos',
                'proveedores': 'ESWU - Proveedores',
                'activos': 'ESWU - Activos',
                'chat': 'ESWU - Chat'
            };
            document.getElementById('headerTitle').textContent = titleMap[pageName];
            
            if (pageName === 'home') updateHomeView();
            if (pageName === 'inquilinos') showInquilinosView('list');
            if (pageName === 'proveedores') showProveedoresView('list');
            if (pageName === 'activos') renderActivosTable();
            updateMainMenuForPage();
        }

        function updateMainMenuForPage() {
            const mainMenu = document.getElementById('mainMenuDropdown');
            mainMenu.innerHTML = '';
            
            if (currentPageContext === 'inquilinos') {
                const links = [
                    { text: 'Listado Inquilinos', action: () => showInquilinosView('list') },
                    { text: 'Agregar Inquilino', action: () => showAddInquilinoModal() },
                    { text: 'Rentas Recibidas', action: () => showInquilinosView('rentasRecibidas') },
                    { text: 'Vencimiento Contratos', action: () => showInquilinosView('vencimientoContratos') }
                ];
                links.forEach(link => {
                    const a = document.createElement('a');
                    a.href = '#';
                    a.textContent = link.text;
                    a.onclick = (e) => { e.preventDefault(); document.getElementById('mainMenuDropdown').classList.remove('show'); link.action(); };
                    mainMenu.appendChild(a);
                });
            } else if (currentPageContext === 'proveedores') {
                const links = [
                    { text: 'Listado Proveedores', action: () => showProveedoresView('list') },
                    { text: 'Agregar Proveedor', action: () => showAddProveedorModal() },
                    { text: 'Facturas Pagadas', action: () => showProveedoresView('facturasPagadas') },
                    { text: 'Facturas Por Pagar', action: () => showProveedoresView('facturasPorPagar') }
                ];
                links.forEach(link => {
                    const a = document.createElement('a');
                    a.href = '#';
                    a.textContent = link.text;
                    a.onclick = (e) => { e.preventDefault(); document.getElementById('mainMenuDropdown').classList.remove('show'); link.action(); };
                    mainMenu.appendChild(a);
                });
            } else if (currentPageContext === 'activos') {
                const a = document.createElement('a');
                a.href = '#';
                a.textContent = 'Agregar Activo';
                a.onclick = (e) => { e.preventDefault(); document.getElementById('mainMenuDropdown').classList.remove('show'); showAddActivoModal(); };
                mainMenu.appendChild(a);
            } else if (currentPageContext === 'chat') {
                // Sin opciones adicionales para chat
            } else {
                const pages = [
                    { id: 'inquilinos', name: 'Inquilinos' },
                    { id: 'proveedores', name: 'Proveedores' },
                    { id: 'activos', name: 'Activos' },
                    { id: 'chat', name: 'Chat' }
                ];
                pages.forEach(page => {
                    const a = document.createElement('a');
                    a.href = '#';
                    a.textContent = page.name;
                    a.onclick = (e) => { e.preventDefault(); showPageFromMenu(page.id); };
                    mainMenu.appendChild(a);
                });
            }
            
            const logoutLink = document.createElement('a');
            logoutLink.href = '#';
            logoutLink.textContent = 'Salir';
            logoutLink.onclick = (e) => { e.preventDefault(); logout(); };
            mainMenu.appendChild(logoutLink);
        }

        async function loadAllData() {
            showLoading();
            try {
                await Promise.all([loadInquilinos(), loadProveedores(), loadActivos()]);
                populateYearSelect();
                populateInquilinosYearSelects();
                updateHomeView();
                console.log('‚úÖ Datos cargados');
            } catch (error) {
                console.error('Error:', error);
            } finally {
                hideLoading();
            }
        }

        async function loadInquilinos() {
            try {
                const { data, error } = await supabaseClient.from('inquilinos').select('*, pagos_inquilinos(*), inquilinos_documentos(*)').order('nombre');
                if (error) throw error;
                inquilinos = data.map(inq => ({
                    id: inq.id, nombre: inq.nombre, contacto: inq.contacto, telefono: inq.telefono,
                    email: inq.email, clabe: inq.clabe, rfc: inq.rfc, m2: inq.m2,
                    renta: parseFloat(inq.renta || 0), fechaInicio: inq.fecha_inicio,
                    fechaVencimiento: inq.fecha_vencimiento, notas: inq.notas,
                    contratoFile: inq.contrato_file, contratoFileName: inq.contrato_filename,
                    pagos: inq.pagos_inquilinos ? inq.pagos_inquilinos.map(p => ({
                        id: p.id, fecha: p.fecha, monto: parseFloat(p.monto),
                        completo: p.completo, pagoFile: p.pago_file, pagoFileName: p.pago_filename
                    })).sort((a, b) => new Date(b.fecha) - new Date(a.fecha)) : [],
                    documentos: inq.inquilinos_documentos ? inq.inquilinos_documentos.map(d => ({
                        id: d.id, nombre: d.nombre_documento, archivo: d.archivo_pdf, 
                        fecha: d.fecha_guardado, usuario: d.usuario_guardo
                    })).sort((a, b) => new Date(b.fecha) - new Date(a.fecha)) : []
                }));
            } catch (error) { console.error('Error loading inquilinos:', error); throw error; }
        }

        async function loadProveedores() {
            try {
                const { data, error } = await supabaseClient.from('proveedores').select('*, facturas(*), proveedores_documentos(*)').order('nombre');
                if (error) throw error;
                proveedores = data.map(prov => ({
                    id: prov.id, nombre: prov.nombre, servicio: prov.servicio, contacto: prov.contacto,
                    telefono: prov.telefono, email: prov.email, clabe: prov.clabe, rfc: prov.rfc, notas: prov.notas,
                    facturas: prov.facturas ? prov.facturas.map(f => ({
                        id: f.id, numero: f.numero, fecha: f.fecha, vencimiento: f.vencimiento,
                        monto: parseFloat(f.monto), iva: parseFloat(f.iva || 0), fechaPago: f.fecha_pago,
                        documentoFile: f.documento_file, documentoFileName: f.documento_filename,
                        pagoFile: f.pago_file, pagoFileName: f.pago_filename
                    })).sort((a, b) => new Date(b.fecha) - new Date(a.fecha)) : [],
                    documentos: prov.proveedores_documentos ? prov.proveedores_documentos.map(d => ({
                        id: d.id, nombre: d.nombre_documento, archivo: d.archivo_pdf,
                        fecha: d.fecha_guardado, usuario: d.usuario_guardo
                    })).sort((a, b) => new Date(b.fecha) - new Date(a.fecha)) : []
                }));
            } catch (error) { console.error('Error loading proveedores:', error); throw error; }
        }

        async function loadActivos() {
            try {
                const { data, error } = await supabaseClient.from('activos').select('*, activos_fotos(*)').order('nombre');
                if (error) throw error;
                activos = data.map(act => ({
                    id: act.id, nombre: act.nombre, ultimoMant: act.ultimo_mant,
                    proximoMant: act.proximo_mant, proveedor: act.proveedor, notas: act.notas,
                    fotos: act.activos_fotos ? act.activos_fotos.map(f => ({ id: f.id, data: f.foto_data, name: f.foto_name })) : []
                }));
            } catch (error) { console.error('Error loading activos:', error); throw error; }
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(amount);
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString + 'T00:00:00');
            const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
            return `${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear()}`;
        }

        function formatDateVencimiento(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString + 'T00:00:00');
            const today = new Date(); today.setHours(0, 0, 0, 0);
            const diffDays = Math.ceil((date - today) / (1000 * 60 * 60 * 24));
            const formatted = formatDate(dateString);
            if (diffDays <= 7 && diffDays >= 0) {
                return `<span class="vencimiento-proximo">${formatted}</span>`;
            }
            return formatted;
        }

        function populateYearSelect() {
            const currentYear = new Date().getFullYear();
            const yearSelect = document.getElementById('homeYear');
            yearSelect.innerHTML = '';
            for (let year = currentYear - 5; year <= currentYear + 1; year++) {
                const option = document.createElement('option');
                option.value = year; option.textContent = year;
                if (year === currentYear) option.selected = true;
                yearSelect.appendChild(option);
            }
        }

        function populateInquilinosYearSelects() {
            const currentYear = new Date().getFullYear();
            const select = document.getElementById('inquilinosRentasYear');
            select.innerHTML = '';
            for (let year = currentYear - 5; year <= currentYear + 1; year++) {
                const option = document.createElement('option');
                option.value = year; option.textContent = year;
                if (year === currentYear) option.selected = true;
                select.appendChild(option);
            }
        }

        function toggleHomeTable(tableName) {
            const ingresosContainer = document.getElementById('homeIngresosContainer');
            const pagosContainer = document.getElementById('homePagosContainer');
            
            if (currentHomeTable === tableName) {
                ingresosContainer.classList.add('hidden');
                pagosContainer.classList.add('hidden');
                currentHomeTable = null;
            } else {
                if (tableName === 'ingresos') {
                    ingresosContainer.classList.remove('hidden');
                    pagosContainer.classList.add('hidden');
                    renderHomeIngresos();
                } else if (tableName === 'pagos') {
                    ingresosContainer.classList.add('hidden');
                    pagosContainer.classList.remove('hidden');
                    renderHomePagosDetalle();
                }
                currentHomeTable = tableName;
            }
        }

        function updateHomeView() {
            const filterType = document.getElementById('homeFilter').value;
            const year = parseInt(document.getElementById('homeYear').value);
            const monthSelect = document.getElementById('homeMonth');
            
            if (filterType === 'mensual') monthSelect.classList.remove('hidden');
            else monthSelect.classList.add('hidden');
            
            const month = filterType === 'mensual' ? parseInt(monthSelect.value) : null;
            let totalIngresos = 0, totalGastos = 0;
            
            inquilinos.forEach(inq => {
                if (inq.pagos) {
                    inq.pagos.forEach(pago => {
                        const pd = new Date(pago.fecha + 'T00:00:00');
                        if (pd.getFullYear() === year && (month === null || pd.getMonth() === month)) totalIngresos += pago.monto;
                    });
                }
            });
            
            proveedores.forEach(prov => {
                if (prov.facturas) {
                    prov.facturas.forEach(fact => {
                        if (fact.fechaPago) {
                            const pd = new Date(fact.fechaPago + 'T00:00:00');
                            if (pd.getFullYear() === year && (month === null || pd.getMonth() === month)) totalGastos += fact.monto;
                        }
                    });
                }
            });
            
            document.getElementById('summaryIngresos').textContent = formatCurrency(totalIngresos);
            document.getElementById('summaryGastos').textContent = formatCurrency(totalGastos);
            document.getElementById('summaryNeto').textContent = formatCurrency(totalIngresos - totalGastos);
            
            if (currentHomeTable === 'ingresos') {
                renderHomeIngresos();
            } else if (currentHomeTable === 'pagos') {
                renderHomePagosDetalle();
            }
        }

        function renderHomeIngresos() {
            const filterType = document.getElementById('homeFilter').value;
            const year = parseInt(document.getElementById('homeYear').value);
            const month = filterType === 'mensual' ? parseInt(document.getElementById('homeMonth').value) : null;
            
            const tbody = document.getElementById('homeIngresosTable').querySelector('tbody');
            tbody.innerHTML = '';
            const pagos = [];
            let total = 0;
            
            inquilinos.forEach(inq => {
                if (inq.pagos) {
                    inq.pagos.forEach(pago => {
                        const pd = new Date(pago.fecha + 'T00:00:00');
                        if (pd.getFullYear() === year && (month === null || pd.getMonth() === month)) {
                            pagos.push({ inquilino: inq.nombre, fecha: pago.fecha, monto: pago.monto });
                            total += pago.monto;
                        }
                    });
                }
            });
            
            pagos.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            pagos.forEach(p => {
                const row = tbody.insertRow();
                row.innerHTML = `<td>${p.inquilino}</td><td>${formatDate(p.fecha)}</td><td class="currency">${formatCurrency(p.monto)}</td>`;
            });
            
            if (pagos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:var(--text-light)">No hay ingresos</td></tr>';
            } else {
                const row = tbody.insertRow();
                row.style.fontWeight = 'bold'; row.style.backgroundColor = '#d4edda';
                row.innerHTML = `<td colspan="2" style="text-align:right;padding:1rem">TOTAL:</td><td class="currency" style="color:var(--success);font-size:1.1rem">${formatCurrency(total)}</td>`;
            }
        }

        function renderHomePagosDetalle() {
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth();
            const currentYear = currentDate.getFullYear();
            
            const tbodyPorPagar = document.getElementById('homeFacturasPorPagarTable').querySelector('tbody');
            const tbodyPagadas = document.getElementById('homeFacturasPagadasTable').querySelector('tbody');
            tbodyPorPagar.innerHTML = '';
            tbodyPagadas.innerHTML = '';
            
            const porPagar = [];
            const pagadas = [];
            let totalPorPagar = 0;
            let totalPagadas = 0;
            
            proveedores.forEach(prov => {
                if (prov.facturas) {
                    prov.facturas.forEach(f => {
                        if (!f.fechaPago) {
                            porPagar.push({ proveedor: prov.nombre, monto: f.monto, vencimiento: f.vencimiento });
                            totalPorPagar += f.monto;
                        } else {
                            const pd = new Date(f.fechaPago + 'T00:00:00');
                            if (pd.getMonth() === currentMonth && pd.getFullYear() === currentYear) {
                                pagadas.push({ proveedor: prov.nombre, monto: f.monto, fecha: f.fechaPago });
                                totalPagadas += f.monto;
                            }
                        }
                    });
                }
            });
            
            porPagar.sort((a, b) => new Date(a.vencimiento) - new Date(b.vencimiento));
            const isMobile = window.innerWidth <= 768;
            porPagar.forEach(f => {
                const row = tbodyPorPagar.insertRow();
                const proveedorText = isMobile && f.proveedor.length > 22 ? f.proveedor.substring(0, 22) + '...' : f.proveedor;
                row.innerHTML = `<td class="proveedor-truncate">${proveedorText}</td><td class="currency">${formatCurrency(f.monto)}</td><td>${formatDateVencimiento(f.vencimiento)}</td>`;
            });
            if (porPagar.length === 0) {
                tbodyPorPagar.innerHTML = '<tr><td colspan="3" style="text-align:center;color:var(--text-light)">No hay facturas por pagar</td></tr>';
            } else {
                const row = tbodyPorPagar.insertRow();
                row.className = 'total-row';
                row.innerHTML = `<td style="text-align:right;padding:1rem"><strong>TOTAL:</strong></td><td class="currency"><strong>${formatCurrency(totalPorPagar)}</strong></td><td></td>`;
            }
            
            pagadas.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            pagadas.forEach(f => {
                const row = tbodyPagadas.insertRow();
                const proveedorText = isMobile && f.proveedor.length > 22 ? f.proveedor.substring(0, 22) + '...' : f.proveedor;
                row.innerHTML = `<td class="proveedor-truncate">${proveedorText}</td><td class="currency">${formatCurrency(f.monto)}</td><td>${formatDate(f.fecha)}</td>`;
            });
            if (pagadas.length === 0) {
                tbodyPagadas.innerHTML = '<tr><td colspan="3" style="text-align:center;color:var(--text-light)">No hay facturas pagadas este mes</td></tr>';
            } else {
                const row = tbodyPagadas.insertRow();
                row.className = 'total-row';
                row.innerHTML = `<td style="text-align:right;padding:1rem"><strong>TOTAL:</strong></td><td class="currency"><strong>${formatCurrency(totalPagadas)}</strong></td><td></td>`;
            }
        }

        function toggleDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            document.querySelectorAll('.dropdown-content').forEach(dd => {
                if (dd.id !== dropdownId) dd.classList.remove('show');
            });
            dropdown.classList.toggle('show');
        }

        window.onclick = function(event) {
            if (!event.target.matches('.dropdown-toggle')) {
                document.querySelectorAll('.dropdown-content').forEach(dd => dd.classList.remove('show'));
                document.querySelectorAll('.main-menu-content').forEach(dd => dd.classList.remove('show'));
            }
        }

        function showInquilinosView(view) {
            document.getElementById('inquilinosListView').classList.add('hidden');
            document.getElementById('inquilinosRentasRecibidasView').classList.add('hidden');
            document.getElementById('inquilinosVencimientoContratosView').classList.add('hidden');
            
            const titulo = document.getElementById('inquilinosTitulo');
            if (view === 'list') {
                titulo.textContent = 'Inquilinos - Listado';
                document.getElementById('inquilinosListView').classList.remove('hidden');
                renderInquilinosTable();
            } else if (view === 'rentasRecibidas') {
                titulo.textContent = 'Inquilinos - Rentas Recibidas';
                document.getElementById('inquilinosRentasRecibidasView').classList.remove('hidden');
                renderInquilinosRentasRecibidas();
            } else if (view === 'vencimientoContratos') {
                titulo.textContent = 'Inquilinos - Vencimiento Contratos';
                document.getElementById('inquilinosVencimientoContratosView').classList.remove('hidden');
                renderInquilinosVencimientoContratos();
            }
        }

        function renderInquilinosTable() {
            const tbody = document.getElementById('inquilinosTable').querySelector('tbody');
            tbody.innerHTML = '';
            inquilinos.forEach(inq => {
                const row = tbody.insertRow();
                row.style.cursor = 'pointer';
                row.onclick = () => showInquilinoDetail(inq.id);
                const contratoBtn = inq.contratoFile ? `<button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); viewContratoDirect(${inq.id})">PDF</button>` : '-';
                row.innerHTML = `<td>${inq.nombre}</td><td class="currency">${formatCurrency(inq.renta)}</td><td>${formatDateVencimiento(inq.fechaVencimiento)}</td><td>${contratoBtn}</td>`;
            });
            if (inquilinos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--text-light)">No hay inquilinos</td></tr>';
            }
        }

        function renderInquilinosRentasRecibidas() {
            const tbody = document.getElementById('inquilinosRentasRecibidasTable').querySelector('tbody');
            tbody.innerHTML = '';
            const filterType = document.getElementById('inquilinosRentasFilter').value;
            const year = parseInt(document.getElementById('inquilinosRentasYear').value);
            const monthSelect = document.getElementById('inquilinosRentasMonth');
            
            if (filterType === 'mensual') monthSelect.classList.remove('hidden');
            else monthSelect.classList.add('hidden');
            
            const month = filterType === 'mensual' ? parseInt(monthSelect.value) : null;
            const rentas = [];
            let totalPeriodo = 0;
            
            inquilinos.forEach(inq => {
                if (inq.pagos) {
                    inq.pagos.forEach(pago => {
                        const pd = new Date(pago.fecha + 'T00:00:00');
                        if (pd.getFullYear() === year && (month === null || pd.getMonth() === month)) {
                            rentas.push({ empresa: inq.nombre, monto: pago.monto, fecha: pago.fecha });
                            totalPeriodo += pago.monto;
                        }
                    });
                }
            });
            
            rentas.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            rentas.forEach(r => {
                const row = tbody.insertRow();
                row.innerHTML = `<td>${r.empresa}</td><td class="currency">${formatCurrency(r.monto)}</td><td>${formatDate(r.fecha)}</td>`;
            });
            
            if (rentas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:var(--text-light)">No hay rentas</td></tr>';
            } else {
                const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                if (filterType === 'mensual') {
                    const row = tbody.insertRow();
                    row.style.fontWeight = 'bold'; row.style.backgroundColor = '#e6f2ff';
                    row.innerHTML = `<td style="text-align:right;padding:1rem;font-size:1.1rem">TOTAL ${monthNames[month].toUpperCase()} ${year}:</td><td class="currency" style="color:var(--primary);font-size:1.2rem">${formatCurrency(totalPeriodo)}</td><td></td>`;
                }
                let totalAnual = 0;
                inquilinos.forEach(inq => {
                    if (inq.pagos) {
                        inq.pagos.forEach(pago => {
                            const pd = new Date(pago.fecha + 'T00:00:00');
                            if (pd.getFullYear() === year) totalAnual += pago.monto;
                        });
                    }
                });
                const rowAnual = tbody.insertRow();
                rowAnual.style.fontWeight = 'bold'; rowAnual.style.backgroundColor = '#d4edda';
                rowAnual.innerHTML = `<td style="text-align:right;padding:1rem;font-size:1.1rem">TOTAL ${year}:</td><td class="currency" style="color:var(--success);font-size:1.2rem">${formatCurrency(totalAnual)}</td><td></td>`;
            }
        }

        function renderInquilinosVencimientoContratos() {
            const tbody = document.getElementById('inquilinosVencimientoContratosTable').querySelector('tbody');
            tbody.innerHTML = '';
            const today = new Date(); today.setHours(0, 0, 0, 0);
            
            inquilinos.forEach(inq => {
                const venc = new Date(inq.fechaVencimiento + 'T00:00:00');
                const diffDays = Math.ceil((venc - today) / (1000 * 60 * 60 * 24));
                let estado = '', badgeClass = '';
                if (diffDays < 0) { estado = 'Vencido'; badgeClass = 'badge-danger'; }
                else if (diffDays <= 30) { estado = 'Pr√≥ximo a vencer'; badgeClass = 'badge-warning'; }
                else { estado = 'Vigente'; badgeClass = 'badge-success'; }
                
                const row = tbody.insertRow();
                row.innerHTML = `<td>${inq.nombre}</td><td>${formatDate(inq.fechaInicio)}</td><td>${formatDateVencimiento(inq.fechaVencimiento)}</td><td>${diffDays}</td><td><span class="badge ${badgeClass}">${estado}</span></td>`;
            });
            
            if (inquilinos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--text-light)">No hay contratos</td></tr>';
            }
        }

        function showAddInquilinoModal() {
            isEditMode = false; currentInquilinoId = null; currentContratoFile = null; currentDocAdicionalFile = null;
            document.getElementById('addInquilinoTitle').textContent = 'Agregar Inquilino';
            document.getElementById('inquilinoForm').reset();
            document.getElementById('contratoFileName').textContent = '';
            document.getElementById('docAdicionalFileName').textContent = '';
            document.getElementById('nombreDocGroup').classList.add('hidden');
            document.getElementById('addInquilinoModal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        async function saveInquilino(event) {
            event.preventDefault();
            showLoading();
            try {
                let contratoData = currentContratoFile;
                let contratoName = null;
                const contratoInput = document.getElementById('inquilinoContrato');
                if (contratoInput.files.length > 0) {
                    contratoData = await fileToBase64(contratoInput.files[0]);
                    contratoName = contratoInput.files[0].name;
                }
                
                const inquilinoData = {
                    nombre: document.getElementById('inquilinoNombre').value,
                    contacto: document.getElementById('inquilinoContacto').value,
                    telefono: document.getElementById('inquilinoTelefono').value,
                    email: document.getElementById('inquilinoEmail').value,
                    clabe: document.getElementById('inquilinoClabe').value,
                    rfc: document.getElementById('inquilinoRFC').value,
                    m2: document.getElementById('inquilinoM2').value,
                    renta: parseFloat(document.getElementById('inquilinoRenta').value),
                    fecha_inicio: document.getElementById('inquilinoFechaInicio').value,
                    fecha_vencimiento: document.getElementById('inquilinoFechaVenc').value,
                    notas: document.getElementById('inquilinoNotas').value,
                    contrato_file: contratoData,
                    contrato_filename: contratoName
                };
                
                let inquilinoId = currentInquilinoId;
                if (isEditMode) {
                    const { error } = await supabaseClient.from('inquilinos').update(inquilinoData).eq('id', currentInquilinoId);
                    if (error) throw error;
                } else {
                    const { data, error } = await supabaseClient.from('inquilinos').insert([inquilinoData]).select().single();
                    if (error) throw error;
                    inquilinoId = data.id;
                }
                
                const docAdicionalInput = document.getElementById('inquilinoDocAdicional');
                if (docAdicionalInput.files.length > 0) {
                    const nombreDoc = document.getElementById('inquilinoNombreDoc').value;
                    if (!nombreDoc) {
                        alert('Por favor ingrese un nombre para el documento');
                        hideLoading();
                        return;
                    }
                    const docData = await fileToBase64(docAdicionalInput.files[0]);
                    const { error } = await supabaseClient.from('inquilinos_documentos').insert([{
                        inquilino_id: inquilinoId,
                        nombre_documento: nombreDoc,
                        archivo_pdf: docData,
                        usuario_guardo: currentUser,
                        fecha_guardado: new Date().toISOString().split('T')[0]
                    }]);
                    if (error) throw error;
                }
                
                await loadInquilinos();
                renderInquilinosTable();
                closeModal('addInquilinoModal');
                isEditMode = false; currentInquilinoId = null; currentContratoFile = null; currentDocAdicionalFile = null;
            } catch (error) {
                console.error('Error:', error);
                alert('Error al guardar: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function showInquilinoDetail(id) {
            const inq = inquilinos.find(i => i.id === id);
            currentInquilinoId = id;
            document.getElementById('inquilinoDetailNombre').textContent = inq.nombre;
            document.getElementById('detailContacto').textContent = inq.contacto || '-';
            document.getElementById('detailTelefono').textContent = inq.telefono || '-';
            document.getElementById('detailEmail').textContent = inq.email || '-';
            document.getElementById('detailClabe').textContent = inq.clabe || '-';
            document.getElementById('detailRFC').textContent = inq.rfc || '-';
            document.getElementById('detailM2').textContent = inq.m2 || '-';
            document.getElementById('detailRenta').textContent = formatCurrency(inq.renta);
            document.getElementById('detailFechaInicio').textContent = formatDate(inq.fechaInicio);
            document.getElementById('detailFechaVenc').innerHTML = formatDateVencimiento(inq.fechaVencimiento);
            
            if (inq.contratoFile) {
                document.getElementById('contratoSection').classList.remove('hidden');
            } else {
                document.getElementById('contratoSection').classList.add('hidden');
            }
            
            const historialDiv = document.getElementById('historialPagos');
            if (inq.pagos && inq.pagos.length > 0) {
                historialDiv.innerHTML = inq.pagos.map(p => `
                    <div class="payment-item">
                        <div><strong>${formatDate(p.fecha)}</strong><br>${formatCurrency(p.monto)}</div>
                        <div><span class="badge badge-success">Pagado</span><br><small style="color:var(--text-light)">${formatDate(p.fecha)}</small></div>
                    </div>
                `).join('');
            } else {
                historialDiv.innerHTML = '<p style="color:var(--text-light);text-align:center;padding:2rem">No hay pagos</p>';
            }
            
            const docsDiv = document.getElementById('documentosAdicionales');
            if (inq.documentos && inq.documentos.length > 0) {
                docsDiv.innerHTML = '<table style="width:100%"><thead><tr><th>Nombre</th><th>Fecha</th><th>Usuario</th></tr></thead><tbody>' +
                    inq.documentos.map(d => `
                        <tr class="doc-item" onclick="viewDocumento('${d.archivo}')">
                            <td>${d.nombre}</td>
                            <td>${formatDate(d.fecha)}</td>
                            <td>${d.usuario}</td>
                        </tr>
                    `).join('') + '</tbody></table>';
            } else {
                docsDiv.innerHTML = '<p style="color:var(--text-light);text-align:center;padding:2rem">No hay documentos adicionales</p>';
            }
            
            document.getElementById('inquilinoDetailModal').classList.add('active');
        }

        function viewContrato() {
            const inq = inquilinos.find(i => i.id === currentInquilinoId);
            if (inq.contratoFile) {
                const newWindow = window.open();
                newWindow.document.write(`<iframe width='100%' height='100%' src='${inq.contratoFile}'></iframe>`);
            }
        }

        function viewContratoDirect(id) {
            const inq = inquilinos.find(i => i.id === id);
            if (inq.contratoFile) {
                const newWindow = window.open();
                newWindow.document.write(`<iframe width='100%' height='100%' src='${inq.contratoFile}'></iframe>`);
            }
        }

        function viewDocumento(archivo) {
            if (archivo) {
                const newWindow = window.open();
                newWindow.document.write(`<iframe width='100%' height='100%' src='${archivo}'></iframe>`);
            }
        }

        function editInquilino() {
            const inq = inquilinos.find(i => i.id === currentInquilinoId);
            isEditMode = true;
            currentContratoFile = inq.contratoFile;
            document.getElementById('addInquilinoTitle').textContent = 'Editar Inquilino';
            document.getElementById('inquilinoNombre').value = inq.nombre;
            document.getElementById('inquilinoContacto').value = inq.contacto || '';
            document.getElementById('inquilinoTelefono').value = inq.telefono || '';
            document.getElementById('inquilinoEmail').value = inq.email || '';
            document.getElementById('inquilinoClabe').value = inq.clabe || '';
            document.getElementById('inquilinoRFC').value = inq.rfc || '';
            document.getElementById('inquilinoM2').value = inq.m2 || '';
            document.getElementById('inquilinoRenta').value = inq.renta;
            document.getElementById('inquilinoFechaInicio').value = inq.fechaInicio;
            document.getElementById('inquilinoFechaVenc').value = inq.fechaVencimiento;
            document.getElementById('inquilinoNotas').value = inq.notas || '';
            if (inq.contratoFileName) {
                document.getElementById('contratoFileName').textContent = inq.contratoFileName;
            }
            closeModal('inquilinoDetailModal');
            document.getElementById('addInquilinoModal').classList.add('active');
        }

        async function deleteInquilino() {
            if (!confirm('¬øEliminar este inquilino?')) return;
            showLoading();
            try {
                const { error } = await supabaseClient.from('inquilinos').delete().eq('id', currentInquilinoId);
                if (error) throw error;
                await loadInquilinos();
                renderInquilinosTable();
                closeModal('inquilinoDetailModal');
            } catch (error) {
                console.error('Error:', error);
            } finally {
                hideLoading();
            }
        }

        function showRegistrarPagoModal() {
            const inq = inquilinos.find(i => i.id === currentInquilinoId);
            document.getElementById('pagoMonto').value = inq.renta;
            document.getElementById('pagoFecha').value = new Date().toISOString().split('T')[0];
            document.getElementById('pagoCompleto').value = 'si';
            document.getElementById('pagoMontoGroup').classList.add('hidden');
            document.getElementById('registrarPagoModal').classList.add('active');
        }

        function toggleMontoInput() {
            const completo = document.getElementById('pagoCompleto').value;
            const montoGroup = document.getElementById('pagoMontoGroup');
            if (completo === 'no') {
                montoGroup.classList.remove('hidden');
                document.getElementById('pagoMonto').required = true;
            } else {
                montoGroup.classList.add('hidden');
                document.getElementById('pagoMonto').required = false;
            }
        }

        async function savePagoRenta(event) {
            event.preventDefault();
            showLoading();
            try {
                const inq = inquilinos.find(i => i.id === currentInquilinoId);
                const completo = document.getElementById('pagoCompleto').value === 'si';
                const monto = completo ? inq.renta : parseFloat(document.getElementById('pagoMonto').value);
                
                const { error } = await supabaseClient.from('pagos_inquilinos').insert([{
                    inquilino_id: currentInquilinoId,
                    fecha: document.getElementById('pagoFecha').value,
                    monto: monto,
                    completo: completo
                }]);
                if (error) throw error;
                await loadInquilinos();
                showInquilinoDetail(currentInquilinoId);
                closeModal('registrarPagoModal');
            } catch (error) {
                console.error('Error:', error);
            } finally {
                hideLoading();
            }
        }

        function showProveedoresView(view) {
            document.getElementById('proveedoresListView').classList.add('hidden');
            document.getElementById('proveedoresFacturasPagadasView').classList.add('hidden');
            document.getElementById('proveedoresFacturasPorPagarView').classList.add('hidden');
            
            const titulo = document.getElementById('proveedoresTitulo');
            if (view === 'list') {
                titulo.textContent = 'Proveedores - Listado';
                document.getElementById('proveedoresListView').classList.remove('hidden');
                renderProveedoresTable();
            } else if (view === 'facturasPagadas') {
                titulo.textContent = 'Proveedores - Facturas Pagadas';
                document.getElementById('proveedoresFacturasPagadasView').classList.remove('hidden');
                renderProveedoresFacturasPagadas();
            } else if (view === 'facturasPorPagar') {
                titulo.textContent = 'Proveedores - Facturas Por Pagar';
                document.getElementById('proveedoresFacturasPorPagarView').classList.remove('hidden');
                renderProveedoresFacturasPorPagar();
            }
        }

        function renderProveedoresTable() {
            const tbody = document.getElementById('proveedoresTable').querySelector('tbody');
            tbody.innerHTML = '';
            proveedores.forEach(prov => {
                const row = tbody.insertRow();
                row.style.cursor = 'pointer';
                row.onclick = () => showProveedorDetail(prov.id);
                row.innerHTML = `<td>${prov.nombre}</td><td>${prov.servicio}</td><td>${prov.contacto}</td>`;
            });
            if (proveedores.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:var(--text-light)">No hay proveedores</td></tr>';
            }
        }

        function renderProveedoresFacturasPagadas() {
            const tbody = document.getElementById('proveedoresFacturasPagadasTable').querySelector('tbody');
            tbody.innerHTML = '';
            const pagadas = [];
            proveedores.forEach(prov => {
                if (prov.facturas) {
                    prov.facturas.forEach(f => {
                        if (f.fechaPago) {
                            pagadas.push({ proveedor: prov.nombre, numero: f.numero || 'S/N', monto: f.monto, fecha: f.fechaPago });
                        }
                    });
                }
            });
            pagadas.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            pagadas.forEach(f => {
                const row = tbody.insertRow();
                row.innerHTML = `<td>${f.proveedor}</td><td>${f.numero}</td><td class="currency">${formatCurrency(f.monto)}</td><td>${formatDate(f.fecha)}</td>`;
            });
            if (pagadas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--text-light)">No hay facturas pagadas</td></tr>';
            }
        }

        function renderProveedoresFacturasPorPagar() {
            const tbody = document.getElementById('proveedoresFacturasPorPagarTable').querySelector('tbody');
            tbody.innerHTML = '';
            const porPagar = [];
            const today = new Date(); today.setHours(0, 0, 0, 0);
            
            proveedores.forEach(prov => {
                if (prov.facturas) {
                    prov.facturas.forEach(f => {
                        if (!f.fechaPago) {
                            const venc = new Date(f.vencimiento + 'T00:00:00');
                            const diffDays = Math.ceil((venc - today) / (1000 * 60 * 60 * 24));
                            let estado = '', badgeClass = '';
                            if (diffDays < 0) { estado = 'Vencida'; badgeClass = 'badge-danger'; }
                            else if (diffDays <= 7) { estado = 'Pr√≥xima'; badgeClass = 'badge-warning'; }
                            else { estado = 'Vigente'; badgeClass = 'badge-success'; }
                            porPagar.push({ provId: prov.id, factId: f.id, proveedor: prov.nombre, numero: f.numero || 'S/N', monto: f.monto, vencimiento: f.vencimiento, fecha: f.fecha, iva: f.iva, estado, badgeClass });
                        }
                    });
                }
            });
            porPagar.sort((a, b) => new Date(a.vencimiento) - new Date(b.vencimiento));
            porPagar.forEach(f => {
                const row = tbody.insertRow();
                row.style.cursor = 'pointer';
                row.onclick = () => showFacturaDetail(f);
                row.innerHTML = `<td>${f.proveedor}</td><td>${f.numero}</td><td class="currency">${formatCurrency(f.monto)}</td><td>${formatDateVencimiento(f.vencimiento)}</td><td><span class="badge ${f.badgeClass}">${f.estado}</span></td>`;
            });
            if (porPagar.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--text-light)">No hay facturas por pagar</td></tr>';
            }
        }

        function showFacturaDetail(factura) {
            currentProveedorId = factura.provId;
            currentFacturaId = factura.factId;
            document.getElementById('factDetailProveedor').textContent = factura.proveedor;
            document.getElementById('factDetailNumero').textContent = factura.numero;
            document.getElementById('factDetailFecha').textContent = formatDate(factura.fecha);
            document.getElementById('factDetailVencimiento').innerHTML = formatDateVencimiento(factura.vencimiento);
            document.getElementById('factDetailMonto').textContent = formatCurrency(factura.monto);
            document.getElementById('factDetailIVA').textContent = formatCurrency(factura.iva);
            document.getElementById('facturaDetailModal').classList.add('active');
        }

        function showPagarFacturaModalFromDetail() {
            closeModal('facturaDetailModal');
            currentPagoFacturaFile = null;
            document.getElementById('fechaPagoFactura').value = new Date().toISOString().split('T')[0];
            document.getElementById('pagoPDFFacturaFileName').textContent = '';
            document.getElementById('pagarFacturaModal').classList.add('active');
        }

        function showAddProveedorModal() {
            isEditMode = false; currentProveedorId = null; currentProvDocAdicionalFile = null;
            document.getElementById('addProveedorTitle').textContent = 'Agregar Proveedor';
            document.getElementById('proveedorForm').reset();
            document.getElementById('provDocAdicionalFileName').textContent = '';
            document.getElementById('nombreProvDocGroup').classList.add('hidden');
            document.getElementById('addProveedorModal').classList.add('active');
        }

        async function saveProveedor(event) {
            event.preventDefault();
            showLoading();
            try {
                const provData = {
                    nombre: document.getElementById('proveedorNombre').value,
                    servicio: document.getElementById('proveedorServicio').value,
                    contacto: document.getElementById('proveedorContacto').value,
                    telefono: document.getElementById('proveedorTelefono').value,
                    email: document.getElementById('proveedorEmail').value,
                    clabe: document.getElementById('proveedorClabe').value,
                    rfc: document.getElementById('proveedorRFC').value,
                    notas: document.getElementById('proveedorNotas').value
                };
                
                let proveedorId = currentProveedorId;
                if (isEditMode) {
                    const { error } = await supabaseClient.from('proveedores').update(provData).eq('id', currentProveedorId);
                    if (error) throw error;
                } else {
                    const { data, error } = await supabaseClient.from('proveedores').insert([provData]).select().single();
                    if (error) throw error;
                    proveedorId = data.id;
                }
                
                const docAdicionalInput = document.getElementById('proveedorDocAdicional');
                if (docAdicionalInput.files.length > 0) {
                    const nombreDoc = document.getElementById('proveedorNombreDoc').value;
                    if (!nombreDoc) {
                        alert('Por favor ingrese un nombre para el documento');
                        hideLoading();
                        return;
                    }
                    const docData = await fileToBase64(docAdicionalInput.files[0]);
                    const { error } = await supabaseClient.from('proveedores_documentos').insert([{
                        proveedor_id: proveedorId,
                        nombre_documento: nombreDoc,
                        archivo_pdf: docData,
                        usuario_guardo: currentUser,
                        fecha_guardado: new Date().toISOString().split('T')[0]
                    }]);
                    if (error) throw error;
                }
                
                await loadProveedores();
                renderProveedoresTable();
                closeModal('addProveedorModal');
                isEditMode = false; currentProveedorId = null; currentProvDocAdicionalFile = null;
            } catch (error) {
                console.error('Error:', error);
                alert('Error al guardar: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function showProveedorDetail(id) {
            const prov = proveedores.find(p => p.id === id);
            currentProveedorId = id;
            document.getElementById('proveedorDetailNombre').textContent = prov.nombre;
            document.getElementById('detailServicio').textContent = prov.servicio;
            document.getElementById('detailProvContacto').textContent = prov.contacto || '-';
            document.getElementById('detailProvTelefono').textContent = prov.telefono || '-';
            document.getElementById('detailProvEmail').textContent = prov.email || '-';
            document.getElementById('detailProvClabe').textContent = prov.clabe || '-';
            document.getElementById('detailProvRFC').textContent = prov.rfc || '-';
            
            const historialDiv = document.getElementById('historialFacturas');
            if (prov.facturas && prov.facturas.length > 0) {
                historialDiv.innerHTML = prov.facturas.map(f => `
                    <div class="payment-item">
                        <div><strong>${formatDate(f.fecha)}</strong><br>${formatCurrency(f.monto)}<br>Vence: ${formatDateVencimiento(f.vencimiento)}</div>
                        <div>${f.fechaPago ? '<span class="badge badge-success">Pagado</span>' : '<button class="btn btn-sm btn-primary" onclick="showPagarFacturaModal(' + f.id + ')">Dar X Pagada</button>'}</div>
                    </div>
                `).join('');
            } else {
                historialDiv.innerHTML = '<p style="color:var(--text-light);text-align:center;padding:2rem">No hay facturas</p>';
            }
            
            const docsDiv = document.getElementById('proveedorDocumentosAdicionales');
            if (prov.documentos && prov.documentos.length > 0) {
                docsDiv.innerHTML = '<table style="width:100%"><thead><tr><th>Nombre</th><th>Fecha</th><th>Usuario</th></tr></thead><tbody>' +
                    prov.documentos.map(d => `
                        <tr class="doc-item" onclick="viewDocumento('${d.archivo}')">
                            <td>${d.nombre}</td>
                            <td>${formatDate(d.fecha)}</td>
                            <td>${d.usuario}</td>
                        </tr>
                    `).join('') + '</tbody></table>';
            } else {
                docsDiv.innerHTML = '<p style="color:var(--text-light);text-align:center;padding:2rem">No hay documentos adicionales</p>';
            }
            
            document.getElementById('proveedorDetailModal').classList.add('active');
        }

        function editProveedor() {
            const prov = proveedores.find(p => p.id === currentProveedorId);
            isEditMode = true;
            document.getElementById('addProveedorTitle').textContent = 'Editar Proveedor';
            document.getElementById('proveedorNombre').value = prov.nombre;
            document.getElementById('proveedorServicio').value = prov.servicio;
            document.getElementById('proveedorContacto').value = prov.contacto || '';
            document.getElementById('proveedorTelefono').value = prov.telefono || '';
            document.getElementById('proveedorEmail').value = prov.email || '';
            document.getElementById('proveedorClabe').value = prov.clabe || '';
            document.getElementById('proveedorRFC').value = prov.rfc || '';
            document.getElementById('proveedorNotas').value = prov.notas || '';
            closeModal('proveedorDetailModal');
            document.getElementById('addProveedorModal').classList.add('active');
        }

        async function deleteProveedor() {
            if (!confirm('¬øEliminar este proveedor?')) return;
            showLoading();
            try {
                const { error } = await supabaseClient.from('proveedores').delete().eq('id', currentProveedorId);
                if (error) throw error;
                await loadProveedores();
                renderProveedoresTable();
                closeModal('proveedorDetailModal');
            } catch (error) {
                console.error('Error:', error);
            } finally {
                hideLoading();
            }
        }

        function calculateIVA() {
            const monto = parseFloat(document.getElementById('facturaMonto').value);
            if (!isNaN(monto) && monto > 0) {
                const iva = monto * 0.16 / 1.16;
                document.getElementById('facturaIVA').value = iva.toFixed(2);
            }
        }

        function showRegistrarFacturaModal() {
            currentFacturaDocFile = null;
            document.getElementById('facturaNumero').value = '';
            document.getElementById('facturaFecha').value = new Date().toISOString().split('T')[0];
            document.getElementById('facturaVencimiento').value = '';
            document.getElementById('facturaMonto').value = '';
            document.getElementById('facturaIVA').value = '';
            document.getElementById('facturaDocumentoFileName').textContent = '';
            document.getElementById('registrarFacturaModal').classList.add('active');
        }

        async function saveFactura(event) {
            event.preventDefault();
            showLoading();
            try {
                let docData = null, docName = null;
                const docInput = document.getElementById('facturaDocumento');
                if (docInput.files.length > 0) {
                    docData = await fileToBase64(docInput.files[0]);
                    docName = docInput.files[0].name;
                }
                
                const facturaData = {
                    proveedor_id: currentProveedorId,
                    numero: document.getElementById('facturaNumero').value,
                    fecha: document.getElementById('facturaFecha').value,
                    vencimiento: document.getElementById('facturaVencimiento').value,
                    monto: parseFloat(document.getElementById('facturaMonto').value),
                    iva: parseFloat(document.getElementById('facturaIVA').value || 0),
                    documento_file: docData,
                    documento_filename: docName
                };
                
                const { error } = await supabaseClient.from('facturas').insert([facturaData]);
                if (error) throw error;
                
                await loadProveedores();
                showProveedorDetail(currentProveedorId);
                closeModal('registrarFacturaModal');
            } catch (error) {
                console.error('Error:', error);
                alert('Error al guardar factura: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function showPagarFacturaModal(facturaId) {
            currentFacturaId = facturaId;
            currentPagoFacturaFile = null;
            document.getElementById('fechaPagoFactura').value = new Date().toISOString().split('T')[0];
            document.getElementById('pagoPDFFacturaFileName').textContent = '';
            document.getElementById('pagarFacturaModal').classList.add('active');
        }

        async function savePagoFactura(event) {
            event.preventDefault();
            showLoading();
            try {
                let pagoData = null, pagoName = null;
                const pagoInput = document.getElementById('pagoPDFFactura');
                if (pagoInput.files.length > 0) {
                    pagoData = await fileToBase64(pagoInput.files[0]);
                    pagoName = pagoInput.files[0].name;
                }
                
                const { error } = await supabaseClient.from('facturas').update({
                    fecha_pago: document.getElementById('fechaPagoFactura').value,
                    pago_file: pagoData,
                    pago_filename: pagoName
                }).eq('id', currentFacturaId);
                if (error) throw error;
                await loadProveedores();
                if (currentProveedorId) {
                    showProveedorDetail(currentProveedorId);
                } else {
                    renderProveedoresFacturasPorPagar();
                }
                closeModal('pagarFacturaModal');
            } catch (error) {
                console.error('Error:', error);
            } finally {
                hideLoading();
            }
        }

        function populateProveedoresDropdown() {
            const select = document.getElementById('activoProveedor');
            select.innerHTML = '<option value="">-- Seleccione un proveedor --</option>';
            proveedores.forEach(prov => {
                const option = document.createElement('option');
                option.value = prov.nombre;
                option.textContent = prov.nombre;
                select.appendChild(option);
            });
        }

        function renderActivosTable() {
            const tbody = document.getElementById('activosTable').querySelector('tbody');
            tbody.innerHTML = '';
            activos.forEach(act => {
                const row = tbody.insertRow();
                row.style.cursor = 'pointer';
                row.onclick = () => showActivoDetail(act.id);
                row.innerHTML = `<td>${act.nombre}</td><td>${formatDate(act.ultimoMant)}</td><td>${formatDate(act.proximoMant)}</td><td>${act.proveedor || '-'}</td>`;
            });
            if (activos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--text-light)">No hay activos</td></tr>';
            }
        }

        function showAddActivoModal() {
            isEditMode = false; currentActivoId = null; currentActivoFotos = [];
            document.getElementById('addActivoTitle').textContent = 'Agregar Activo';
            document.getElementById('activoForm').reset();
            document.getElementById('activoFotosFileName').textContent = '';
            populateProveedoresDropdown();
            document.getElementById('addActivoModal').classList.add('active');
        }

        async function saveActivo(event) {
            event.preventDefault();
            showLoading();
            try {
                const actData = {
                    nombre: document.getElementById('activoNombre').value,
                    ultimo_mant: document.getElementById('activoUltimoMant').value,
                    proximo_mant: document.getElementById('activoProximoMant').value,
                    proveedor: document.getElementById('activoProveedor').value,
                    notas: document.getElementById('activoNotas').value
                };
                
                let activoId = currentActivoId;
                if (isEditMode) {
                    const { error } = await supabaseClient.from('activos').update(actData).eq('id', currentActivoId);
                    if (error) throw error;
                } else {
                    const { data, error } = await supabaseClient.from('activos').insert([actData]).select().single();
                    if (error) throw error;
                    activoId = data.id;
                }
                
                const fotosInput = document.getElementById('activoFotos');
                if (fotosInput.files.length > 0) {
                    for (const file of fotosInput.files) {
                        const fotoData = await fileToBase64(file);
                        const { error } = await supabaseClient.from('activos_fotos').insert([{
                            activo_id: activoId,
                            foto_data: fotoData,
                            foto_name: file.name
                        }]);
                        if (error) throw error;
                    }
                }
                
                await loadActivos();
                renderActivosTable();
                closeModal('addActivoModal');
                isEditMode = false; currentActivoId = null; currentActivoFotos = [];
            } catch (error) {
                console.error('Error:', error);
            } finally {
                hideLoading();
            }
        }

        function showActivoDetail(id) {
            const act = activos.find(a => a.id === id);
            currentActivoId = id;
            document.getElementById('activoDetailNombre').textContent = act.nombre;
            document.getElementById('detailUltimoMant').textContent = formatDate(act.ultimoMant);
            document.getElementById('detailProximoMant').textContent = formatDate(act.proximoMant);
            document.getElementById('detailActivoProveedor').textContent = act.proveedor || '-';
            document.getElementById('detailActivoNotas').textContent = act.notas || '-';
            
            const gallery = document.getElementById('photoGallery');
            if (act.fotos && act.fotos.length > 0) {
                gallery.innerHTML = act.fotos.map(f => `
                    <div class="photo-item">
                        <img src="${f.data}" alt="${f.name}">
                    </div>
                `).join('');
            } else {
                gallery.innerHTML = '<p style="color:var(--text-light);text-align:center">No hay fotos</p>';
            }
            
            document.getElementById('activoDetailModal').classList.add('active');
        }

        function editActivo() {
            const act = activos.find(a => a.id === currentActivoId);
            isEditMode = true;
            currentActivoFotos = act.fotos;
            document.getElementById('addActivoTitle').textContent = 'Editar Activo';
            document.getElementById('activoNombre').value = act.nombre;
            document.getElementById('activoUltimoMant').value = act.ultimoMant || '';
            document.getElementById('activoProximoMant').value = act.proximoMant || '';
            populateProveedoresDropdown();
            document.getElementById('activoProveedor').value = act.proveedor || '';
            document.getElementById('activoNotas').value = act.notas || '';
            closeModal('activoDetailModal');
            document.getElementById('addActivoModal').classList.add('active');
        }

        async function deleteActivo() {
            if (!confirm('¬øEliminar este activo?')) return;
            showLoading();
            try {
                const { error } = await supabaseClient.from('activos').delete().eq('id', currentActivoId);
                if (error) throw error;
                await loadActivos();
                renderActivosTable();
                closeModal('activoDetailModal');
            } catch (error) {
                console.error('Error:', error);
            } finally {
                hideLoading();
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ ESWU iniciado');
            
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const username = document.getElementById('username').value;
                    if (username) login(username);
                });
            }
            
            const inquilinoContrato = document.getElementById('inquilinoContrato');
            if (inquilinoContrato) {
                inquilinoContrato.addEventListener('change', function(e) {
                    if (e.target.files.length > 0) {
                        document.getElementById('contratoFileName').textContent = e.target.files[0].name;
                    }
                });
            }
            
            const inquilinoDocAdicional = document.getElementById('inquilinoDocAdicional');
            if (inquilinoDocAdicional) {
                inquilinoDocAdicional.addEventListener('change', function(e) {
                    if (e.target.files.length > 0) {
                        document.getElementById('docAdicionalFileName').textContent = e.target.files[0].name;
                        document.getElementById('nombreDocGroup').classList.remove('hidden');
                    } else {
                        document.getElementById('nombreDocGroup').classList.add('hidden');
                    }
                });
            }
            
            const proveedorDocAdicional = document.getElementById('proveedorDocAdicional');
            if (proveedorDocAdicional) {
                proveedorDocAdicional.addEventListener('change', function(e) {
                    if (e.target.files.length > 0) {
                        document.getElementById('provDocAdicionalFileName').textContent = e.target.files[0].name;
                        document.getElementById('nombreProvDocGroup').classList.remove('hidden');
                    } else {
                        document.getElementById('nombreProvDocGroup').classList.add('hidden');
                    }
                });
            }
            
            const facturaDocumento = document.getElementById('facturaDocumento');
            if (facturaDocumento) {
                facturaDocumento.addEventListener('change', function(e) {
                    if (e.target.files.length > 0) {
                        document.getElementById('facturaDocumentoFileName').textContent = e.target.files[0].name;
                    }
                });
            }
            
            const pagoPDFFactura = document.getElementById('pagoPDFFactura');
            if (pagoPDFFactura) {
                pagoPDFFactura.addEventListener('change', function(e) {
                    if (e.target.files.length > 0) {
                        document.getElementById('pagoPDFFacturaFileName').textContent = e.target.files[0].name;
                    }
                });
            }
            
            const activoFotos = document.getElementById('activoFotos');
            if (activoFotos) {
                activoFotos.addEventListener('change', function(e) {
                    if (e.target.files.length > 0) {
                        document.getElementById('activoFotosFileName').textContent = `${e.target.files.length} foto(s) seleccionada(s)`;
                    }
                });
            }
        });
    </script>
</body>
</html>
