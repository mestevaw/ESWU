<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESWU</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary: #1a365d;
            --primary-dark: #0f2744;
            --secondary: #2c5282;
            --accent: #3182ce;
            --success: #38a169;
            --danger: #e53e3e;
            --warning: #dd6b20;
            --bg: #f7fafc;
            --card-bg: #ffffff;
            --text: #2d3748;
            --text-light: #718096;
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .loading-overlay.hidden {
            display: none;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Login Page */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        }

        .login-container.hidden {
            display: none;
        }

        .login-box {
            background: white;
            padding: 3rem;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 400px;
        }

        .login-box h1 {
            color: var(--primary);
            margin-bottom: 2rem;
            text-align: center;
            font-size: 2rem;
        }

        /* App Container */
        .app-container {
            display: none;
            min-height: 100vh;
        }

        .app-container.active {
            display: block;
        }

        /* Header */
        .header {
            background: var(--primary);
            color: white;
            padding: 1rem 2rem;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-name {
            font-weight: 500;
        }

        /* Navigation */
        .nav {
            background: var(--card-bg);
            box-shadow: var(--shadow);
            padding: 0 2rem;
        }

        .nav-list {
            list-style: none;
            display: flex;
            gap: 2rem;
        }

        .nav-item {
            position: relative;
        }

        .nav-link {
            display: block;
            padding: 1rem 0;
            color: var(--text);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s;
            border-bottom: 3px solid transparent;
        }

        .nav-link:hover,
        .nav-link.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        /* Main Content */
        .main-content {
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Pages */
        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .card-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 1.5rem;
            color: var(--primary);
            font-weight: 600;
        }

        /* Summary Grid */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .summary-card {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: var(--shadow);
        }

        .summary-label {
            color: var(--text-light);
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }

        .summary-value {
            font-size: 2rem;
            font-weight: 600;
            color: var(--primary);
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: var(--bg);
        }

        th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--text);
            border-bottom: 2px solid var(--border);
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
        }

        tr:hover {
            background: var(--bg);
        }

        .currency {
            text-align: right;
            font-variant-numeric: tabular-nums;
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            filter: brightness(1.1);
        }

        .btn-secondary {
            background: var(--text-light);
            color: white;
        }

        .btn-secondary:hover {
            filter: brightness(0.9);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            filter: brightness(1.1);
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        /* Forms */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border);
            border-radius: 6px;
            font-size: 1rem;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* Filter Section */
        .filter-section {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-section label {
            font-weight: 500;
        }

        .filter-section select {
            padding: 0.5rem 1rem;
            border: 2px solid var(--border);
            border-radius: 6px;
            font-size: 1rem;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.5rem;
            color: var(--primary);
            font-weight: 600;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 2rem;
            color: var(--text-light);
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-modal:hover {
            color: var(--text);
        }

        .modal-content form {
            padding: 1.5rem;
        }

        .modal-actions {
            padding: 1.5rem;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .badge-success {
            background: #c6f6d5;
            color: #22543d;
        }

        .badge-warning {
            background: #feebc8;
            color: #7c2d12;
        }

        .badge-danger {
            background: #fed7d7;
            color: #742a2a;
        }

        /* Dropdown styles */
        .dropdown {
            position: relative;
            display: inline-block;
        }
        
        .dropdown-toggle {
            font-size: 1.5rem;
            padding: 0.5rem 1rem;
            cursor: pointer;
        }
        
        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: white;
            min-width: 200px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            z-index: 1000;
            border-radius: 6px;
            overflow: hidden;
        }
        
        .dropdown-content.show {
            display: block;
        }
        
        .dropdown-content a {
            color: var(--text);
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            transition: background-color 0.2s;
        }
        
        .dropdown-content a:hover {
            background-color: var(--bg);
        }

        /* File upload area */
        .file-upload {
            border: 2px dashed var(--border);
            border-radius: 6px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .file-upload:hover {
            border-color: var(--primary);
            background: var(--bg);
        }

        .file-upload input[type="file"] {
            display: none;
        }

        /* Tables Grid */
        .tables-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
        }

        /* Hidden */
        .hidden {
            display: none !important;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 1rem;
            }

            .nav-list {
                flex-direction: column;
                gap: 0;
            }

            .nav-link {
                padding: 0.75rem 0;
            }

            .main-content {
                padding: 1rem;
            }

            .summary-grid {
                grid-template-columns: 1fr;
            }

            .tables-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                margin: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="loading-spinner"></div>
    </div>

    <!-- Login Container -->
    <div id="loginContainer" class="login-container">
        <div class="login-box">
            <h1>ESWU</h1>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Seleccione Usuario</label>
                    <select id="username" required style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 6px; font-size: 1rem;">
                        <option value="">-- Seleccione un usuario --</option>
                        <option value="Anabel">Anabel</option>
                        <option value="Doris">Doris</option>
                        <option value="Miguel">Miguel</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Iniciar Sesión</button>
            </form>
        </div>
    </div>

    <!-- App Container -->
    <div id="appContainer" class="app-container">
        <!-- Header -->
        <div class="header">
            <div class="header-title">ESWU - Con Supabase</div>
            <div class="user-info">
                <span class="user-name" id="currentUser"></span>
                <button onclick="logout()" class="btn btn-secondary btn-sm">Salir</button>
            </div>
        </div>

        <!-- Navigation -->
        <nav class="nav">
            <ul class="nav-list">
                <li class="nav-item"><a href="#" class="nav-link active" onclick="showPage('home')">Home</a></li>
                <li class="nav-item"><a href="#" class="nav-link" onclick="showPage('inquilinos')">Inquilinos</a></li>
                <li class="nav-item"><a href="#" class="nav-link" onclick="showPage('proveedores')">Proveedores</a></li>
                <li class="nav-item"><a href="#" class="nav-link" onclick="showPage('activos')">Activos</a></li>
                <li class="nav-item"><a href="#" class="nav-link" onclick="showPage('chat')">Chat</a></li>
            </ul>
        </nav>

        <!-- Main Content -->
        <div class="main-content">
            <!-- HOME PAGE -->
            <div id="homePage" class="page active">
                <div class="summary-grid">
                    <div class="summary-card">
                        <div class="summary-label">Ingresos</div>
                        <div class="summary-value currency" id="summaryIngresos">$0</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">Gastos</div>
                        <div class="summary-value currency" id="summaryGastos">$0</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">Ingreso Neto</div>
                        <div class="summary-value currency" id="summaryNeto">$0</div>
                    </div>
                </div>

                <div class="filter-section">
                    <label>Ver por:</label>
                    <select id="homeFilter" onchange="updateHomeView()">
                        <option value="anual">Anual</option>
                        <option value="mensual">Mensual</option>
                    </select>
                    <select id="homeYear" onchange="updateHomeView()">
                    </select>
                    <select id="homeMonth" onchange="updateHomeView()" class="hidden">
                        <option value="0">Enero</option>
                        <option value="1">Febrero</option>
                        <option value="2">Marzo</option>
                        <option value="3">Abril</option>
                        <option value="4">Mayo</option>
                        <option value="5">Junio</option>
                        <option value="6">Julio</option>
                        <option value="7">Agosto</option>
                        <option value="8">Septiembre</option>
                        <option value="9">Octubre</option>
                        <option value="10">Noviembre</option>
                        <option value="11">Diciembre</option>
                    </select>
                </div>

                <div class="tables-grid">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Ingresos por Renta</h2>
                        </div>
                        <div class="table-container">
                            <table id="homeIngresosTable">
                                <thead>
                                    <tr>
                                        <th>Inquilino</th>
                                        <th>Fecha</th>
                                        <th>Monto</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Gastos</h2>
                        </div>
                        <div class="table-container">
                            <table id="homeGastosTable">
                                <thead>
                                    <tr>
                                        <th>Proveedor</th>
                                        <th>Fecha</th>
                                        <th>Monto</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CHAT PAGE (Placeholder) -->
            <div id="chatPage" class="page">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Chat</h2>
                    </div>
                    <div style="padding: 2rem; text-align: center; color: var(--text-light);">
                        <p>Funcionalidad de Chat - Próximamente</p>
                    </div>
                </div>
            </div>

            <!-- Placeholder pages -->
            <!-- INQUILINOS PAGE -->
            <div id="inquilinosPage" class="page">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title" id="inquilinosTitulo">Inquilinos - Listado</h2>
                        <div class="dropdown">
                            <button class="btn btn-primary dropdown-toggle" onclick="toggleDropdown('inquilinosDropdown')">
                                ☰
                            </button>
                            <div id="inquilinosDropdown" class="dropdown-content">
                                <a href="#" onclick="event.preventDefault(); showInquilinosView('list');">Listado</a>
                                <a href="#" onclick="event.preventDefault(); showAddInquilinoModal();">Agregar Inquilino</a>
                                <a href="#" onclick="event.preventDefault(); showInquilinosView('rentasRecibidas');">Rentas Recibidas</a>
                                <a href="#" onclick="event.preventDefault(); showInquilinosView('vencimientoContratos');">Vencimiento Contratos</a>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Vista principal de inquilinos -->
                    <div id="inquilinosListView">
                        <div class="table-container">
                            <table id="inquilinosTable">
                                <thead>
                                    <tr>
                                        <th>Empresa</th>
                                        <th>Renta Mensual</th>
                                        <th>Vencimiento Contrato</th>
                                        <th>Contrato</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Vista Rentas Recibidas -->
                    <div id="inquilinosRentasRecibidasView" class="hidden">
                        <div style="padding: 1rem 0;">
                            <div class="filter-section">
                                <select id="inquilinosRentasFilter" onchange="renderInquilinosRentasRecibidas()">
                                    <option value="anual">Anual</option>
                                    <option value="mensual">Mensual</option>
                                </select>
                                <select id="inquilinosRentasYear" onchange="renderInquilinosRentasRecibidas()">
                                </select>
                                <select id="inquilinosRentasMonth" onchange="renderInquilinosRentasRecibidas()" class="hidden">
                                    <option value="0">Enero</option>
                                    <option value="1">Febrero</option>
                                    <option value="2">Marzo</option>
                                    <option value="3">Abril</option>
                                    <option value="4">Mayo</option>
                                    <option value="5">Junio</option>
                                    <option value="6">Julio</option>
                                    <option value="7">Agosto</option>
                                    <option value="8">Septiembre</option>
                                    <option value="9">Octubre</option>
                                    <option value="10">Noviembre</option>
                                    <option value="11">Diciembre</option>
                                </select>
                            </div>
                            <div class="table-container">
                                <table id="inquilinosRentasRecibidasTable">
                                    <thead>
                                        <tr>
                                            <th>Empresa</th>
                                            <th>Renta Recibida</th>
                                            <th>Fecha de Pago</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Vista Vencimiento Contratos -->
                    <div id="inquilinosVencimientoContratosView" class="hidden">
                        <div style="padding: 1rem 0;">
                            <div class="table-container">
                                <table id="inquilinosVencimientoContratosTable">
                                    <thead>
                                        <tr>
                                            <th>Inquilino</th>
                                            <th>Fecha Inicio</th>
                                            <th>Fecha Vencimiento</th>
                                            <th>Días Restantes</th>
                                            <th>Estado</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Agregar/Editar Inquilino -->
            <div id="addInquilinoModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title" id="inquilinoModalTitle">Agregar Inquilino</h2>
                        <button class="close-modal" onclick="closeModal('addInquilinoModal')">×</button>
                    </div>
                    <form id="inquilinoForm" onsubmit="saveInquilino(event)">
                        <div class="form-group">
                            <label>Nombre de la Empresa *</label>
                            <input type="text" id="inquilinoNombre" required>
                        </div>
                        <div class="form-group">
                            <label>Contacto *</label>
                            <input type="text" id="inquilinoContacto" required>
                        </div>
                        <div class="form-group">
                            <label>Teléfono</label>
                            <input type="tel" id="inquilinoTelefono">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="inquilinoEmail">
                        </div>
                        <div class="form-group">
                            <label>CLABE</label>
                            <input type="text" id="inquilinoClabe">
                        </div>
                        <div class="form-group">
                            <label>RFC</label>
                            <input type="text" id="inquilinoRFC">
                        </div>
                        <div class="form-group">
                            <label>M²</label>
                            <input type="text" id="inquilinoM2">
                        </div>
                        <div class="form-group">
                            <label>Renta Mensual *</label>
                            <input type="number" id="inquilinoRenta" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>Fecha Inicio Contrato *</label>
                            <input type="date" id="inquilinoFechaInicio" required>
                        </div>
                        <div class="form-group">
                            <label>Fecha Vencimiento Contrato *</label>
                            <input type="date" id="inquilinoFechaVenc" required>
                        </div>
                        <div class="form-group">
                            <label>Contrato (PDF)</label>
                            <div class="file-upload" onclick="document.getElementById('inquilinoContrato').click()">
                                <input type="file" id="inquilinoContrato" accept=".pdf">
                                <p>Click para seleccionar PDF del contrato</p>
                                <p id="contratoFileName" style="color: var(--success); margin-top: 0.5rem;"></p>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Notas</label>
                            <textarea id="inquilinoNotas"></textarea>
                        </div>
                        <div class="modal-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeModal('addInquilinoModal')">Cancelar</button>
                            <button type="submit" class="btn btn-success">Guardar</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Modal Detalles Inquilino -->
            <div id="inquilinoDetailModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title" id="inquilinoDetailNombre"></h2>
                        <button class="close-modal" onclick="closeModal('inquilinoDetailModal')">×</button>
                    </div>
                    <div style="padding: 1.5rem;">
                        <div class="info-grid">
                            <div class="info-item">
                                <div class="info-label">Contacto</div>
                                <div class="info-value" id="detailContacto"></div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Teléfono</div>
                                <div class="info-value" id="detailTelefono"></div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Email</div>
                                <div class="info-value" id="detailEmail"></div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">M²</div>
                                <div class="info-value" id="detailM2"></div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Renta Mensual</div>
                                <div class="info-value currency" id="detailRenta"></div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Fecha Inicio</div>
                                <div class="info-value" id="detailFechaInicio"></div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Fecha Vencimiento</div>
                                <div class="info-value" id="detailFechaVenc"></div>
                            </div>
                        </div>
                        
                        <h3 style="margin: 1.5rem 0 1rem 0;">Historial de Pagos</h3>
                        <div id="historialPagos"></div>
                        
                        <div class="modal-actions" style="margin-top: 1.5rem;">
                            <button class="btn btn-primary" onclick="editInquilino()">Modificar</button>
                            <button class="btn btn-success" onclick="showRegistrarPagoModal()">Registrar Pago</button>
                            <button class="btn btn-danger" onclick="deleteInquilino()">Eliminar</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Registrar Pago -->
            <div id="registrarPagoModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title">Registrar Pago de Renta</h2>
                        <button class="close-modal" onclick="closeModal('registrarPagoModal')">×</button>
                    </div>
                    <form onsubmit="savePagoRenta(event)">
                        <div style="padding: 1.5rem;">
                            <div class="form-group">
                                <label>Fecha de Pago *</label>
                                <input type="date" id="pagoFecha" required>
                            </div>
                            <div class="form-group">
                                <label>¿Pago Completo? *</label>
                                <select id="pagoCompleto">
                                    <option value="si">Sí</option>
                                    <option value="no">No</option>
                                </select>
                            </div>
                            <div class="form-group hidden" id="pagoMontoGroup">
                                <label>Monto Pagado</label>
                                <input type="number" id="pagoMonto" step="0.01">
                            </div>
                            <div class="form-group">
                                <label>Comprobante de Pago (PDF) *</label>
                                <div class="file-upload" onclick="document.getElementById('pagoPDF').click()">
                                    <input type="file" id="pagoPDF" accept=".pdf" required>
                                    <p>Click para seleccionar PDF del pago</p>
                                    <p id="pagoPDFFileName" style="color: var(--success); margin-top: 0.5rem;"></p>
                                </div>
                            </div>
                        </div>
                        <div class="modal-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeModal('registrarPagoModal')">Cancelar</button>
                            <button type="submit" class="btn btn-success">Guardar Pago</button>
                        </div>
                    </form>
                </div>
            </div>

          <!-- INQUILINOS PAGE -->
            <div id="inquilinosPage" class="page">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title" id="inquilinosTitulo">Inquilinos - Listado</h2>
                        <div class="dropdown">
                            <button class="btn btn-primary dropdown-toggle" onclick="toggleDropdown('inquilinosDropdown')">
                                ☰
                            </button>
                            <div id="inquilinosDropdown" class="dropdown-content">
                                <a href="#" onclick="event.preventDefault(); showInquilinosView('list');">Listado</a>
                                <a href="#" onclick="event.preventDefault(); showAddInquilinoModal();">Agregar Inquilino</a>
                                <a href="#" onclick="event.preventDefault(); showInquilinosView('rentasRecibidas');">Rentas Recibidas</a>
                                <a href="#" onclick="event.preventDefault(); showInquilinosView('vencimientoContratos');">Vencimiento Contratos</a>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Vista principal de inquilinos -->
                    <div id="inquilinosListView">
                        <div class="table-container">
                            <table id="inquilinosTable">
                                <thead>
                                    <tr>
                                        <th>Empresa</th>
                                        <th>Renta Mensual</th>
                                        <th>Vencimiento Contrato</th>
                                        <th>Contrato</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Vista Rentas Recibidas -->
                    <div id="inquilinosRentasRecibidasView" class="hidden">
                        <div style="padding: 1rem 0;">
                            <div class="filter-section">
                                <select id="inquilinosRentasFilter" onchange="renderInquilinosRentasRecibidas()">
                                    <option value="anual">Anual</option>
                                    <option value="mensual">Mensual</option>
                                </select>
                                <select id="inquilinosRentasYear" onchange="renderInquilinosRentasRecibidas()">
                                </select>
                                <select id="inquilinosRentasMonth" onchange="renderInquilinosRentasRecibidas()" class="hidden">
                                    <option value="0">Enero</option>
                                    <option value="1">Febrero</option>
                                    <option value="2">Marzo</option>
                                    <option value="3">Abril</option>
                                    <option value="4">Mayo</option>
                                    <option value="5">Junio</option>
                                    <option value="6">Julio</option>
                                    <option value="7">Agosto</option>
                                    <option value="8">Septiembre</option>
                                    <option value="9">Octubre</option>
                                    <option value="10">Noviembre</option>
                                    <option value="11">Diciembre</option>
                                </select>
                            </div>
                            <div class="table-container">
                                <table id="inquilinosRentasRecibidasTable">
                                    <thead>
                                        <tr>
                                            <th>Empresa</th>
                                            <th>Renta Recibida</th>
                                            <th>Fecha de Pago</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Vista Vencimiento Contratos -->
                    <div id="inquilinosVencimientoContratosView" class="hidden">
                        <div style="padding: 1rem 0;">
                            <div class="table-container">
                                <table id="inquilinosVencimientoContratosTable">
                                    <thead>
                                        <tr>
                                            <th>Inquilino</th>
                                            <th>Fecha Inicio</th>
                                            <th>Fecha Vencimiento</th>
                                            <th>Días Restantes</th>
                                            <th>Estado</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Agregar/Editar Inquilino -->
            <div id="addInquilinoModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title" id="inquilinoModalTitle">Agregar Inquilino</h2>
                        <button class="close-modal" onclick="closeModal('addInquilinoModal')">×</button>
                    </div>
                    <form id="inquilinoForm" onsubmit="saveInquilino(event)">
                        <div class="form-group">
                            <label>Nombre de la Empresa *</label>
                            <input type="text" id="inquilinoNombre" required>
                        </div>
                        <div class="form-group">
                            <label>Contacto *</label>
                            <input type="text" id="inquilinoContacto" required>
                        </div>
                        <div class="form-group">
                            <label>Teléfono</label>
                            <input type="tel" id="inquilinoTelefono">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="inquilinoEmail">
                        </div>
                        <div class="form-group">
                            <label>CLABE</label>
                            <input type="text" id="inquilinoClabe">
                        </div>
                        <div class="form-group">
                            <label>RFC</label>
                            <input type="text" id="inquilinoRFC">
                        </div>
                        <div class="form-group">
                            <label>M²</label>
                            <input type="text" id="inquilinoM2">
                        </div>
                        <div class="form-group">
                            <label>Renta Mensual *</label>
                            <input type="number" id="inquilinoRenta" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>Fecha Inicio Contrato *</label>
                            <input type="date" id="inquilinoFechaInicio" required>
                        </div>
                        <div class="form-group">
                            <label>Fecha Vencimiento Contrato *</label>
                            <input type="date" id="inquilinoFechaVenc" required>
                        </div>
                        <div class="form-group">
                            <label>Contrato (PDF)</label>
                            <div class="file-upload" onclick="document.getElementById('inquilinoContrato').click()">
                                <input type="file" id="inquilinoContrato" accept=".pdf">
                                <p>Click para seleccionar PDF del contrato</p>
                                <p id="contratoFileName" style="color: var(--success); margin-top: 0.5rem;"></p>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Notas</label>
                            <textarea id="inquilinoNotas"></textarea>
                        </div>
                        <div class="modal-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeModal('addInquilinoModal')">Cancelar</button>
                            <button type="submit" class="btn btn-success">Guardar</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Modal Detalles Inquilino -->
            <div id="inquilinoDetailModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title" id="inquilinoDetailNombre"></h2>
                        <button class="close-modal" onclick="closeModal('inquilinoDetailModal')">×</button>
                    </div>
                    <div style="padding: 1.5rem;">
                        <div class="info-grid">
                            <div class="info-item">
                                <div class="info-label">Contacto</div>
                                <div class="info-value" id="detailContacto"></div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Teléfono</div>
                                <div class="info-value" id="detailTelefono"></div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Email</div>
                                <div class="info-value" id="detailEmail"></div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">M²</div>
                                <div class="info-value" id="detailM2"></div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Renta Mensual</div>
                                <div class="info-value currency" id="detailRenta"></div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Fecha Inicio</div>
                                <div class="info-value" id="detailFechaInicio"></div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Fecha Vencimiento</div>
                                <div class="info-value" id="detailFechaVenc"></div>
                            </div>
                        </div>
                        
                        <h3 style="margin: 1.5rem 0 1rem 0;">Historial de Pagos</h3>
                        <div id="historialPagos"></div>
                        
                        <div class="modal-actions" style="margin-top: 1.5rem;">
                            <button class="btn btn-primary" onclick="editInquilino()">Modificar</button>
                            <button class="btn btn-success" onclick="showRegistrarPagoModal()">Registrar Pago</button>
                            <button class="btn btn-danger" onclick="deleteInquilino()">Eliminar</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Registrar Pago -->
            <div id="registrarPagoModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title">Registrar Pago de Renta</h2>
                        <button class="close-modal" onclick="closeModal('registrarPagoModal')">×</button>
                    </div>
                    <form onsubmit="savePagoRenta(event)">
                        <div style="padding: 1.5rem;">
                            <div class="form-group">
                                <label>Fecha de Pago *</label>
                                <input type="date" id="pagoFecha" required>
                            </div>
                            <div class="form-group">
                                <label>¿Pago Completo? *</label>
                                <select id="pagoCompleto">
                                    <option value="si">Sí</option>
                                    <option value="no">No</option>
                                </select>
                            </div>
                            <div class="form-group hidden" id="pagoMontoGroup">
                                <label>Monto Pagado</label>
                                <input type="number" id="pagoMonto" step="0.01">
                            </div>
                            <div class="form-group">
                                <label>Comprobante de Pago (PDF) *</label>
                                <div class="file-upload" onclick="document.getElementById('pagoPDF').click()">
                                    <input type="file" id="pagoPDF" accept=".pdf" required>
                                    <p>Click para seleccionar PDF del pago</p>
                                    <p id="pagoPDFFileName" style="color: var(--success); margin-top: 0.5rem;"></p>
                                </div>
                            </div>
                        </div>
                        <div class="modal-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeModal('registrarPagoModal')">Cancelar</button>
                            <button type="submit" class="btn btn-success">Guardar Pago</button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="activosPage" class="page">
                <div class="card">
                    <h2 class="card-title">Activos</h2>
                    <p style="padding: 2rem;">Cargando funcionalidad completa...</p>
                </div>
            </div>
        </div>
    </div>
    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://tzuvoceilkqurnujrraq.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR6dXZvY2VpbGtxdXJudWpycmFxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1Mjg3NDIsImV4cCI6MjA4NTEwNDc0Mn0.2bGNuh7nVhAFGULlXBT85wsKUMgJJbEEGtUq0jerqno';
        
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Global state
        let currentUser = '';
        let inquilinos = [];
        let proveedores = [];
        let activos = [];

        // Show/hide loading overlay
        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        // Login/Logout
        function login(username) {
            console.log('Login function called with:', username);
            if (!username || username === '') {
                alert('Por favor seleccione un usuario');
                return;
            }
            
            currentUser = username;
            const userDisplay = document.getElementById('currentUser');
            if (userDisplay) {
                userDisplay.textContent = username;
            }
            
            const loginContainer = document.getElementById('loginContainer');
            const appContainer = document.getElementById('appContainer');
            
            if (loginContainer) {
                loginContainer.classList.add('hidden');
            }
            if (appContainer) {
                appContainer.classList.add('active');
            }
            
            // Load data from Supabase
            setTimeout(function() {
                loadAllData();
            }, 100);
        }

        function logout() {
            currentUser = '';
            document.getElementById('username').value = '';
            document.getElementById('loginContainer').classList.remove('hidden');
            document.getElementById('appContainer').classList.remove('active');
        }

        // Navigation
        function showPage(pageName) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            
            document.getElementById(pageName + 'Page').classList.add('active');
            event.target.classList.add('active');
            
            if (pageName === 'home') {
                updateHomeView();
            }
        }

        // Load all data from Supabase
        async function loadAllData() {
            showLoading();
            try {
                await Promise.all([
                    loadInquilinos(),
                    loadProveedores(),
                    loadActivos()
                ]);
                
                populateYearSelect();
                updateHomeView();
                console.log('✅ Todos los datos cargados desde Supabase');
                console.log('Inquilinos:', inquilinos.length);
                console.log('Proveedores:', proveedores.length);
                console.log('Activos:', activos.length);
            } catch (error) {
                console.error('❌ Error cargando datos:', error);
                alert('Error al cargar los datos. Por favor recarga la página.');
            } finally {
                hideLoading();
            }
        }

        // Load Inquilinos
        async function loadInquilinos() {
            try {
                const { data, error } = await supabaseClient
                    .from('inquilinos')
                    .select('*, pagos_inquilinos(*)')
                    .order('nombre');
                
                if (error) throw error;
                
                inquilinos = data.map(inq => ({
                    id: inq.id,
                    nombre: inq.nombre,
                    contacto: inq.contacto,
                    telefono: inq.telefono,
                    email: inq.email,
                    clabe: inq.clabe,
                    rfc: inq.rfc,
                    m2: inq.m2,
                    renta: parseFloat(inq.renta || 0),
                    fechaInicio: inq.fecha_inicio,
                    fechaVencimiento: inq.fecha_vencimiento,
                    notas: inq.notas,
                    contratoFile: inq.contrato_file,
                    contratoFileName: inq.contrato_filename,
                    pagos: inq.pagos_inquilinos ? inq.pagos_inquilinos.map(p => ({
                        id: p.id,
                        fecha: p.fecha,
                        monto: parseFloat(p.monto),
                        completo: p.completo,
                        pagoFile: p.pago_file,
                        pagoFileName: p.pago_filename
                    })).sort((a, b) => new Date(b.fecha) - new Date(a.fecha)) : []
                }));
                
                console.log('Inquilinos cargados:', inquilinos.length);
            } catch (error) {
                console.error('Error loading inquilinos:', error);
                throw error;
            }
        }

        // Load Proveedores
        async function loadProveedores() {
            try {
                const { data, error } = await supabaseClient
                    .from('proveedores')
                    .select('*, facturas(*)')
                    .order('nombre');
                
                if (error) throw error;
                
                proveedores = data.map(prov => ({
                    id: prov.id,
                    nombre: prov.nombre,
                    servicio: prov.servicio,
                    contacto: prov.contacto,
                    telefono: prov.telefono,
                    email: prov.email,
                    clabe: prov.clabe,
                    rfc: prov.rfc,
                    notas: prov.notas,
                    facturas: prov.facturas ? prov.facturas.map(f => ({
                        id: f.id,
                        numero: f.numero,
                        fecha: f.fecha,
                        vencimiento: f.vencimiento,
                        monto: parseFloat(f.monto),
                        fechaPago: f.fecha_pago,
                        documentoFile: f.documento_file,
                        documentoFileName: f.documento_filename,
                        pagoFile: f.pago_file,
                        pagoFileName: f.pago_filename
                    })).sort((a, b) => new Date(b.fecha) - new Date(a.fecha)) : []
                }));
                
                console.log('Proveedores cargados:', proveedores.length);
            } catch (error) {
                console.error('Error loading proveedores:', error);
                throw error;
            }
        }

        // Load Activos
        async function loadActivos() {
            try {
                const { data, error } = await supabaseClient
                    .from('activos')
                    .select('*, activos_fotos(*)')
                    .order('nombre');
                
                if (error) throw error;
                
                activos = data.map(act => ({
                    id: act.id,
                    nombre: act.nombre,
                    ultimoMant: act.ultimo_mant,
                    proximoMant: act.proximo_mant,
                    proveedor: act.proveedor,
                    notas: act.notas,
                    fotos: act.activos_fotos ? act.activos_fotos.map(f => ({
                        id: f.id,
                        data: f.foto_data,
                        name: f.foto_name
                    })) : []
                }));
                
                console.log('Activos cargados:', activos.length);
            } catch (error) {
                console.error('Error loading activos:', error);
                throw error;
            }
        }

        // Utility functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-MX', {
                style: 'currency',
                currency: 'MXN'
            }).format(amount);
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString + 'T00:00:00');
            const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
            const day = date.getDate();
            const month = months[date.getMonth()];
            const year = date.getFullYear();
            return `${day} ${month} ${year}`;
        }

        function populateYearSelect() {
            const currentYear = new Date().getFullYear();
            const yearSelect = document.getElementById('homeYear');
            yearSelect.innerHTML = '';
            
            for (let year = currentYear - 5; year <= currentYear + 1; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYear) option.selected = true;
                yearSelect.appendChild(option);
            }
        }

        // HOME PAGE FUNCTIONS
        function updateHomeView() {
            const filterType = document.getElementById('homeFilter').value;
            const year = parseInt(document.getElementById('homeYear').value);
            const monthSelect = document.getElementById('homeMonth');
            
            if (filterType === 'mensual') {
                monthSelect.classList.remove('hidden');
            } else {
                monthSelect.classList.add('hidden');
            }
            
            const month = filterType === 'mensual' ? parseInt(monthSelect.value) : null;
            
            // Calculate summary
            let totalIngresos = 0;
            let totalGastos = 0;
            
            inquilinos.forEach(inquilino => {
                if (inquilino.pagos) {
                    inquilino.pagos.forEach(pago => {
                        const pagoDate = new Date(pago.fecha + 'T00:00:00');
                        if (pagoDate.getFullYear() === year) {
                            if (month === null || pagoDate.getMonth() === month) {
                                totalIngresos += pago.monto;
                            }
                        }
                    });
                }
            });
            
            proveedores.forEach(proveedor => {
                if (proveedor.facturas) {
                    proveedor.facturas.forEach(factura => {
                        if (factura.fechaPago) {
                            const pagoDate = new Date(factura.fechaPago + 'T00:00:00');
                            if (pagoDate.getFullYear() === year) {
                                if (month === null || pagoDate.getMonth() === month) {
                                    totalGastos += factura.monto;
                                }
                            }
                        }
                    });
                }
            });
            
            document.getElementById('summaryIngresos').textContent = formatCurrency(totalIngresos);
            document.getElementById('summaryGastos').textContent = formatCurrency(totalGastos);
            document.getElementById('summaryNeto').textContent = formatCurrency(totalIngresos - totalGastos);
            
            renderHomeIngresos(year, month);
            renderHomeGastos(year, month);
        }

        function renderHomeIngresos(year, month) {
            const tbody = document.getElementById('homeIngresosTable').querySelector('tbody');
            tbody.innerHTML = '';
            
            const pagos = [];
            let totalIngresos = 0;
            
            inquilinos.forEach(inquilino => {
                if (inquilino.pagos) {
                    inquilino.pagos.forEach(pago => {
                        const pagoDate = new Date(pago.fecha + 'T00:00:00');
                        if (pagoDate.getFullYear() === year) {
                            if (month === null || pagoDate.getMonth() === month) {
                                pagos.push({
                                    inquilino: inquilino.nombre,
                                    fecha: pago.fecha,
                                    monto: pago.monto
                                });
                                totalIngresos += pago.monto;
                            }
                        }
                    });
                }
            });
            
            pagos.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            
            pagos.forEach(pago => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${pago.inquilino}</td>
                    <td>${formatDate(pago.fecha)}</td>
                    <td class="currency">${formatCurrency(pago.monto)}</td>
                `;
            });
            
            if (pagos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: var(--text-light);">No hay ingresos registrados</td></tr>';
            } else {
                const rowTotal = tbody.insertRow();
                rowTotal.style.fontWeight = 'bold';
                rowTotal.style.backgroundColor = '#d4edda';
                rowTotal.innerHTML = `
                    <td colspan="2" style="text-align: right; padding: 1rem;">TOTAL:</td>
                    <td class="currency" style="color: var(--success); font-size: 1.1rem;">${formatCurrency(totalIngresos)}</td>
                `;
            }
        }

        function renderHomeGastos(year, month) {
            const tbody = document.getElementById('homeGastosTable').querySelector('tbody');
            tbody.innerHTML = '';
            
            const gastos = [];
            let totalGastos = 0;
            
            proveedores.forEach(proveedor => {
                if (proveedor.facturas) {
                    proveedor.facturas.forEach(factura => {
                        if (factura.fechaPago) {
                            const pagoDate = new Date(factura.fechaPago + 'T00:00:00');
                            if (pagoDate.getFullYear() === year) {
                                if (month === null || pagoDate.getMonth() === month) {
                                    gastos.push({
                                        proveedor: proveedor.nombre,
                                        fecha: factura.fechaPago,
                                        monto: factura.monto
                                    });
                                    totalGastos += factura.monto;
                                }
                            }
                        }
                    });
                }
            });
            
            gastos.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            
            gastos.forEach(gasto => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${gasto.proveedor}</td>
                    <td>${formatDate(gasto.fecha)}</td>
                    <td class="currency">${formatCurrency(gasto.monto)}</td>
                `;
            });
            
            if (gastos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: var(--text-light);">No hay gastos registrados</td></tr>';
            } else {
                const rowTotal = tbody.insertRow();
                rowTotal.style.fontWeight = 'bold';
                rowTotal.style.backgroundColor = '#fed7d7';
                rowTotal.innerHTML = `
                    <td colspan="2" style="text-align: right; padding: 1rem;">TOTAL:</td>
                    <td class="currency" style="color: var(--danger); font-size: 1.1rem;">${formatCurrency(totalGastos)}</td>
                `;
            }
        }
// INQUILINOS FUNCTIONS
        let currentInquilinoId = null;
        let isEditMode = false;

        // Toggle dropdown
        function toggleDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            document.querySelectorAll('.dropdown-content').forEach(dd => {
                if (dd.id !== dropdownId) {
                    dd.classList.remove('show');
                }
            });
            dropdown.classList.toggle('show');
        }

        // Close dropdown when clicking outside
        window.onclick = function(event) {
            if (!event.target.matches('.dropdown-toggle')) {
                document.querySelectorAll('.dropdown-content').forEach(dd => {
                    dd.classList.remove('show');
                });
            }
        }

        // Show Inquilinos views
        function showInquilinosView(view) {
            document.getElementById('inquilinosDropdown').classList.remove('show');
            
            document.getElementById('inquilinosListView').classList.add('hidden');
            document.getElementById('inquilinosRentasRecibidasView').classList.add('hidden');
            document.getElementById('inquilinosVencimientoContratosView').classList.add('hidden');
            
            const titulo = document.getElementById('inquilinosTitulo');
            
            if (view === 'list') {
                titulo.textContent = 'Inquilinos - Listado';
                document.getElementById('inquilinosListView').classList.remove('hidden');
                renderInquilinosTable();
            } else if (view === 'rentasRecibidas') {
                titulo.textContent = 'Inquilinos - Rentas Recibidas';
                document.getElementById('inquilinosRentasRecibidasView').classList.remove('hidden');
                populateInquilinosYearSelects();
                renderInquilinosRentasRecibidas();
            } else if (view === 'vencimientoContratos') {
                titulo.textContent = 'Inquilinos - Vencimiento Contratos';
                document.getElementById('inquilinosVencimientoContratosView').classList.remove('hidden');
                renderInquilinosVencimientoContratos();
            }
        }

        // Render Inquilinos table
        function renderInquilinosTable() {
            const tbody = document.getElementById('inquilinosTable').querySelector('tbody');
            tbody.innerHTML = '';
            
            inquilinos.forEach(inquilino => {
                const row = tbody.insertRow();
                row.style.cursor = 'pointer';
                row.onclick = () => showInquilinoDetail(inquilino.id);
                
                const contratoBtn = inquilino.contratoFile 
                    ? `<button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); viewContrato(${inquilino.id})">PDF</button>`
                    : '-';
                
                row.innerHTML = `
                    <td>${inquilino.nombre}</td>
                    <td class="currency">${formatCurrency(inquilino.renta)}</td>
                    <td>${formatDate(inquilino.fechaVencimiento)}</td>
                    <td>${contratoBtn}</td>
                `;
            });
            
            if (inquilinos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--text-light);">No hay inquilinos registrados</td></tr>';
            }
        }

        // Show add inquilino modal
        function showAddInquilinoModal() {
            document.getElementById('inquilinosDropdown').classList.remove('show');
            isEditMode = false;
            currentInquilinoId = null;
            document.getElementById('inquilinoModalTitle').textContent = 'Agregar Inquilino';
            document.getElementById('inquilinoForm').reset();
            document.getElementById('contratoFileName').textContent = '';
            document.getElementById('addInquilinoModal').classList.add('active');
        }

        // Show inquilino detail
        function showInquilinoDetail(id) {
            const inquilino = inquilinos.find(i => i.id === id);
            currentInquilinoId = id;
            
            document.getElementById('inquilinoDetailNombre').textContent = inquilino.nombre;
            document.getElementById('detailContacto').textContent = inquilino.contacto || '-';
            document.getElementById('detailTelefono').textContent = inquilino.telefono || '-';
            document.getElementById('detailEmail').textContent = inquilino.email || '-';
            document.getElementById('detailM2').textContent = inquilino.m2 || '-';
            document.getElementById('detailRenta').textContent = formatCurrency(inquilino.renta);
            document.getElementById('detailFechaInicio').textContent = formatDate(inquilino.fechaInicio);
            document.getElementById('detailFechaVenc').textContent = formatDate(inquilino.fechaVencimiento);
            
            // Render pagos
            const historialDiv = document.getElementById('historialPagos');
            if (inquilino.pagos && inquilino.pagos.length > 0) {
                historialDiv.innerHTML = inquilino.pagos.map(pago => `
                    <div class="payment-item">
                        <div>
                            <strong>${formatDate(pago.fecha)}</strong><br>
                            ${formatCurrency(pago.monto)}
                            ${pago.pagoFile ? ' 📄' : ''}
                        </div>
                        <div>
                            ${pago.pagoFile ? `<button class="btn btn-sm btn-primary" onclick="viewPagoPDF(${pago.id})">Ver PDF</button>` : ''}
                        </div>
                    </div>
                `).join('');
            } else {
                historialDiv.innerHTML = '<p style="color: var(--text-light); text-align: center;">No hay pagos registrados</p>';
            }
            
            document.getElementById('inquilinoDetailModal').classList.add('active');
        }

        // Edit inquilino
        function editInquilino() {
            const inquilino = inquilinos.find(i => i.id === currentInquilinoId);
            isEditMode = true;
            
            document.getElementById('inquilinoModalTitle').textContent = 'Editar Inquilino';
            document.getElementById('inquilinoNombre').value = inquilino.nombre;
            document.getElementById('inquilinoContacto').value = inquilino.contacto || '';
            document.getElementById('inquilinoTelefono').value = inquilino.telefono || '';
            document.getElementById('inquilinoEmail').value = inquilino.email || '';
            document.getElementById('inquilinoClabe').value = inquilino.clabe || '';
            document.getElementById('inquilinoRFC').value = inquilino.rfc || '';
            document.getElementById('inquilinoM2').value = inquilino.m2 || '';
            document.getElementById('inquilinoRenta').value = inquilino.renta;
            document.getElementById('inquilinoFechaInicio').value = inquilino.fechaInicio;
            document.getElementById('inquilinoFechaVenc').value = inquilino.fechaVencimiento;
            document.getElementById('inquilinoNotas').value = inquilino.notas || '';
            
            if (inquilino.contratoFileName) {
                document.getElementById('contratoFileName').textContent = inquilino.contratoFileName;
            }
            
            closeModal('inquilinoDetailModal');
            document.getElementById('addInquilinoModal').classList.add('active');
        }

        // Save inquilino
        async function saveInquilino(event) {
            event.preventDefault();
            showLoading();
            
            try {
                const contratoFile = document.getElementById('inquilinoContrato').files[0];
                let contratoData = null;
                let contratoFileName = null;
                
                if (contratoFile) {
                    contratoData = await fileToBase64(contratoFile);
                    contratoFileName = contratoFile.name;
                }
                
                const inquilinoData = {
                    nombre: document.getElementById('inquilinoNombre').value,
                    contacto: document.getElementById('inquilinoContacto').value,
                    telefono: document.getElementById('inquilinoTelefono').value,
                    email: document.getElementById('inquilinoEmail').value,
                    clabe: document.getElementById('inquilinoClabe').value,
                    rfc: document.getElementById('inquilinoRFC').value,
                    m2: document.getElementById('inquilinoM2').value,
                    renta: parseFloat(document.getElementById('inquilinoRenta').value),
                    fecha_inicio: document.getElementById('inquilinoFechaInicio').value,
                    fecha_vencimiento: document.getElementById('inquilinoFechaVenc').value,
                    notas: document.getElementById('inquilinoNotas').value,
                    contrato_file: contratoData,
                    contrato_filename: contratoFileName
                };
                
                if (isEditMode) {
                    const { error } = await supabaseClient
                        .from('inquilinos')
                        .update(inquilinoData)
                        .eq('id', currentInquilinoId);
                    
                    if (error) throw error;
                    console.log('✅ Inquilino actualizado');
                } else {
                    const { error } = await supabaseClient
                        .from('inquilinos')
                        .insert([inquilinoData]);
                    
                    if (error) throw error;
                    console.log('✅ Inquilino creado');
                }
                
                await loadInquilinos();
                renderInquilinosTable();
                closeModal('addInquilinoModal');
            } catch (error) {
                console.error('Error saving inquilino:', error);
                alert('Error al guardar el inquilino: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // Delete inquilino
        async function deleteInquilino() {
            if (!confirm('¿Estás seguro de eliminar este inquilino? Esta acción no se puede deshacer.')) {
                return;
            }
            
            showLoading();
            try {
                const { error } = await supabaseClient
                    .from('inquilinos')
                    .delete()
                    .eq('id', currentInquilinoId);
                
                if (error) throw error;
                
                await loadInquilinos();
                renderInquilinosTable();
                closeModal('inquilinoDetailModal');
                console.log('✅ Inquilino eliminado');
            } catch (error) {
                console.error('Error deleting inquilino:', error);
                alert('Error al eliminar el inquilino: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // Show registrar pago modal
        function showRegistrarPagoModal() {
            const inquilino = inquilinos.find(i => i.id === currentInquilinoId);
            document.getElementById('pagoMonto').value = inquilino.renta;
            document.getElementById('pagoFecha').value = new Date().toISOString().split('T')[0];
            document.getElementById('pagoPDFFileName').textContent = '';
            document.getElementById('registrarPagoModal').classList.add('active');
        }

        // Save pago renta
        async function savePagoRenta(event) {
            event.preventDefault();
            showLoading();
            
            try {
                const inquilino = inquilinos.find(i => i.id === currentInquilinoId);
                const pagoCompleto = document.getElementById('pagoCompleto').value === 'si';
                const monto = pagoCompleto ? inquilino.renta : parseFloat(document.getElementById('pagoMonto').value);
                
                const pagoFile = document.getElementById('pagoPDF').files[0];
                if (!pagoFile) {
                    alert('Por favor selecciona el PDF del comprobante de pago');
                    hideLoading();
                    return;
                }
                
                const pagoFileData = await fileToBase64(pagoFile);
                
                const { error } = await supabaseClient
                    .from('pagos_inquilinos')
                    .insert([{
                        inquilino_id: currentInquilinoId,
                        fecha: document.getElementById('pagoFecha').value,
                        monto: monto,
                        completo: pagoCompleto,
                        pago_file: pagoFileData,
                        pago_filename: pagoFile.name
                    }]);
                
                if (error) throw error;
                
                await loadInquilinos();
                showInquilinoDetail(currentInquilinoId);
                closeModal('registrarPagoModal');
                console.log('✅ Pago registrado');
            } catch (error) {
                console.error('Error saving pago:', error);
                alert('Error al guardar el pago: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // View contrato
        function viewContrato(id) {
            const inquilino = inquilinos.find(i => i.id === id);
            if (inquilino.contratoFile) {
                const newWindow = window.open();
                newWindow.document.write(`<iframe width='100%' height='100%' src='${inquilino.contratoFile}'></iframe>`);
            }
        }

        // View pago PDF
        function viewPagoPDF(pagoId) {
            const inquilino = inquilinos.find(i => i.id === currentInquilinoId);
            const pago = inquilino.pagos.find(p => p.id === pagoId);
            if (pago.pagoFile) {
                const newWindow = window.open();
                newWindow.document.write(`<iframe width='100%' height='100%' src='${pago.pagoFile}'></iframe>`);
            }
        }

        // Populate year selects for inquilinos
        function populateInquilinosYearSelects() {
            const currentYear = new Date().getFullYear();
            const select = document.getElementById('inquilinosRentasYear');
            select.innerHTML = '';
            for (let year = currentYear - 5; year <= currentYear + 1; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYear) option.selected = true;
                select.appendChild(option);
            }
        }

        // Render rentas recibidas
        function renderInquilinosRentasRecibidas() {
            const tbody = document.getElementById('inquilinosRentasRecibidasTable').querySelector('tbody');
            tbody.innerHTML = '';
            
            const filterType = document.getElementById('inquilinosRentasFilter').value;
            const year = parseInt(document.getElementById('inquilinosRentasYear').value);
            const monthSelect = document.getElementById('inquilinosRentasMonth');
            
            if (filterType === 'mensual') {
                monthSelect.classList.remove('hidden');
            } else {
                monthSelect.classList.add('hidden');
            }
            
            const month = filterType === 'mensual' ? parseInt(monthSelect.value) : null;
            
            const rentas = [];
            let totalPeriodo = 0;
            
            inquilinos.forEach(inquilino => {
                if (inquilino.pagos) {
                    inquilino.pagos.forEach(pago => {
                        const pagoDate = new Date(pago.fecha + 'T00:00:00');
                        if (pagoDate.getFullYear() === year) {
                            if (month === null || pagoDate.getMonth() === month) {
                                rentas.push({
                                    empresa: inquilino.nombre,
                                    monto: pago.monto,
                                    fecha: pago.fecha
                                });
                                totalPeriodo += pago.monto;
                            }
                        }
                    });
                }
            });
            
            rentas.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            
            rentas.forEach(renta => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${renta.empresa}</td>
                    <td class="currency">${formatCurrency(renta.monto)}</td>
                    <td>${formatDate(renta.fecha)}</td>
                `;
            });
            
            if (rentas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: var(--text-light);">No hay rentas recibidas en este período</td></tr>';
            } else {
                const rowSeparator = tbody.insertRow();
                rowSeparator.style.height = '10px';
                rowSeparator.innerHTML = '<td colspan="3" style="border: none;"></td>';
                
                const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                                   'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                
                if (filterType === 'mensual') {
                    const rowMes = tbody.insertRow();
                    rowMes.style.fontWeight = 'bold';
                    rowMes.style.backgroundColor = '#e6f2ff';
                    rowMes.innerHTML = `
                        <td style="text-align: right; padding: 1rem; font-size: 1.1rem;">TOTAL RECIBIDO EN ${monthNames[month].toUpperCase()} ${year}:</td>
                        <td class="currency" style="color: var(--primary); font-size: 1.2rem;">${formatCurrency(totalPeriodo)}</td>
                        <td></td>
                    `;
                }
                
                let totalAnual = 0;
                inquilinos.forEach(inquilino => {
                    if (inquilino.pagos) {
                        inquilino.pagos.forEach(pago => {
                            const pagoDate = new Date(pago.fecha + 'T00:00:00');
                            if (pagoDate.getFullYear() === year) {
                                totalAnual += pago.monto;
                            }
                        });
                    }
                });
                
                const rowAnual = tbody.insertRow();
                rowAnual.style.fontWeight = 'bold';
                rowAnual.style.backgroundColor = '#d4edda';
                rowAnual.innerHTML = `
                    <td style="text-align: right; padding: 1rem; font-size: 1.1rem;">TOTAL RECIBIDO EN ${year}:</td>
                    <td class="currency" style="color: var(--success); font-size: 1.2rem;">${formatCurrency(totalAnual)}</td>
                    <td></td>
                `;
            }
        }

        // Render vencimiento contratos
        function renderInquilinosVencimientoContratos() {
            const tbody = document.getElementById('inquilinosVencimientoContratosTable').querySelector('tbody');
            tbody.innerHTML = '';
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            inquilinos.forEach(inquilino => {
                const vencimiento = new Date(inquilino.fechaVencimiento + 'T00:00:00');
                const diffTime = vencimiento - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                let estado = '';
                let badgeClass = '';
                if (diffDays < 0) {
                    estado = 'Vencido';
                    badgeClass = 'badge-danger';
                } else if (diffDays <= 30) {
                    estado = 'Próximo a vencer';
                    badgeClass = 'badge-warning';
                } else {
                    estado = 'Vigente';
                    badgeClass = 'badge-success';
                }
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${inquilino.nombre}</td>
                    <td>${formatDate(inquilino.fechaInicio)}</td>
                    <td>${formatDate(inquilino.fechaVencimiento)}</td>
                    <td>${diffDays}</td>
                    <td><span class="badge ${badgeClass}">${estado}</span></td>
                `;
            });
            
            if (inquilinos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--text-light);">No hay contratos registrados</td></tr>';
            }
        }

        // Close modal
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // File to base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // File upload listeners
        document.addEventListener('DOMContentLoaded', function() {
            const inquilinoContrato = document.getElementById('inquilinoContrato');
            if (inquilinoContrato) {
                inquilinoContrato.addEventListener('change', function(e) {
                    if (e.target.files.length > 0) {
                        document.getElementById('contratoFileName').textContent = e.target.files[0].name;
                    }
                });
            }
            
            const pagoPDF = document.getElementById('pagoPDF');
            if (pagoPDF) {
                pagoPDF.addEventListener('change', function(e) {
                    if (e.target.files.length > 0) {
                        document.getElementById('pagoPDFFileName').textContent = e.target.files[0].name;
                    }
                });
            }
            
            const pagoCompleto = document.getElementById('pagoCompleto');
            if (pagoCompleto) {
                pagoCompleto.addEventListener('change', function() {
                    const montoGroup = document.getElementById('pagoMontoGroup');
                    if (this.value === 'no') {
                        montoGroup.classList.remove('hidden');
                        document.getElementById('pagoMonto').required = true;
                    } else {
                        montoGroup.classList.add('hidden');
                        document.getElementById('pagoMonto').required = false;
                    }
                });
            }
        });
        // INQUILINOS FUNCTIONS
        let currentInquilinoId = null;
        let isEditMode = false;

        // Toggle dropdown
        function toggleDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            document.querySelectorAll('.dropdown-content').forEach(dd => {
                if (dd.id !== dropdownId) {
                    dd.classList.remove('show');
                }
            });
            dropdown.classList.toggle('show');
        }

        // Close dropdown when clicking outside
        window.onclick = function(event) {
            if (!event.target.matches('.dropdown-toggle')) {
                document.querySelectorAll('.dropdown-content').forEach(dd => {
                    dd.classList.remove('show');
                });
            }
        }

        // Show Inquilinos views
        function showInquilinosView(view) {
            document.getElementById('inquilinosDropdown').classList.remove('show');
            
            document.getElementById('inquilinosListView').classList.add('hidden');
            document.getElementById('inquilinosRentasRecibidasView').classList.add('hidden');
            document.getElementById('inquilinosVencimientoContratosView').classList.add('hidden');
            
            const titulo = document.getElementById('inquilinosTitulo');
            
            if (view === 'list') {
                titulo.textContent = 'Inquilinos - Listado';
                document.getElementById('inquilinosListView').classList.remove('hidden');
                renderInquilinosTable();
            } else if (view === 'rentasRecibidas') {
                titulo.textContent = 'Inquilinos - Rentas Recibidas';
                document.getElementById('inquilinosRentasRecibidasView').classList.remove('hidden');
                populateInquilinosYearSelects();
                renderInquilinosRentasRecibidas();
            } else if (view === 'vencimientoContratos') {
                titulo.textContent = 'Inquilinos - Vencimiento Contratos';
                document.getElementById('inquilinosVencimientoContratosView').classList.remove('hidden');
                renderInquilinosVencimientoContratos();
            }
        }

        // Render Inquilinos table
        function renderInquilinosTable() {
            const tbody = document.getElementById('inquilinosTable').querySelector('tbody');
            tbody.innerHTML = '';
            
            inquilinos.forEach(inquilino => {
                const row = tbody.insertRow();
                row.style.cursor = 'pointer';
                row.onclick = () => showInquilinoDetail(inquilino.id);
                
                const contratoBtn = inquilino.contratoFile 
                    ? `<button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); viewContrato(${inquilino.id})">PDF</button>`
                    : '-';
                
                row.innerHTML = `
                    <td>${inquilino.nombre}</td>
                    <td class="currency">${formatCurrency(inquilino.renta)}</td>
                    <td>${formatDate(inquilino.fechaVencimiento)}</td>
                    <td>${contratoBtn}</td>
                `;
            });
            
            if (inquilinos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--text-light);">No hay inquilinos registrados</td></tr>';
            }
        }

        // Show add inquilino modal
        function showAddInquilinoModal() {
            document.getElementById('inquilinosDropdown').classList.remove('show');
            isEditMode = false;
            currentInquilinoId = null;
            document.getElementById('inquilinoModalTitle').textContent = 'Agregar Inquilino';
            document.getElementById('inquilinoForm').reset();
            document.getElementById('contratoFileName').textContent = '';
            document.getElementById('addInquilinoModal').classList.add('active');
        }

        // Show inquilino detail
        function showInquilinoDetail(id) {
            const inquilino = inquilinos.find(i => i.id === id);
            currentInquilinoId = id;
            
            document.getElementById('inquilinoDetailNombre').textContent = inquilino.nombre;
            document.getElementById('detailContacto').textContent = inquilino.contacto || '-';
            document.getElementById('detailTelefono').textContent = inquilino.telefono || '-';
            document.getElementById('detailEmail').textContent = inquilino.email || '-';
            document.getElementById('detailM2').textContent = inquilino.m2 || '-';
            document.getElementById('detailRenta').textContent = formatCurrency(inquilino.renta);
            document.getElementById('detailFechaInicio').textContent = formatDate(inquilino.fechaInicio);
            document.getElementById('detailFechaVenc').textContent = formatDate(inquilino.fechaVencimiento);
            
            // Render pagos
            const historialDiv = document.getElementById('historialPagos');
            if (inquilino.pagos && inquilino.pagos.length > 0) {
                historialDiv.innerHTML = inquilino.pagos.map(pago => `
                    <div class="payment-item">
                        <div>
                            <strong>${formatDate(pago.fecha)}</strong><br>
                            ${formatCurrency(pago.monto)}
                            ${pago.pagoFile ? ' 📄' : ''}
                        </div>
                        <div>
                            ${pago.pagoFile ? `<button class="btn btn-sm btn-primary" onclick="viewPagoPDF(${pago.id})">Ver PDF</button>` : ''}
                        </div>
                    </div>
                `).join('');
            } else {
                historialDiv.innerHTML = '<p style="color: var(--text-light); text-align: center;">No hay pagos registrados</p>';
            }
            
            document.getElementById('inquilinoDetailModal').classList.add('active');
        }

        // Edit inquilino
        function editInquilino() {
            const inquilino = inquilinos.find(i => i.id === currentInquilinoId);
            isEditMode = true;
            
            document.getElementById('inquilinoModalTitle').textContent = 'Editar Inquilino';
            document.getElementById('inquilinoNombre').value = inquilino.nombre;
            document.getElementById('inquilinoContacto').value = inquilino.contacto || '';
            document.getElementById('inquilinoTelefono').value = inquilino.telefono || '';
            document.getElementById('inquilinoEmail').value = inquilino.email || '';
            document.getElementById('inquilinoClabe').value = inquilino.clabe || '';
            document.getElementById('inquilinoRFC').value = inquilino.rfc || '';
            document.getElementById('inquilinoM2').value = inquilino.m2 || '';
            document.getElementById('inquilinoRenta').value = inquilino.renta;
            document.getElementById('inquilinoFechaInicio').value = inquilino.fechaInicio;
            document.getElementById('inquilinoFechaVenc').value = inquilino.fechaVencimiento;
            document.getElementById('inquilinoNotas').value = inquilino.notas || '';
            
            if (inquilino.contratoFileName) {
                document.getElementById('contratoFileName').textContent = inquilino.contratoFileName;
            }
            
            closeModal('inquilinoDetailModal');
            document.getElementById('addInquilinoModal').classList.add('active');
        }

        // Save inquilino
        async function saveInquilino(event) {
            event.preventDefault();
            showLoading();
            
            try {
                const contratoFile = document.getElementById('inquilinoContrato').files[0];
                let contratoData = null;
                let contratoFileName = null;
                
                if (contratoFile) {
                    contratoData = await fileToBase64(contratoFile);
                    contratoFileName = contratoFile.name;
                }
                
                const inquilinoData = {
                    nombre: document.getElementById('inquilinoNombre').value,
                    contacto: document.getElementById('inquilinoContacto').value,
                    telefono: document.getElementById('inquilinoTelefono').value,
                    email: document.getElementById('inquilinoEmail').value,
                    clabe: document.getElementById('inquilinoClabe').value,
                    rfc: document.getElementById('inquilinoRFC').value,
                    m2: document.getElementById('inquilinoM2').value,
                    renta: parseFloat(document.getElementById('inquilinoRenta').value),
                    fecha_inicio: document.getElementById('inquilinoFechaInicio').value,
                    fecha_vencimiento: document.getElementById('inquilinoFechaVenc').value,
                    notas: document.getElementById('inquilinoNotas').value,
                    contrato_file: contratoData,
                    contrato_filename: contratoFileName
                };
                
                if (isEditMode) {
                    const { error } = await supabaseClient
                        .from('inquilinos')
                        .update(inquilinoData)
                        .eq('id', currentInquilinoId);
                    
                    if (error) throw error;
                    console.log('✅ Inquilino actualizado');
                } else {
                    const { error } = await supabaseClient
                        .from('inquilinos')
                        .insert([inquilinoData]);
                    
                    if (error) throw error;
                    console.log('✅ Inquilino creado');
                }
                
                await loadInquilinos();
                renderInquilinosTable();
                closeModal('addInquilinoModal');
            } catch (error) {
                console.error('Error saving inquilino:', error);
                alert('Error al guardar el inquilino: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // Delete inquilino
        async function deleteInquilino() {
            if (!confirm('¿Estás seguro de eliminar este inquilino? Esta acción no se puede deshacer.')) {
                return;
            }
            
            showLoading();
            try {
                const { error } = await supabaseClient
                    .from('inquilinos')
                    .delete()
                    .eq('id', currentInquilinoId);
                
                if (error) throw error;
                
                await loadInquilinos();
                renderInquilinosTable();
                closeModal('inquilinoDetailModal');
                console.log('✅ Inquilino eliminado');
            } catch (error) {
                console.error('Error deleting inquilino:', error);
                alert('Error al eliminar el inquilino: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // Show registrar pago modal
        function showRegistrarPagoModal() {
            const inquilino = inquilinos.find(i => i.id === currentInquilinoId);
            document.getElementById('pagoMonto').value = inquilino.renta;
            document.getElementById('pagoFecha').value = new Date().toISOString().split('T')[0];
            document.getElementById('pagoPDFFileName').textContent = '';
            document.getElementById('registrarPagoModal').classList.add('active');
        }

        // Save pago renta
        async function savePagoRenta(event) {
            event.preventDefault();
            showLoading();
            
            try {
                const inquilino = inquilinos.find(i => i.id === currentInquilinoId);
                const pagoCompleto = document.getElementById('pagoCompleto').value === 'si';
                const monto = pagoCompleto ? inquilino.renta : parseFloat(document.getElementById('pagoMonto').value);
                
                const pagoFile = document.getElementById('pagoPDF').files[0];
                if (!pagoFile) {
                    alert('Por favor selecciona el PDF del comprobante de pago');
                    hideLoading();
                    return;
                }
                
                const pagoFileData = await fileToBase64(pagoFile);
                
                const { error } = await supabaseClient
                    .from('pagos_inquilinos')
                    .insert([{
                        inquilino_id: currentInquilinoId,
                        fecha: document.getElementById('pagoFecha').value,
                        monto: monto,
                        completo: pagoCompleto,
                        pago_file: pagoFileData,
                        pago_filename: pagoFile.name
                    }]);
                
                if (error) throw error;
                
                await loadInquilinos();
                showInquilinoDetail(currentInquilinoId);
                closeModal('registrarPagoModal');
                console.log('✅ Pago registrado');
            } catch (error) {
                console.error('Error saving pago:', error);
                alert('Error al guardar el pago: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // View contrato
        function viewContrato(id) {
            const inquilino = inquilinos.find(i => i.id === id);
            if (inquilino.contratoFile) {
                const newWindow = window.open();
                newWindow.document.write(`<iframe width='100%' height='100%' src='${inquilino.contratoFile}'></iframe>`);
            }
        }

        // View pago PDF
        function viewPagoPDF(pagoId) {
            const inquilino = inquilinos.find(i => i.id === currentInquilinoId);
            const pago = inquilino.pagos.find(p => p.id === pagoId);
            if (pago.pagoFile) {
                const newWindow = window.open();
                newWindow.document.write(`<iframe width='100%' height='100%' src='${pago.pagoFile}'></iframe>`);
            }
        }

        // Populate year selects for inquilinos
        function populateInquilinosYearSelects() {
            const currentYear = new Date().getFullYear();
            const select = document.getElementById('inquilinosRentasYear');
            select.innerHTML = '';
            for (let year = currentYear - 5; year <= currentYear + 1; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYear) option.selected = true;
                select.appendChild(option);
            }
        }

        // Render rentas recibidas
        function renderInquilinosRentasRecibidas() {
            const tbody = document.getElementById('inquilinosRentasRecibidasTable').querySelector('tbody');
            tbody.innerHTML = '';
            
            const filterType = document.getElementById('inquilinosRentasFilter').value;
            const year = parseInt(document.getElementById('inquilinosRentasYear').value);
            const monthSelect = document.getElementById('inquilinosRentasMonth');
            
            if (filterType === 'mensual') {
                monthSelect.classList.remove('hidden');
            } else {
                monthSelect.classList.add('hidden');
            }
            
            const month = filterType === 'mensual' ? parseInt(monthSelect.value) : null;
            
            const rentas = [];
            let totalPeriodo = 0;
            
            inquilinos.forEach(inquilino => {
                if (inquilino.pagos) {
                    inquilino.pagos.forEach(pago => {
                        const pagoDate = new Date(pago.fecha + 'T00:00:00');
                        if (pagoDate.getFullYear() === year) {
                            if (month === null || pagoDate.getMonth() === month) {
                                rentas.push({
                                    empresa: inquilino.nombre,
                                    monto: pago.monto,
                                    fecha: pago.fecha
                                });
                                totalPeriodo += pago.monto;
                            }
                        }
                    });
                }
            });
            
            rentas.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            
            rentas.forEach(renta => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${renta.empresa}</td>
                    <td class="currency">${formatCurrency(renta.monto)}</td>
                    <td>${formatDate(renta.fecha)}</td>
                `;
            });
            
            if (rentas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: var(--text-light);">No hay rentas recibidas en este período</td></tr>';
            } else {
                const rowSeparator = tbody.insertRow();
                rowSeparator.style.height = '10px';
                rowSeparator.innerHTML = '<td colspan="3" style="border: none;"></td>';
                
                const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                                   'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                
                if (filterType === 'mensual') {
                    const rowMes = tbody.insertRow();
                    rowMes.style.fontWeight = 'bold';
                    rowMes.style.backgroundColor = '#e6f2ff';
                    rowMes.innerHTML = `
                        <td style="text-align: right; padding: 1rem; font-size: 1.1rem;">TOTAL RECIBIDO EN ${monthNames[month].toUpperCase()} ${year}:</td>
                        <td class="currency" style="color: var(--primary); font-size: 1.2rem;">${formatCurrency(totalPeriodo)}</td>
                        <td></td>
                    `;
                }
                
                let totalAnual = 0;
                inquilinos.forEach(inquilino => {
                    if (inquilino.pagos) {
                        inquilino.pagos.forEach(pago => {
                            const pagoDate = new Date(pago.fecha + 'T00:00:00');
                            if (pagoDate.getFullYear() === year) {
                                totalAnual += pago.monto;
                            }
                        });
                    }
                });
                
                const rowAnual = tbody.insertRow();
                rowAnual.style.fontWeight = 'bold';
                rowAnual.style.backgroundColor = '#d4edda';
                rowAnual.innerHTML = `
                    <td style="text-align: right; padding: 1rem; font-size: 1.1rem;">TOTAL RECIBIDO EN ${year}:</td>
                    <td class="currency" style="color: var(--success); font-size: 1.2rem;">${formatCurrency(totalAnual)}</td>
                    <td></td>
                `;
            }
        }

        // Render vencimiento contratos
        function renderInquilinosVencimientoContratos() {
            const tbody = document.getElementById('inquilinosVencimientoContratosTable').querySelector('tbody');
            tbody.innerHTML = '';
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            inquilinos.forEach(inquilino => {
                const vencimiento = new Date(inquilino.fechaVencimiento + 'T00:00:00');
                const diffTime = vencimiento - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                let estado = '';
                let badgeClass = '';
                if (diffDays < 0) {
                    estado = 'Vencido';
                    badgeClass = 'badge-danger';
                } else if (diffDays <= 30) {
                    estado = 'Próximo a vencer';
                    badgeClass = 'badge-warning';
                } else {
                    estado = 'Vigente';
                    badgeClass = 'badge-success';
                }
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${inquilino.nombre}</td>
                    <td>${formatDate(inquilino.fechaInicio)}</td>
                    <td>${formatDate(inquilino.fechaVencimiento)}</td>
                    <td>${diffDays}</td>
                    <td><span class="badge ${badgeClass}">${estado}</span></td>
                `;
            });
            
            if (inquilinos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--text-light);">No hay contratos registrados</td></tr>';
            }
        }

        // Close modal
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // File to base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // File upload listeners
        document.addEventListener('DOMContentLoaded', function() {
            const inquilinoContrato = document.getElementById('inquilinoContrato');
            if (inquilinoContrato) {
                inquilinoContrato.addEventListener('change', function(e) {
                    if (e.target.files.length > 0) {
                        document.getElementById('contratoFileName').textContent = e.target.files[0].name;
                    }
                });
            }
            
            const pagoPDF = document.getElementById('pagoPDF');
            if (pagoPDF) {
                pagoPDF.addEventListener('change', function(e) {
                    if (e.target.files.length > 0) {
                        document.getElementById('pagoPDFFileName').textContent = e.target.files[0].name;
                    }
                });
            }
            
            const pagoCompleto = document.getElementById('pagoCompleto');
            if (pagoCompleto) {
                pagoCompleto.addEventListener('change', function() {
                    const montoGroup = document.getElementById('pagoMontoGroup');
                    if (this.value === 'no') {
                        montoGroup.classList.remove('hidden');
                        document.getElementById('pagoMonto').required = true;
                    } else {
                        montoGroup.classList.add('hidden');
                        document.getElementById('pagoMonto').required = false;
                    }
                });
            }
        });
        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 ESWU con Supabase iniciado');
            
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const username = document.getElementById('username').value;
                    if (username) {
                        login(username);
                    } else {
                        alert('Por favor seleccione un usuario');
                    }
                });
            }
        });
    </script>
    </body>
</html>
