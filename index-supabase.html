<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESWU - Complete</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary: #1a365d; --primary-dark: #0f2744; --secondary: #2c5282;
            --accent: #3182ce; --success: #38a169; --danger: #e53e3e; --warning: #dd6b20;
            --bg: #f7fafc; --card-bg: #ffffff; --text: #2d3748; --text-light: #718096;
            --border: #e2e8f0; --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); line-height: 1.6; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center; z-index: 10000; }
        .loading-overlay.hidden { display: none; }
        .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .login-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); }
        .login-container.hidden { display: none; }
        .login-box { background: white; padding: 3rem; border-radius: 12px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); width: 90%; max-width: 400px; }
        .login-box h1 { color: var(--primary); margin-bottom: 2rem; text-align: center; font-size: 2rem; }
        .app-container { display: none; min-height: 100vh; }
        .app-container.active { display: block; }
        .header { background: var(--primary); color: white; padding: 1rem 2rem; box-shadow: var(--shadow); display: flex; justify-content: space-between; align-items: center; }
        .header-title { font-size: 1.5rem; font-weight: 600; }
        .user-info { display: flex; align-items: center; gap: 1rem; }
        .user-name { font-weight: 500; }
        .nav { background: var(--card-bg); box-shadow: var(--shadow); padding: 0 2rem; }
        .nav-list { list-style: none; display: flex; gap: 2rem; }
        .nav-link { display: block; padding: 1rem 0; color: var(--text); text-decoration: none; font-weight: 500; transition: color 0.2s; border-bottom: 3px solid transparent; }
        .nav-link:hover, .nav-link.active { color: var(--primary); border-bottom-color: var(--primary); }
        .main-content { padding: 2rem; max-width: 1400px; margin: 0 auto; }
        .page { display: none; }
        .page.active { display: block; }
        .card { background: var(--card-bg); border-radius: 8px; box-shadow: var(--shadow); margin-bottom: 2rem; overflow: hidden; }
        .card-header { padding: 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .card-title { font-size: 1.5rem; color: var(--primary); font-weight: 600; }
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .summary-card { background: var(--card-bg); padding: 1.5rem; border-radius: 8px; box-shadow: var(--shadow); }
        .summary-label { color: var(--text-light); font-size: 0.875rem; margin-bottom: 0.5rem; }
        .summary-value { font-size: 2rem; font-weight: 600; color: var(--primary); }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        thead { background: var(--bg); }
        th { padding: 1rem; text-align: left; font-weight: 600; color: var(--text); border-bottom: 2px solid var(--border); }
        td { padding: 1rem; border-bottom: 1px solid var(--border); }
        tr:hover { background: var(--bg); }
        .currency { text-align: right; font-variant-numeric: tabular-nums; }
        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 6px; font-size: 1rem; font-weight: 500; cursor: pointer; transition: all 0.2s; text-decoration: none; display: inline-block; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { filter: brightness(1.1); }
        .btn-secondary { background: var(--text-light); color: white; }
        .btn-secondary:hover { filter: brightness(0.9); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { filter: brightness(1.1); }
        .btn-sm { padding: 0.5rem 1rem; font-size: 0.875rem; }
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text); }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 6px; font-size: 1rem; font-family: inherit; transition: border-color 0.2s; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--primary); }
        .form-group textarea { resize: vertical; min-height: 100px; }
        .filter-section { display: flex; gap: 1rem; margin-bottom: 1.5rem; align-items: center; flex-wrap: wrap; }
        .filter-section label { font-weight: 500; }
        .filter-section select { padding: 0.5rem 1rem; border: 2px solid var(--border); border-radius: 6px; font-size: 1rem; }
        .hidden { display: none !important; }
        .tables-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 2rem; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000; overflow-y: auto; }
        .modal.active { display: flex; align-items: center; justify-content: center; padding: 2rem; }
        .modal-content { background: white; border-radius: 12px; width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); }
        .modal-header { padding: 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-size: 1.5rem; color: var(--primary); font-weight: 600; }
        .close-modal { background: none; border: none; font-size: 2rem; color: var(--text-light); cursor: pointer; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; }
        .close-modal:hover { color: var(--text); }
        .modal-content form { padding: 1.5rem; }
        .modal-actions { padding: 1.5rem; border-top: 1px solid var(--border); display: flex; gap: 1rem; justify-content: flex-end; }
        .file-upload { border: 2px dashed var(--border); border-radius: 6px; padding: 2rem; text-align: center; cursor: pointer; transition: all 0.2s; }
        .file-upload:hover { border-color: var(--primary); background: var(--bg); }
        .file-upload input[type="file"] { display: none; }
        .info-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1rem; }
        .info-item { padding: 0.75rem; background: var(--bg); border-radius: 6px; }
        .info-label { font-size: 0.875rem; color: var(--text-light); margin-bottom: 0.25rem; }
        .info-value { font-weight: 600; color: var(--text); }
        .payment-item { display: flex; justify-content: space-between; padding: 1rem; border-bottom: 1px solid var(--border); transition: background 0.2s; }
        .payment-item:hover { background: var(--bg); }
        .badge { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.875rem; font-weight: 500; }
        .badge-success { background: #c6f6d5; color: #22543d; }
        .badge-warning { background: #feebc8; color: #7c2d12; }
        .badge-danger { background: #fed7d7; color: #742a2a; }
        .dropdown { position: relative; display: inline-block; }
        .dropdown-toggle { background: var(--primary); color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 6px; cursor: pointer; font-size: 1.2rem; font-weight: 500; }
        .dropdown-toggle:hover { background: var(--primary-dark); }
        .dropdown-content { display: none; position: absolute; right: 0; background: white; min-width: 220px; box-shadow: 0 8px 16px rgba(0,0,0,0.2); z-index: 1000; border-radius: 6px; overflow: hidden; margin-top: 0.5rem; }
        .dropdown-content.show { display: block; }
        .dropdown-content a { color: var(--text); padding: 12px 16px; text-decoration: none; display: block; transition: background 0.2s; }
        .dropdown-content a:hover { background: var(--bg); }
        @media (max-width: 768px) {
            .header { flex-direction: column; gap: 1rem; }
            .nav-list { flex-direction: column; gap: 0; }
            .nav-link { padding: 0.75rem 0; }
            .main-content { padding: 1rem; }
            .summary-grid, .tables-grid { grid-template-columns: 1fr; }
            .info-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div id="loadingOverlay" class="loading-overlay hidden"><div class="loading-spinner"></div></div>
    <div id="loginContainer" class="login-container">
        <div class="login-box">
            <h1>ESWU</h1>
            <form id="loginForm">
                <div class="form-group">
                    <label>Seleccione Usuario</label>
                    <select id="username" required style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 6px;">
                        <option value="">-- Seleccione un usuario --</option>
                        <option value="Anabel">Anabel</option>
                        <option value="Doris">Doris</option>
                        <option value="Miguel">Miguel</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Iniciar Sesión</button>
            </form>
        </div>
    </div>
    <div id="appContainer" class="app-container">
        <div class="header">
            <div class="header-title">ESWU - Sistema Completo</div>
            <div class="user-info">
                <span class="user-name" id="currentUser"></span>
                <button onclick="logout()" class="btn btn-secondary btn-sm">Salir</button>
            </div>
        </div>
        <nav class="nav">
            <ul class="nav-list">
                <li class="nav-item"><a href="#" class="nav-link active" onclick="showPage('home')">Home</a></li>
                <li class="nav-item"><a href="#" class="nav-link" onclick="showPage('inquilinos')">Inquilinos</a></li>
                <li class="nav-item"><a href="#" class="nav-link" onclick="showPage('proveedores')">Proveedores</a></li>
                <li class="nav-item"><a href="#" class="nav-link" onclick="showPage('activos')">Activos</a></li>
            </ul>
        </nav>
        <div class="main-content">
            <div id="homePage" class="page active">
                <div class="summary-grid">
                    <div class="summary-card"><div class="summary-label">Ingresos</div><div class="summary-value currency" id="summaryIngresos">$0</div></div>
                    <div class="summary-card"><div class="summary-label">Gastos</div><div class="summary-value currency" id="summaryGastos">$0</div></div>
                    <div class="summary-card"><div class="summary-label">Ingreso Neto</div><div class="summary-value currency" id="summaryNeto">$0</div></div>
                </div>
                <div class="filter-section">
                    <label>Ver por:</label>
                    <select id="homeFilter" onchange="updateHomeView()"><option value="anual">Anual</option><option value="mensual">Mensual</option></select>
                    <select id="homeYear" onchange="updateHomeView()"></select>
                    <select id="homeMonth" onchange="updateHomeView()" class="hidden">
                        <option value="0">Enero</option><option value="1">Febrero</option><option value="2">Marzo</option><option value="3">Abril</option>
                        <option value="4">Mayo</option><option value="5">Junio</option><option value="6">Julio</option><option value="7">Agosto</option>
                        <option value="8">Septiembre</option><option value="9">Octubre</option><option value="10">Noviembre</option><option value="11">Diciembre</option>
                    </select>
                </div>
                <div class="tables-grid">
                    <div class="card">
                        <div class="card-header"><h2 class="card-title">Ingresos por Renta</h2></div>
                        <div class="table-container"><table id="homeIngresosTable"><thead><tr><th>Inquilino</th><th>Fecha</th><th>Monto</th></tr></thead><tbody></tbody></table></div>
                    </div>
                    <div class="card">
                        <div class="card-header"><h2 class="card-title">Gastos</h2></div>
                        <div class="table-container"><table id="homeGastosTable"><thead><tr><th>Proveedor</th><th>Fecha</th><th>Monto</th></tr></thead><tbody></tbody></table></div>
                    </div>
                </div>
            </div>
            <div id="inquilinosPage" class="page">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title" id="inquilinosTitulo">Inquilinos - Listado</h2>
                        <div class="dropdown">
                            <button class="dropdown-toggle" onclick="toggleDropdown('inquilinosDropdown')">☰</button>
                            <div id="inquilinosDropdown" class="dropdown-content">
                                <a href="#" onclick="event.preventDefault(); showInquilinosView('list');">Listado</a>
                                <a href="#" onclick="event.preventDefault(); showAddInquilinoModal();">Agregar Inquilino</a>
                                <a href="#" onclick="event.preventDefault(); showInquilinosView('rentasRecibidas');">Rentas Recibidas</a>
                                <a href="#" onclick="event.preventDefault(); showInquilinosView('vencimientoContratos');">Vencimiento Contratos</a>
                            </div>
                        </div>
                    </div>
                    <div id="inquilinosListView">
                        <div class="table-container">
                            <table id="inquilinosTable">
                                <thead><tr><th>Empresa</th><th>Renta Mensual</th><th>Vencimiento Contrato</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                    <div id="inquilinosRentasRecibidasView" class="hidden">
                        <div style="padding: 1rem;">
                            <div class="filter-section">
                                <select id="inquilinosRentasFilter" onchange="renderInquilinosRentasRecibidas()"><option value="anual">Anual</option><option value="mensual">Mensual</option></select>
                                <select id="inquilinosRentasYear" onchange="renderInquilinosRentasRecibidas()"></select>
                                <select id="inquilinosRentasMonth" onchange="renderInquilinosRentasRecibidas()" class="hidden">
                                    <option value="0">Enero</option><option value="1">Febrero</option><option value="2">Marzo</option><option value="3">Abril</option>
                                    <option value="4">Mayo</option><option value="5">Junio</option><option value="6">Julio</option><option value="7">Agosto</option>
                                    <option value="8">Septiembre</option><option value="9">Octubre</option><option value="10">Noviembre</option><option value="11">Diciembre</option>
                                </select>
                            </div>
                            <div class="table-container">
                                <table id="inquilinosRentasRecibidasTable">
                                    <thead><tr><th>Empresa</th><th>Renta Recibida</th><th>Fecha de Pago</th></tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div id="inquilinosVencimientoContratosView" class="hidden">
                        <div style="padding: 1rem;">
                            <div class="table-container">
                                <table id="inquilinosVencimientoContratosTable">
                                    <thead><tr><th>Inquilino</th><th>Fecha Inicio</th><th>Fecha Vencimiento</th><th>Días Restantes</th><th>Estado</th></tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="proveedoresPage" class="page">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Proveedores</h2>
                        <button onclick="showAddProveedorModal()" class="btn btn-success">+ Agregar Proveedor</button>
                    </div>
                    <div class="table-container">
                        <table id="proveedoresTable">
                            <thead><tr><th>Nombre</th><th>Servicio</th><th>Contacto</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div id="activosPage" class="page">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Activos</h2>
                        <button onclick="showAddActivoModal()" class="btn btn-success">+ Agregar Activo</button>
                    </div>
                    <div class="table-container">
                        <table id="activosTable">
                            <thead><tr><th>Nombre</th><th>Último Mantenimiento</th><th>Próximo Mantenimiento</th><th>Proveedor</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div id="addInquilinoModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title" id="addInquilinoTitle">Agregar Inquilino</h2>
                        <button class="close-modal" onclick="closeModal('addInquilinoModal')">×</button>
                    </div>
                    <form id="inquilinoForm" onsubmit="saveInquilino(event)">
                        <div class="form-group"><label>Nombre de la Empresa *</label><input type="text" id="inquilinoNombre" required></div>
                        <div class="form-group"><label>Contacto *</label><input type="text" id="inquilinoContacto" required></div>
                        <div class="form-group"><label>Teléfono</label><input type="tel" id="inquilinoTelefono"></div>
                        <div class="form-group"><label>Email</label><input type="email" id="inquilinoEmail"></div>
                        <div class="form-group"><label>Renta Mensual *</label><input type="number" id="inquilinoRenta" step="0.01" required></div>
                        <div class="form-group"><label>Fecha Inicio Contrato *</label><input type="date" id="inquilinoFechaInicio" required></div>
                        <div class="form-group"><label>Fecha Vencimiento Contrato *</label><input type="date" id="inquilinoFechaVenc" required></div>
                        <div class="modal-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeModal('addInquilinoModal')">Cancelar</button>
                            <button type="submit" class="btn btn-success">Guardar</button>
                        </div>
                    </form>
                </div>
            </div>
            <div id="inquilinoDetailModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title" id="inquilinoDetailNombre"></h2>
                        <button class="close-modal" onclick="closeModal('inquilinoDetailModal')">×</button>
                    </div>
                    <div style="padding: 1.5rem;">
                        <div class="info-grid">
                            <div class="info-item"><div class="info-label">Contacto</div><div class="info-value" id="detailContacto"></div></div>
                            <div class="info-item"><div class="info-label">Teléfono</div><div class="info-value" id="detailTelefono"></div></div>
                            <div class="info-item"><div class="info-label">Email</div><div class="info-value" id="detailEmail"></div></div>
                            <div class="info-item"><div class="info-label">Renta Mensual</div><div class="info-value currency" id="detailRenta"></div></div>
                            <div class="info-item"><div class="info-label">Fecha Inicio</div><div class="info-value" id="detailFechaInicio"></div></div>
                            <div class="info-item"><div class="info-label">Fecha Vencimiento</div><div class="info-value" id="detailFechaVenc"></div></div>
                        </div>
                        <h3 style="margin: 1.5rem 0 1rem 0;">Historial de Pagos</h3>
                        <div id="historialPagos"></div>
                        <div class="modal-actions" style="margin-top: 1.5rem;">
                            <button class="btn btn-primary" onclick="editInquilino()">Editar</button>
                            <button class="btn btn-success" onclick="showRegistrarPagoModal()">Registrar Pago</button>
                            <button class="btn btn-danger" onclick="deleteInquilino()">Eliminar</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="registrarPagoModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title">Registrar Pago de Renta</h2>
                        <button class="close-modal" onclick="closeModal('registrarPagoModal')">×</button>
                    </div>
                    <form onsubmit="savePagoRenta(event)">
                        <div style="padding: 1.5rem;">
                            <div class="form-group"><label>Fecha de Pago *</label><input type="date" id="pagoFecha" required></div>
                            <div class="form-group">
                                <label>¿Pago Completo? *</label>
                                <select id="pagoCompleto" onchange="toggleMontoInput()">
                                    <option value="si">Sí</option>
                                    <option value="no">No</option>
                                </select>
                            </div>
                            <div class="form-group hidden" id="pagoMontoGroup">
                                <label>Monto Pagado *</label>
                                <input type="number" id="pagoMonto" step="0.01">
                            </div>
                        </div>
                        <div class="modal-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeModal('registrarPagoModal')">Cancelar</button>
                            <button type="submit" class="btn btn-success">Guardar Pago</button>
                        </div>
                    </form>
                </div>
            </div>
            <div id="addProveedorModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title" id="addProveedorTitle">Agregar Proveedor</h2>
                        <button class="close-modal" onclick="closeModal('addProveedorModal')">×</button>
                    </div>
                    <form id="proveedorForm" onsubmit="saveProveedor(event)">
                        <div class="form-group"><label>Nombre *</label><input type="text" id="proveedorNombre" required></div>
                        <div class="form-group"><label>Servicio *</label><input type="text" id="proveedorServicio" required></div>
                        <div class="form-group"><label>Contacto *</label><input type="text" id="proveedorContacto" required></div>
                        <div class="form-group"><label>Teléfono</label><input type="tel" id="proveedorTelefono"></div>
                        <div class="form-group"><label>Email</label><input type="email" id="proveedorEmail"></div>
                        <div class="modal-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeModal('addProveedorModal')">Cancelar</button>
                            <button type="submit" class="btn btn-success">Guardar</button>
                        </div>
                    </form>
                </div>
            </div>
            <div id="proveedorDetailModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title" id="proveedorDetailNombre"></h2>
                        <button class="close-modal" onclick="closeModal('proveedorDetailModal')">×</button>
                    </div>
                    <div style="padding: 1.5rem;">
                        <div class="info-grid">
                            <div class="info-item"><div class="info-label">Servicio</div><div class="info-value" id="detailServicio"></div></div>
                            <div class="info-item"><div class="info-label">Contacto</div><div class="info-value" id="detailProvContacto"></div></div>
                            <div class="info-item"><div class="info-label">Teléfono</div><div class="info-value" id="detailProvTelefono"></div></div>
                            <div class="info-item"><div class="info-label">Email</div><div class="info-value" id="detailProvEmail"></div></div>
                        </div>
                        <h3 style="margin: 1.5rem 0 1rem 0;">Facturas</h3>
                        <div id="historialFacturas"></div>
                        <div class="modal-actions" style="margin-top: 1.5rem;">
                            <button class="btn btn-primary" onclick="editProveedor()">Editar</button>
                            <button class="btn btn-success" onclick="showRegistrarFacturaModal()">Registrar Factura</button>
                            <button class="btn btn-danger" onclick="deleteProveedor()">Eliminar</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="registrarFacturaModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title">Registrar Factura</h2>
                        <button class="close-modal" onclick="closeModal('registrarFacturaModal')">×</button>
                    </div>
                    <form onsubmit="saveFactura(event)">
                        <div style="padding: 1.5rem;">
                            <div class="form-group"><label>Número de Factura</label><input type="text" id="facturaNumero"></div>
                            <div class="form-group"><label>Fecha *</label><input type="date" id="facturaFecha" required></div>
                            <div class="form-group"><label>Vencimiento *</label><input type="date" id="facturaVencimiento" required></div>
                            <div class="form-group"><label>Monto *</label><input type="number" id="facturaMonto" step="0.01" required></div>
                        </div>
                        <div class="modal-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeModal('registrarFacturaModal')">Cancelar</button>
                            <button type="submit" class="btn btn-success">Guardar</button>
                        </div>
                    </form>
                </div>
            </div>
            <div id="pagarFacturaModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title">Registrar Pago de Factura</h2>
                        <button class="close-modal" onclick="closeModal('pagarFacturaModal')">×</button>
                    </div>
                    <form onsubmit="savePagoFactura(event)">
                        <div style="padding: 1.5rem;">
                            <div class="form-group"><label>Fecha de Pago *</label><input type="date" id="fechaPagoFactura" required></div>
                        </div>
                        <div class="modal-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeModal('pagarFacturaModal')">Cancelar</button>
                            <button type="submit" class="btn btn-success">Guardar Pago</button>
                        </div>
                    </form>
                </div>
            </div>
            <div id="addActivoModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title" id="addActivoTitle">Agregar Activo</h2>
                        <button class="close-modal" onclick="closeModal('addActivoModal')">×</button>
                    </div>
                    <form id="activoForm" onsubmit="saveActivo(event)">
                        <div class="form-group"><label>Nombre *</label><input type="text" id="activoNombre" required></div>
                        <div class="form-group"><label>Último Mantenimiento</label><input type="date" id="activoUltimoMant"></div>
                        <div class="form-group"><label>Próximo Mantenimiento</label><input type="date" id="activoProximoMant"></div>
                        <div class="form-group"><label>Proveedor</label><input type="text" id="activoProveedor"></div>
                        <div class="form-group"><label>Notas</label><textarea id="activoNotas"></textarea></div>
                        <div class="modal-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeModal('addActivoModal')">Cancelar</button>
                            <button type="submit" class="btn btn-success">Guardar</button>
                        </div>
                    </form>
                </div>
            </div>
            <div id="activoDetailModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title" id="activoDetailNombre"></h2>
                        <button class="close-modal" onclick="closeModal('activoDetailModal')">×</button>
                    </div>
                    <div style="padding: 1.5rem;">
                        <div class="info-grid">
                            <div class="info-item"><div class="info-label">Último Mantenimiento</div><div class="info-value" id="detailUltimoMant"></div></div>
                            <div class="info-item"><div class="info-label">Próximo Mantenimiento</div><div class="info-value" id="detailProximoMant"></div></div>
                            <div class="info-item"><div class="info-label">Proveedor</div><div class="info-value" id="detailActivoProveedor"></div></div>
                        </div>
                        <div class="info-item" style="margin-top: 1rem;"><div class="info-label">Notas</div><div class="info-value" id="detailActivoNotas"></div></div>
                        <div class="modal-actions" style="margin-top: 1.5rem;">
                            <button class="btn btn-primary" onclick="editActivo()">Editar</button>
                            <button class="btn btn-danger" onclick="deleteActivo()">Eliminar</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        const SUPABASE_URL = 'https://tzuvoceilkqurnujrraq.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR6dXZvY2VpbGtxdXJudWpycmFxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1Mjg3NDIsImV4cCI6MjA4NTEwNDc0Mn0.2bGNuh7nVhAFGULlXBT85wsKUMgJJbEEGtUq0jerqno';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let currentUser = '';
        let inquilinos = [];
        let proveedores = [];
        let activos = [];
        let currentInquilinoId = null;
        let currentProveedorId = null;
        let currentActivoId = null;
        let currentFacturaId = null;
        let isEditMode = false;

        function showLoading() { document.getElementById('loadingOverlay').classList.remove('hidden'); }
        function hideLoading() { document.getElementById('loadingOverlay').classList.add('hidden'); }

        function login(username) {
            if (!username) { alert('Seleccione un usuario'); return; }
            currentUser = username;
            document.getElementById('currentUser').textContent = username;
            document.getElementById('loginContainer').classList.add('hidden');
            document.getElementById('appContainer').classList.add('active');
            setTimeout(() => loadAllData(), 100);
        }

        function logout() {
            currentUser = '';
            document.getElementById('username').value = '';
            document.getElementById('loginContainer').classList.remove('hidden');
            document.getElementById('appContainer').classList.remove('active');
        }

        function showPage(pageName) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.getElementById(pageName + 'Page').classList.add('active');
            event.target.classList.add('active');
            if (pageName === 'home') updateHomeView();
            if (pageName === 'inquilinos') { showInquilinosView('list'); }
            if (pageName === 'proveedores') renderProveedoresTable();
            if (pageName === 'activos') renderActivosTable();
        }

        async function loadAllData() {
            showLoading();
            try {
                await Promise.all([loadInquilinos(), loadProveedores(), loadActivos()]);
                populateYearSelect();
                populateInquilinosYearSelects();
                updateHomeView();
                console.log('✅ Datos cargados:', inquilinos.length, 'inquilinos,', proveedores.length, 'proveedores,', activos.length, 'activos');
            } catch (error) {
                console.error('❌ Error:', error);
                alert('Error al cargar datos');
            } finally {
                hideLoading();
            }
        }

        async function loadInquilinos() {
            try {
                const { data, error } = await supabaseClient.from('inquilinos').select('*, pagos_inquilinos(*)').order('nombre');
                if (error) throw error;
                inquilinos = data.map(inq => ({
                    id: inq.id, nombre: inq.nombre, contacto: inq.contacto, telefono: inq.telefono,
                    email: inq.email, clabe: inq.clabe, rfc: inq.rfc, m2: inq.m2,
                    renta: parseFloat(inq.renta || 0), fechaInicio: inq.fecha_inicio,
                    fechaVencimiento: inq.fecha_vencimiento, notas: inq.notas,
                    contratoFile: inq.contrato_file, contratoFileName: inq.contrato_filename,
                    pagos: inq.pagos_inquilinos ? inq.pagos_inquilinos.map(p => ({
                        id: p.id, fecha: p.fecha, monto: parseFloat(p.monto),
                        completo: p.completo, pagoFile: p.pago_file, pagoFileName: p.pago_filename
                    })).sort((a, b) => new Date(b.fecha) - new Date(a.fecha)) : []
                }));
            } catch (error) { console.error('Error loading inquilinos:', error); throw error; }
        }

        async function loadProveedores() {
            try {
                const { data, error } = await supabaseClient.from('proveedores').select('*, facturas(*)').order('nombre');
                if (error) throw error;
                proveedores = data.map(prov => ({
                    id: prov.id, nombre: prov.nombre, servicio: prov.servicio, contacto: prov.contacto,
                    telefono: prov.telefono, email: prov.email, clabe: prov.clabe, rfc: prov.rfc, notas: prov.notas,
                    facturas: prov.facturas ? prov.facturas.map(f => ({
                        id: f.id, numero: f.numero, fecha: f.fecha, vencimiento: f.vencimiento,
                        monto: parseFloat(f.monto), fechaPago: f.fecha_pago,
                        documentoFile: f.documento_file, documentoFileName: f.documento_filename,
                        pagoFile: f.pago_file, pagoFileName: f.pago_filename
                    })).sort((a, b) => new Date(b.fecha) - new Date(a.fecha)) : []
                }));
            } catch (error) { console.error('Error loading proveedores:', error); throw error; }
        }

        async function loadActivos() {
            try {
                const { data, error } = await supabaseClient.from('activos').select('*, activos_fotos(*)').order('nombre');
                if (error) throw error;
                activos = data.map(act => ({
                    id: act.id, nombre: act.nombre, ultimoMant: act.ultimo_mant,
                    proximoMant: act.proximo_mant, proveedor: act.proveedor, notas: act.notas,
                    fotos: act.activos_fotos ? act.activos_fotos.map(f => ({ id: f.id, data: f.foto_data, name: f.foto_name })) : []
                }));
            } catch (error) { console.error('Error loading activos:', error); throw error; }
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(amount);
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString + 'T00:00:00');
            const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
            return `${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear()}`;
        }

        function populateYearSelect() {
            const currentYear = new Date().getFullYear();
            const yearSelect = document.getElementById('homeYear');
            yearSelect.innerHTML = '';
            for (let year = currentYear - 5; year <= currentYear + 1; year++) {
                const option = document.createElement('option');
                option.value = year; option.textContent = year;
                if (year === currentYear) option.selected = true;
                yearSelect.appendChild(option);
            }
        }

        function populateInquilinosYearSelects() {
            const currentYear = new Date().getFullYear();
            const select = document.getElementById('inquilinosRentasYear');
            select.innerHTML = '';
            for (let year = currentYear - 5; year <= currentYear + 1; year++) {
                const option = document.createElement('option');
                option.value = year; option.textContent = year;
                if (year === currentYear) option.selected = true;
                select.appendChild(option);
            }
        }

        function updateHomeView() {
            const filterType = document.getElementById('homeFilter').value;
            const year = parseInt(document.getElementById('homeYear').value);
            const monthSelect = document.getElementById('homeMonth');
            
            if (filterType === 'mensual') monthSelect.classList.remove('hidden');
            else monthSelect.classList.add('hidden');
            
            const month = filterType === 'mensual' ? parseInt(monthSelect.value) : null;
            let totalIngresos = 0, totalGastos = 0;
            
            inquilinos.forEach(inq => {
                if (inq.pagos) {
                    inq.pagos.forEach(pago => {
                        const pd = new Date(pago.fecha + 'T00:00:00');
                        if (pd.getFullYear() === year && (month === null || pd.getMonth() === month)) totalIngresos += pago.monto;
                    });
                }
            });
            
            proveedores.forEach(prov => {
                if (prov.facturas) {
                    prov.facturas.forEach(fact => {
                        if (fact.fechaPago) {
                            const pd = new Date(fact.fechaPago + 'T00:00:00');
                            if (pd.getFullYear() === year && (month === null || pd.getMonth() === month)) totalGastos += fact.monto;
                        }
                    });
                }
            });
            
            document.getElementById('summaryIngresos').textContent = formatCurrency(totalIngresos);
            document.getElementById('summaryGastos').textContent = formatCurrency(totalGastos);
            document.getElementById('summaryNeto').textContent = formatCurrency(totalIngresos - totalGastos);
            
            renderHomeIngresos(year, month);
            renderHomeGastos(year, month);
        }

        function renderHomeIngresos(year, month) {
            const tbody = document.getElementById('homeIngresosTable').querySelector('tbody');
            tbody.innerHTML = '';
            const pagos = [];
            let total = 0;
            
            inquilinos.forEach(inq => {
                if (inq.pagos) {
                    inq.pagos.forEach(pago => {
                        const pd = new Date(pago.fecha + 'T00:00:00');
                        if (pd.getFullYear() === year && (month === null || pd.getMonth() === month)) {
                            pagos.push({ inquilino: inq.nombre, fecha: pago.fecha, monto: pago.monto });
                            total += pago.monto;
                        }
                    });
                }
            });
            
            pagos.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            pagos.forEach(p => {
                const row = tbody.insertRow();
                row.innerHTML = `<td>${p.inquilino}</td><td>${formatDate(p.fecha)}</td><td class="currency">${formatCurrency(p.monto)}</td>`;
            });
            
            if (pagos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:var(--text-light)">No hay ingresos</td></tr>';
            } else {
                const row = tbody.insertRow();
                row.style.fontWeight = 'bold'; row.style.backgroundColor = '#d4edda';
                row.innerHTML = `<td colspan="2" style="text-align:right;padding:1rem">TOTAL:</td><td class="currency" style="color:var(--success);font-size:1.1rem">${formatCurrency(total)}</td>`;
            }
        }

        function renderHomeGastos(year, month) {
            const tbody = document.getElementById('homeGastosTable').querySelector('tbody');
            tbody.innerHTML = '';
            const gastos = [];
            let total = 0;
            
            proveedores.forEach(prov => {
                if (prov.facturas) {
                    prov.facturas.forEach(fact => {
                        if (fact.fechaPago) {
                            const pd = new Date(fact.fechaPago + 'T00:00:00');
                            if (pd.getFullYear() === year && (month === null || pd.getMonth() === month)) {
                                gastos.push({ proveedor: prov.nombre, fecha: fact.fechaPago, monto: fact.monto });
                                total += fact.monto;
                            }
                        }
                    });
                }
            });
            
            gastos.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            gastos.forEach(g => {
                const row = tbody.insertRow();
                row.innerHTML = `<td>${g.proveedor}</td><td>${formatDate(g.fecha)}</td><td class="currency">${formatCurrency(g.monto)}</td>`;
            });
            
            if (gastos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:var(--text-light)">No hay gastos</td></tr>';
            } else {
                const row = tbody.insertRow();
                row.style.fontWeight = 'bold'; row.style.backgroundColor = '#fed7d7';
                row.innerHTML = `<td colspan="2" style="text-align:right;padding:1rem">TOTAL:</td><td class="currency" style="color:var(--danger);font-size:1.1rem">${formatCurrency(total)}</td>`;
            }
        }

        function toggleDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            document.querySelectorAll('.dropdown-content').forEach(dd => {
                if (dd.id !== dropdownId) dd.classList.remove('show');
            });
            dropdown.classList.toggle('show');
        }

        window.onclick = function(event) {
            if (!event.target.matches('.dropdown-toggle')) {
                document.querySelectorAll('.dropdown-content').forEach(dd => dd.classList.remove('show'));
            }
        }

        function showInquilinosView(view) {
            document.getElementById('inquilinosDropdown').classList.remove('show');
            document.getElementById('inquilinosListView').classList.add('hidden');
            document.getElementById('inquilinosRentasRecibidasView').classList.add('hidden');
            document.getElementById('inquilinosVencimientoContratosView').classList.add('hidden');
            
            const titulo = document.getElementById('inquilinosTitulo');
            if (view === 'list') {
                titulo.textContent = 'Inquilinos - Listado';
                document.getElementById('inquilinosListView').classList.remove('hidden');
                renderInquilinosTable();
            } else if (view === 'rentasRecibidas') {
                titulo.textContent = 'Inquilinos - Rentas Recibidas';
                document.getElementById('inquilinosRentasRecibidasView').classList.remove('hidden');
                renderInquilinosRentasRecibidas();
            } else if (view === 'vencimientoContratos') {
                titulo.textContent = 'Inquilinos - Vencimiento Contratos';
                document.getElementById('inquilinosVencimientoContratosView').classList.remove('hidden');
                renderInquilinosVencimientoContratos();
            }
        }

        function renderInquilinosTable() {
            const tbody = document.getElementById('inquilinosTable').querySelector('tbody');
            tbody.innerHTML = '';
            inquilinos.forEach(inq => {
                const row = tbody.insertRow();
                row.style.cursor = 'pointer';
                row.onclick = () => showInquilinoDetail(inq.id);
                row.innerHTML = `<td>${inq.nombre}</td><td class="currency">${formatCurrency(inq.renta)}</td><td>${formatDate(inq.fechaVencimiento)}</td>`;
            });
            if (inquilinos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:var(--text-light)">No hay inquilinos registrados</td></tr>';
            }
        }

        function renderInquilinosRentasRecibidas() {
            const tbody = document.getElementById('inquilinosRentasRecibidasTable').querySelector('tbody');
            tbody.innerHTML = '';
            const filterType = document.getElementById('inquilinosRentasFilter').value;
            const year = parseInt(document.getElementById('inquilinosRentasYear').value);
            const monthSelect = document.getElementById('inquilinosRentasMonth');
            
            if (filterType === 'mensual') monthSelect.classList.remove('hidden');
            else monthSelect.classList.add('hidden');
            
            const month = filterType === 'mensual' ? parseInt(monthSelect.value) : null;
            const rentas = [];
            let totalPeriodo = 0;
            
            inquilinos.forEach(inq => {
                if (inq.pagos) {
                    inq.pagos.forEach(pago => {
                        const pd = new Date(pago.fecha + 'T00:00:00');
                        if (pd.getFullYear() === year && (month === null || pd.getMonth() === month)) {
                            rentas.push({ empresa: inq.nombre, monto: pago.monto, fecha: pago.fecha });
                            totalPeriodo += pago.monto;
                        }
                    });
                }
            });
            
            rentas.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            rentas.forEach(r => {
                const row = tbody.insertRow();
                row.innerHTML = `<td>${r.empresa}</td><td class="currency">${formatCurrency(r.monto)}</td><td>${formatDate(r.fecha)}</td>`;
            });
            
            if (rentas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:var(--text-light)">No hay rentas recibidas</td></tr>';
            } else {
                const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                if (filterType === 'mensual') {
                    const row = tbody.insertRow();
                    row.style.fontWeight = 'bold'; row.style.backgroundColor = '#e6f2ff';
                    row.innerHTML = `<td style="text-align:right;padding:1rem;font-size:1.1rem">TOTAL ${monthNames[month].toUpperCase()} ${year}:</td><td class="currency" style="color:var(--primary);font-size:1.2rem">${formatCurrency(totalPeriodo)}</td><td></td>`;
                }
                let totalAnual = 0;
                inquilinos.forEach(inq => {
                    if (inq.pagos) {
                        inq.pagos.forEach(pago => {
                            const pd = new Date(pago.fecha + 'T00:00:00');
                            if (pd.getFullYear() === year) totalAnual += pago.monto;
                        });
                    }
                });
                const rowAnual = tbody.insertRow();
                rowAnual.style.fontWeight = 'bold'; rowAnual.style.backgroundColor = '#d4edda';
                rowAnual.innerHTML = `<td style="text-align:right;padding:1rem;font-size:1.1rem">TOTAL ${year}:</td><td class="currency" style="color:var(--success);font-size:1.2rem">${formatCurrency(totalAnual)}</td><td></td>`;
            }
        }

        function renderInquilinosVencimientoContratos() {
            const tbody = document.getElementById('inquilinosVencimientoContratosTable').querySelector('tbody');
            tbody.innerHTML = '';
            const today = new Date(); today.setHours(0, 0, 0, 0);
            
            inquilinos.forEach(inq => {
                const venc = new Date(inq.fechaVencimiento + 'T00:00:00');
                const diffDays = Math.ceil((venc - today) / (1000 * 60 * 60 * 24));
                let estado = '', badgeClass = '';
                if (diffDays < 0) { estado = 'Vencido'; badgeClass = 'badge-danger'; }
                else if (diffDays <= 30) { estado = 'Próximo a vencer'; badgeClass = 'badge-warning'; }
                else { estado = 'Vigente'; badgeClass = 'badge-success'; }
                
                const row = tbody.insertRow();
                row.innerHTML = `<td>${inq.nombre}</td><td>${formatDate(inq.fechaInicio)}</td><td>${formatDate(inq.fechaVencimiento)}</td><td>${diffDays}</td><td><span class="badge ${badgeClass}">${estado}</span></td>`;
            });
            
            if (inquilinos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--text-light)">No hay contratos registrados</td></tr>';
            }
        }

        function showAddInquilinoModal() {
            isEditMode = false; currentInquilinoId = null;
            document.getElementById('addInquilinoTitle').textContent = 'Agregar Inquilino';
            document.getElementById('inquilinoForm').reset();
            document.getElementById('addInquilinoModal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        async function saveInquilino(event) {
            event.preventDefault();
            showLoading();
            try {
                const inquilinoData = {
                    nombre: document.getElementById('inquilinoNombre').value,
                    contacto: document.getElementById('inquilinoContacto').value,
                    telefono: document.getElementById('inquilinoTelefono').value,
                    email: document.getElementById('inquilinoEmail').value,
                    renta: parseFloat(document.getElementById('inquilinoRenta').value),
                    fecha_inicio: document.getElementById('inquilinoFechaInicio').value,
                    fecha_vencimiento: document.getElementById('inquilinoFechaVenc').value
                };
                
                if (isEditMode) {
                    const { error } = await supabaseClient.from('inquilinos').update(inquilinoData).eq('id', currentInquilinoId);
                    if (error) throw error;
                    alert('✅ Inquilino actualizado');
                } else {
                    const { error } = await supabaseClient.from('inquilinos').insert([inquilinoData]);
                    if (error) throw error;
                    alert('✅ Inquilino agregado');
                }
                
                await loadInquilinos();
                renderInquilinosTable();
                closeModal('addInquilinoModal');
                isEditMode = false; currentInquilinoId = null;
            } catch (error) {
                console.error('Error:', error);
                alert('Error: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function showInquilinoDetail(id) {
            const inq = inquilinos.find(i => i.id === id);
            currentInquilinoId = id;
            document.getElementById('inquilinoDetailNombre').textContent = inq.nombre;
            document.getElementById('detailContacto').textContent = inq.contacto || '-';
            document.getElementById('detailTelefono').textContent = inq.telefono || '-';
            document.getElementById('detailEmail').textContent = inq.email || '-';
            document.getElementById('detailRenta').textContent = formatCurrency(inq.renta);
            document.getElementById('detailFechaInicio').textContent = formatDate(inq.fechaInicio);
            document.getElementById('detailFechaVenc').textContent = formatDate(inq.fechaVencimiento);
            
            const historialDiv = document.getElementById('historialPagos');
            if (inq.pagos && inq.pagos.length > 0) {
                historialDiv.innerHTML = inq.pagos.map(p => `
                    <div class="payment-item">
                        <div><strong>${formatDate(p.fecha)}</strong><br>${formatCurrency(p.monto)}</div>
                        <div><span class="badge badge-success">Pagado</span></div>
                    </div>
                `).join('');
            } else {
                historialDiv.innerHTML = '<p style="color:var(--text-light);text-align:center;padding:2rem">No hay pagos</p>';
            }
            document.getElementById('inquilinoDetailModal').classList.add('active');
        }

        function editInquilino() {
            const inq = inquilinos.find(i => i.id === currentInquilinoId);
            isEditMode = true;
            document.getElementById('addInquilinoTitle').textContent = 'Editar Inquilino';
            document.getElementById('inquilinoNombre').value = inq.nombre;
            document.getElementById('inquilinoContacto').value = inq.contacto || '';
            document.getElementById('inquilinoTelefono').value = inq.telefono || '';
            document.getElementById('inquilinoEmail').value = inq.email || '';
            document.getElementById('inquilinoRenta').value = inq.renta;
            document.getElementById('inquilinoFechaInicio').value = inq.fechaInicio;
            document.getElementById('inquilinoFechaVenc').value = inq.fechaVencimiento;
            closeModal('inquilinoDetailModal');
            document.getElementById('addInquilinoModal').classList.add('active');
        }

        async function deleteInquilino() {
            if (!confirm('¿Eliminar este inquilino?')) return;
            showLoading();
            try {
                const { error } = await supabaseClient.from('inquilinos').delete().eq('id', currentInquilinoId);
                if (error) throw error;
                await loadInquilinos();
                renderInquilinosTable();
                closeModal('inquilinoDetailModal');
                alert('✅ Inquilino eliminado');
            } catch (error) {
                console.error('Error:', error);
                alert('Error: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function showRegistrarPagoModal() {
            const inq = inquilinos.find(i => i.id === currentInquilinoId);
            document.getElementById('pagoMonto').value = inq.renta;
            document.getElementById('pagoFecha').value = new Date().toISOString().split('T')[0];
            document.getElementById('pagoCompleto').value = 'si';
            document.getElementById('pagoMontoGroup').classList.add('hidden');
            document.getElementById('registrarPagoModal').classList.add('active');
        }

        function toggleMontoInput() {
            const completo = document.getElementById('pagoCompleto').value;
            const montoGroup = document.getElementById('pagoMontoGroup');
            if (completo === 'no') {
                montoGroup.classList.remove('hidden');
                document.getElementById('pagoMonto').required = true;
            } else {
                montoGroup.classList.add('hidden');
                document.getElementById('pagoMonto').required = false;
            }
        }

        async function savePagoRenta(event) {
            event.preventDefault();
            showLoading();
            try {
                const inq = inquilinos.find(i => i.id === currentInquilinoId);
                const completo = document.getElementById('pagoCompleto').value === 'si';
                const monto = completo ? inq.renta : parseFloat(document.getElementById('pagoMonto').value);
                
                const { error } = await supabaseClient.from('pagos_inquilinos').insert([{
                    inquilino_id: currentInquilinoId,
                    fecha: document.getElementById('pagoFecha').value,
                    monto: monto,
                    completo: completo
                }]);
                if (error) throw error;
                await loadInquilinos();
                showInquilinoDetail(currentInquilinoId);
                closeModal('registrarPagoModal');
                alert('✅ Pago registrado');
            } catch (error) {
                console.error('Error:', error);
                alert('Error: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function renderProveedoresTable() {
            const tbody = document.getElementById('proveedoresTable').querySelector('tbody');
            tbody.innerHTML = '';
            proveedores.forEach(prov => {
                const row = tbody.insertRow();
                row.style.cursor = 'pointer';
                row.onclick = () => showProveedorDetail(prov.id);
                row.innerHTML = `<td>${prov.nombre}</td><td>${prov.servicio}</td><td>${prov.contacto}</td>`;
            });
            if (proveedores.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:var(--text-light)">No hay proveedores</td></tr>';
            }
        }

        function showAddProveedorModal() {
            isEditMode = false; currentProveedorId = null;
            document.getElementById('addProveedorTitle').textContent = 'Agregar Proveedor';
            document.getElementById('proveedorForm').reset();
            document.getElementById('addProveedorModal').classList.add('active');
        }

        async function saveProveedor(event) {
            event.preventDefault();
            showLoading();
            try {
                const provData = {
                    nombre: document.getElementById('proveedorNombre').value,
                    servicio: document.getElementById('proveedorServicio').value,
                    contacto: document.getElementById('proveedorContacto').value,
                    telefono: document.getElementById('proveedorTelefono').value,
                    email: document.getElementById('proveedorEmail').value
                };
                
                if (isEditMode) {
                    const { error } = await supabaseClient.from('proveedores').update(provData).eq('id', currentProveedorId);
                    if (error) throw error;
                    alert('✅ Proveedor actualizado');
                } else {
                    const { error } = await supabaseClient.from('proveedores').insert([provData]);
                    if (error) throw error;
                    alert('✅ Proveedor agregado');
                }
                await loadProveedores();
                renderProveedoresTable();
                closeModal('addProveedorModal');
                isEditMode = false; currentProveedorId = null;
            } catch (error) {
                console.error('Error:', error);
                alert('Error: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function showProveedorDetail(id) {
            const prov = proveedores.find(p => p.id === id);
            currentProveedorId = id;
            document.getElementById('proveedorDetailNombre').textContent = prov.nombre;
            document.getElementById('detailServicio').textContent = prov.servicio;
            document.getElementById('detailProvContacto').textContent = prov.contacto || '-';
            document.getElementById('detailProvTelefono').textContent = prov.telefono || '-';
            document.getElementById('detailProvEmail').textContent = prov.email || '-';
            
            const historialDiv = document.getElementById('historialFacturas');
            if (prov.facturas && prov.facturas.length > 0) {
                historialDiv.innerHTML = prov.facturas.map(f => `
                    <div class="payment-item">
                        <div><strong>${formatDate(f.fecha)}</strong><br>${formatCurrency(f.monto)}<br>Vence: ${formatDate(f.vencimiento)}</div>
                        <div>${f.fechaPago ? '<span class="badge badge-success">Pagado</span>' : '<button class="btn btn-sm btn-primary" onclick="showPagarFacturaModal(' + f.id + ')">Pagar</button>'}</div>
                    </div>
                `).join('');
            } else {
                historialDiv.innerHTML = '<p style="color:var(--text-light);text-align:center;padding:2rem">No hay facturas</p>';
            }
            document.getElementById('proveedorDetailModal').classList.add('active');
        }

        function editProveedor() {
            const prov = proveedores.find(p => p.id === currentProveedorId);
            isEditMode = true;
            document.getElementById('addProveedorTitle').textContent = 'Editar Proveedor';
            document.getElementById('proveedorNombre').value = prov.nombre;
            document.getElementById('proveedorServicio').value = prov.servicio;
            document.getElementById('proveedorContacto').value = prov.contacto || '';
            document.getElementById('proveedorTelefono').value = prov.telefono || '';
            document.getElementById('proveedorEmail').value = prov.email || '';
            closeModal('proveedorDetailModal');
            document.getElementById('addProveedorModal').classList.add('active');
        }

        async function deleteProveedor() {
            if (!confirm('¿Eliminar este proveedor?')) return;
            showLoading();
            try {
                const { error } = await supabaseClient.from('proveedores').delete().eq('id', currentProveedorId);
                if (error) throw error;
                await loadProveedores();
                renderProveedoresTable();
                closeModal('proveedorDetailModal');
                alert('✅ Proveedor eliminado');
            } catch (error) {
                console.error('Error:', error);
                alert('Error: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function showRegistrarFacturaModal() {
            document.getElementById('facturaNumero').value = '';
            document.getElementById('facturaFecha').value = new Date().toISOString().split('T')[0];
            document.getElementById('facturaVencimiento').value = '';
            document.getElementById('facturaMonto').value = '';
            document.getElementById('registrarFacturaModal').classList.add('active');
        }

        async function saveFactura(event) {
            event.preventDefault();
            showLoading();
            try {
                const { error } = await supabaseClient.from('facturas').insert([{
                    proveedor_id: currentProveedorId,
                    numero: document.getElementById('facturaNumero').value,
                    fecha: document.getElementById('facturaFecha').value,
                    vencimiento: document.getElementById('facturaVencimiento').value,
                    monto: parseFloat(document.getElementById('facturaMonto').value)
                }]);
                if (error) throw error;
                await loadProveedores();
                showProveedorDetail(currentProveedorId);
                closeModal('registrarFacturaModal');
                alert('✅ Factura registrada');
            } catch (error) {
                console.error('Error:', error);
                alert('Error: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function showPagarFacturaModal(facturaId) {
            currentFacturaId = facturaId;
            document.getElementById('fechaPagoFactura').value = new Date().toISOString().split('T')[0];
            document.getElementById('pagarFacturaModal').classList.add('active');
        }

        async function savePagoFactura(event) {
            event.preventDefault();
            showLoading();
            try {
                const { error } = await supabaseClient.from('facturas').update({
                    fecha_pago: document.getElementById('fechaPagoFactura').value
                }).eq('id', currentFacturaId);
                if (error) throw error;
                await loadProveedores();
                showProveedorDetail(currentProveedorId);
                closeModal('pagarFacturaModal');
                alert('✅ Pago registrado');
            } catch (error) {
                console.error('Error:', error);
                alert('Error: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function renderActivosTable() {
            const tbody = document.getElementById('activosTable').querySelector('tbody');
            tbody.innerHTML = '';
            activos.forEach(act => {
                const row = tbody.insertRow();
                row.style.cursor = 'pointer';
                row.onclick = () => showActivoDetail(act.id);
                row.innerHTML = `<td>${act.nombre}</td><td>${formatDate(act.ultimoMant)}</td><td>${formatDate(act.proximoMant)}</td><td>${act.proveedor || '-'}</td>`;
            });
            if (activos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--text-light)">No hay activos</td></tr>';
            }
        }

        function showAddActivoModal() {
            isEditMode = false; currentActivoId = null;
            document.getElementById('addActivoTitle').textContent = 'Agregar Activo';
            document.getElementById('activoForm').reset();
            document.getElementById('addActivoModal').classList.add('active');
        }

        async function saveActivo(event) {
            event.preventDefault();
            showLoading();
            try {
                const actData = {
                    nombre: document.getElementById('activoNombre').value,
                    ultimo_mant: document.getElementById('activoUltimoMant').value,
                    proximo_mant: document.getElementById('activoProximoMant').value,
                    proveedor: document.getElementById('activoProveedor').value,
                    notas: document.getElementById('activoNotas').value
                };
                
                if (isEditMode) {
                    const { error } = await supabaseClient.from('activos').update(actData).eq('id', currentActivoId);
                    if (error) throw error;
                    alert('✅ Activo actualizado');
                } else {
                    const { error } = await supabaseClient.from('activos').insert([actData]);
                    if (error) throw error;
                    alert('✅ Activo agregado');
                }
                await loadActivos();
                renderActivosTable();
                closeModal('addActivoModal');
                isEditMode = false; currentActivoId = null;
            } catch (error) {
                console.error('Error:', error);
                alert('Error: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function showActivoDetail(id) {
            const act = activos.find(a => a.id === id);
            currentActivoId = id;
            document.getElementById('activoDetailNombre').textContent = act.nombre;
            document.getElementById('detailUltimoMant').textContent = formatDate(act.ultimoMant);
            document.getElementById('detailProximoMant').textContent = formatDate(act.proximoMant);
            document.getElementById('detailActivoProveedor').textContent = act.proveedor || '-';
            document.getElementById('detailActivoNotas').textContent = act.notas || '-';
            document.getElementById('activoDetailModal').classList.add('active');
        }

        function editActivo() {
            const act = activos.find(a => a.id === currentActivoId);
            isEditMode = true;
            document.getElementById('addActivoTitle').textContent = 'Editar Activo';
            document.getElementById('activoNombre').value = act.nombre;
            document.getElementById('activoUltimoMant').value = act.ultimoMant || '';
            document.getElementById('activoProximoMant').value = act.proximoMant || '';
            document.getElementById('activoProveedor').value = act.proveedor || '';
            document.getElementById('activoNotas').value = act.notas || '';
            closeModal('activoDetailModal');
            document.getElementById('addActivoModal').classList.add('active');
        }

        async function deleteActivo() {
            if (!confirm('¿Eliminar este activo?')) return;
            showLoading();
            try {
                const { error } = await supabaseClient.from('activos').delete().eq('id', currentActivoId);
                if (error) throw error;
                await loadActivos();
                renderActivosTable();
                closeModal('activoDetailModal');
                alert('✅ Activo eliminado');
            } catch (error) {
                console.error('Error:', error);
                alert('Error: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 ESWU Sistema Completo');
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const username = document.getElementById('username').value;
                    if (username) login(username); else alert('Seleccione un usuario');
                });
            }
        });
    </script>
</body>
</html>
