<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESWU - Supabase</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary: #1a365d;
            --primary-dark: #0f2744;
            --secondary: #2c5282;
            --accent: #3182ce;
            --success: #38a169;
            --danger: #e53e3e;
            --warning: #dd6b20;
            --bg: #f7fafc;
            --card-bg: #ffffff;
            --text: #2d3748;
            --text-light: #718096;
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7); display: flex;
            align-items: center; justify-content: center; z-index: 10000;
        }
        .loading-overlay.hidden { display: none; }
        .loading-spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid var(--primary);
            border-radius: 50%; width: 50px; height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .login-container {
            min-height: 100vh; display: flex; align-items: center; justify-content: center;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        }
        .login-container.hidden { display: none; }
        .login-box {
            background: white; padding: 3rem; border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); width: 90%; max-width: 400px;
        }
        .login-box h1 { color: var(--primary); margin-bottom: 2rem; text-align: center; font-size: 2rem; }
        .app-container { display: none; min-height: 100vh; }
        .app-container.active { display: block; }
        .header {
            background: var(--primary); color: white; padding: 1rem 2rem;
            box-shadow: var(--shadow); display: flex; justify-content: space-between; align-items: center;
        }
        .header-title { font-size: 1.5rem; font-weight: 600; }
        .user-info { display: flex; align-items: center; gap: 1rem; }
        .user-name { font-weight: 500; }
        .nav { background: var(--card-bg); box-shadow: var(--shadow); padding: 0 2rem; }
        .nav-list { list-style: none; display: flex; gap: 2rem; }
        .nav-link {
            display: block; padding: 1rem 0; color: var(--text); text-decoration: none;
            font-weight: 500; transition: color 0.2s; border-bottom: 3px solid transparent;
        }
        .nav-link:hover, .nav-link.active { color: var(--primary); border-bottom-color: var(--primary); }
        .main-content { padding: 2rem; max-width: 1400px; margin: 0 auto; }
        .page { display: none; }
        .page.active { display: block; }
        .card {
            background: var(--card-bg); border-radius: 8px;
            box-shadow: var(--shadow); margin-bottom: 2rem; overflow: hidden;
        }
        .card-header {
            padding: 1.5rem; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        .card-title { font-size: 1.5rem; color: var(--primary); font-weight: 600; }
        .summary-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem; margin-bottom: 2rem;
        }
        .summary-card { background: var(--card-bg); padding: 1.5rem; border-radius: 8px; box-shadow: var(--shadow); }
        .summary-label { color: var(--text-light); font-size: 0.875rem; margin-bottom: 0.5rem; }
        .summary-value { font-size: 2rem; font-weight: 600; color: var(--primary); }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        thead { background: var(--bg); }
        th { padding: 1rem; text-align: left; font-weight: 600; color: var(--text); border-bottom: 2px solid var(--border); }
        td { padding: 1rem; border-bottom: 1px solid var(--border); }
        tr:hover { background: var(--bg); }
        .currency { text-align: right; font-variant-numeric: tabular-nums; }
        .btn {
            padding: 0.75rem 1.5rem; border: none; border-radius: 6px; font-size: 1rem;
            font-weight: 500; cursor: pointer; transition: all 0.2s; text-decoration: none; display: inline-block;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { filter: brightness(1.1); }
        .btn-secondary { background: var(--text-light); color: white; }
        .btn-secondary:hover { filter: brightness(0.9); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { filter: brightness(1.1); }
        .btn-sm { padding: 0.5rem 1rem; font-size: 0.875rem; }
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text); }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 0.75rem; border: 2px solid var(--border);
            border-radius: 6px; font-size: 1rem; font-family: inherit; transition: border-color 0.2s;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none; border-color: var(--primary);
        }
        .form-group textarea { resize: vertical; min-height: 100px; }
        .filter-section {
            display: flex; gap: 1rem; margin-bottom: 1.5rem; align-items: center; flex-wrap: wrap;
        }
        .filter-section label { font-weight: 500; }
        .filter-section select { padding: 0.5rem 1rem; border: 2px solid var(--border); border-radius: 6px; font-size: 1rem; }
        .hidden { display: none !important; }
        .tables-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 2rem; }
        @media (max-width: 768px) {
            .header { flex-direction: column; gap: 1rem; }
            .nav-list { flex-direction: column; gap: 0; }
            .nav-link { padding: 0.75rem 0; }
            .main-content { padding: 1rem; }
            .summary-grid, .tables-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="loading-spinner"></div>
    </div>
    <div id="loginContainer" class="login-container">
        <div class="login-box">
            <h1>ESWU</h1>
            <form id="loginForm">
                <div class="form-group">
                    <label>Seleccione Usuario</label>
                    <select id="username" required style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 6px;">
                        <option value="">-- Seleccione un usuario --</option>
                        <option value="Anabel">Anabel</option>
                        <option value="Doris">Doris</option>
                        <option value="Miguel">Miguel</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Iniciar SesiÃ³n</button>
            </form>
        </div>
    </div>
    <div id="appContainer" class="app-container">
        <div class="header">
            <div class="header-title">ESWU - Supabase</div>
            <div class="user-info">
                <span class="user-name" id="currentUser"></span>
                <button onclick="logout()" class="btn btn-secondary btn-sm">Salir</button>
            </div>
        </div>
        <nav class="nav">
            <ul class="nav-list">
                <li class="nav-item"><a href="#" class="nav-link active" onclick="showPage('home')">Home</a></li>
                <li class="nav-item"><a href="#" class="nav-link" onclick="showPage('inquilinos')">Inquilinos</a></li>
                <li class="nav-item"><a href="#" class="nav-link" onclick="showPage('chat')">Chat</a></li>
            </ul>
        </nav>
        <div class="main-content">
            <div id="homePage" class="page active">
                <div class="summary-grid">
                    <div class="summary-card">
                        <div class="summary-label">Ingresos</div>
                        <div class="summary-value currency" id="summaryIngresos">$0</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">Gastos</div>
                        <div class="summary-value currency" id="summaryGastos">$0</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">Ingreso Neto</div>
                        <div class="summary-value currency" id="summaryNeto">$0</div>
                    </div>
                </div>
                <div class="filter-section">
                    <label>Ver por:</label>
                    <select id="homeFilter" onchange="updateHomeView()">
                        <option value="anual">Anual</option>
                        <option value="mensual">Mensual</option>
                    </select>
                    <select id="homeYear" onchange="updateHomeView()"></select>
                    <select id="homeMonth" onchange="updateHomeView()" class="hidden">
                        <option value="0">Enero</option><option value="1">Febrero</option>
                        <option value="2">Marzo</option><option value="3">Abril</option>
                        <option value="4">Mayo</option><option value="5">Junio</option>
                        <option value="6">Julio</option><option value="7">Agosto</option>
                        <option value="8">Septiembre</option><option value="9">Octubre</option>
                        <option value="10">Noviembre</option><option value="11">Diciembre</option>
                    </select>
                </div>
                <div class="tables-grid">
                    <div class="card">
                        <div class="card-header"><h2 class="card-title">Ingresos por Renta</h2></div>
                        <div class="table-container">
                            <table id="homeIngresosTable">
                                <thead><tr><th>Inquilino</th><th>Fecha</th><th>Monto</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header"><h2 class="card-title">Gastos</h2></div>
                        <div class="table-container">
                            <table id="homeGastosTable">
                                <thead><tr><th>Proveedor</th><th>Fecha</th><th>Monto</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div id="inquilinosPage" class="page">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Inquilinos</h2>
                        <button onclick="alert('Funcionalidad prÃ³ximamente')" class="btn btn-success">+ Agregar Inquilino</button>
                    </div>
                    <div class="table-container">
                        <table id="inquilinosTable">
                            <thead>
                                <tr>
                                    <th>Empresa</th>
                                    <th>Renta Mensual</th>
                                    <th>Vencimiento Contrato</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div id="chatPage" class="page">
                <div class="card">
                    <div class="card-header"><h2 class="card-title">Chat</h2></div>
                    <div style="padding: 2rem; text-align: center; color: var(--text-light);">
                        <p>Funcionalidad de Chat - PrÃ³ximamente</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        const SUPABASE_URL = 'https://tzuvoceilkqurnujrraq.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR6dXZvY2VpbGtxdXJudWpycmFxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1Mjg3NDIsImV4cCI6MjA4NTEwNDc0Mn0.2bGNuh7nVhAFGULlXBT85wsKUMgJJbEEGtUq0jerqno';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let currentUser = '';
        let inquilinos = [];
        let proveedores = [];
        let activos = [];

        function showLoading() { document.getElementById('loadingOverlay').classList.remove('hidden'); }
        function hideLoading() { document.getElementById('loadingOverlay').classList.add('hidden'); }

        function login(username) {
            if (!username) { alert('Seleccione un usuario'); return; }
            currentUser = username;
            document.getElementById('currentUser').textContent = username;
            document.getElementById('loginContainer').classList.add('hidden');
            document.getElementById('appContainer').classList.add('active');
            setTimeout(() => loadAllData(), 100);
        }

        function logout() {
            currentUser = '';
            document.getElementById('username').value = '';
            document.getElementById('loginContainer').classList.remove('hidden');
            document.getElementById('appContainer').classList.remove('active');
        }

        function showPage(pageName) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.getElementById(pageName + 'Page').classList.add('active');
            event.target.classList.add('active');
            if (pageName === 'home') updateHomeView();
            if (pageName === 'inquilinos') renderInquilinosTable();
        }

        async function loadAllData() {
            showLoading();
            try {
                await Promise.all([loadInquilinos(), loadProveedores(), loadActivos()]);
                populateYearSelect();
                updateHomeView();
                console.log('âœ… Datos cargados:', inquilinos.length, 'inquilinos,', proveedores.length, 'proveedores,', activos.length, 'activos');
            } catch (error) {
                console.error('âŒ Error:', error);
                alert('Error al cargar datos');
            } finally {
                hideLoading();
            }
        }

        async function loadInquilinos() {
            try {
                const { data, error } = await supabaseClient
                    .from('inquilinos')
                    .select('*, pagos_inquilinos(*)')
                    .order('nombre');
                if (error) throw error;
                inquilinos = data.map(inq => ({
                    id: inq.id,
                    nombre: inq.nombre,
                    contacto: inq.contacto,
                    telefono: inq.telefono,
                    email: inq.email,
                    clabe: inq.clabe,
                    rfc: inq.rfc,
                    m2: inq.m2,
                    renta: parseFloat(inq.renta || 0),
                    fechaInicio: inq.fecha_inicio,
                    fechaVencimiento: inq.fecha_vencimiento,
                    notas: inq.notas,
                    contratoFile: inq.contrato_file,
                    contratoFileName: inq.contrato_filename,
                    pagos: inq.pagos_inquilinos ? inq.pagos_inquilinos.map(p => ({
                        id: p.id,
                        fecha: p.fecha,
                        monto: parseFloat(p.monto),
                        completo: p.completo,
                        pagoFile: p.pago_file,
                        pagoFileName: p.pago_filename
                    })).sort((a, b) => new Date(b.fecha) - new Date(a.fecha)) : []
                }));
            } catch (error) {
                console.error('Error loading inquilinos:', error);
                throw error;
            }
        }

        async function loadProveedores() {
            try {
                const { data, error } = await supabaseClient
                    .from('proveedores')
                    .select('*, facturas(*)')
                    .order('nombre');
                if (error) throw error;
                proveedores = data.map(prov => ({
                    id: prov.id,
                    nombre: prov.nombre,
                    servicio: prov.servicio,
                    contacto: prov.contacto,
                    telefono: prov.telefono,
                    email: prov.email,
                    clabe: prov.clabe,
                    rfc: prov.rfc,
                    notas: prov.notas,
                    facturas: prov.facturas ? prov.facturas.map(f => ({
                        id: f.id,
                        numero: f.numero,
                        fecha: f.fecha,
                        vencimiento: f.vencimiento,
                        monto: parseFloat(f.monto),
                        fechaPago: f.fecha_pago,
                        documentoFile: f.documento_file,
                        documentoFileName: f.documento_filename,
                        pagoFile: f.pago_file,
                        pagoFileName: f.pago_filename
                    })).sort((a, b) => new Date(b.fecha) - new Date(a.fecha)) : []
                }));
            } catch (error) {
                console.error('Error loading proveedores:', error);
                throw error;
            }
        }

        async function loadActivos() {
            try {
                const { data, error } = await supabaseClient
                    .from('activos')
                    .select('*, activos_fotos(*)')
                    .order('nombre');
                if (error) throw error;
                activos = data.map(act => ({
                    id: act.id,
                    nombre: act.nombre,
                    ultimoMant: act.ultimo_mant,
                    proximoMant: act.proximo_mant,
                    proveedor: act.proveedor,
                    notas: act.notas,
                    fotos: act.activos_fotos ? act.activos_fotos.map(f => ({
                        id: f.id,
                        data: f.foto_data,
                        name: f.foto_name
                    })) : []
                }));
            } catch (error) {
                console.error('Error loading activos:', error);
                throw error;
            }
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(amount);
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString + 'T00:00:00');
            const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
            return `${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear()}`;
        }

        function populateYearSelect() {
            const currentYear = new Date().getFullYear();
            const yearSelect = document.getElementById('homeYear');
            yearSelect.innerHTML = '';
            for (let year = currentYear - 5; year <= currentYear + 1; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYear) option.selected = true;
                yearSelect.appendChild(option);
            }
        }

        function updateHomeView() {
            const filterType = document.getElementById('homeFilter').value;
            const year = parseInt(document.getElementById('homeYear').value);
            const monthSelect = document.getElementById('homeMonth');
            
            if (filterType === 'mensual') {
                monthSelect.classList.remove('hidden');
            } else {
                monthSelect.classList.add('hidden');
            }
            
            const month = filterType === 'mensual' ? parseInt(monthSelect.value) : null;
            let totalIngresos = 0, totalGastos = 0;
            
            inquilinos.forEach(inq => {
                if (inq.pagos) {
                    inq.pagos.forEach(pago => {
                        const pd = new Date(pago.fecha + 'T00:00:00');
                        if (pd.getFullYear() === year && (month === null || pd.getMonth() === month)) {
                            totalIngresos += pago.monto;
                        }
                    });
                }
            });
            
            proveedores.forEach(prov => {
                if (prov.facturas) {
                    prov.facturas.forEach(fact => {
                        if (fact.fechaPago) {
                            const pd = new Date(fact.fechaPago + 'T00:00:00');
                            if (pd.getFullYear() === year && (month === null || pd.getMonth() === month)) {
                                totalGastos += fact.monto;
                            }
                        }
                    });
                }
            });
            
            document.getElementById('summaryIngresos').textContent = formatCurrency(totalIngresos);
            document.getElementById('summaryGastos').textContent = formatCurrency(totalGastos);
            document.getElementById('summaryNeto').textContent = formatCurrency(totalIngresos - totalGastos);
            
            renderHomeIngresos(year, month);
            renderHomeGastos(year, month);
        }

        function renderHomeIngresos(year, month) {
            const tbody = document.getElementById('homeIngresosTable').querySelector('tbody');
            tbody.innerHTML = '';
            const pagos = [];
            let total = 0;
            
            inquilinos.forEach(inq => {
                if (inq.pagos) {
                    inq.pagos.forEach(pago => {
                        const pd = new Date(pago.fecha + 'T00:00:00');
                        if (pd.getFullYear() === year && (month === null || pd.getMonth() === month)) {
                            pagos.push({ inquilino: inq.nombre, fecha: pago.fecha, monto: pago.monto });
                            total += pago.monto;
                        }
                    });
                }
            });
            
            pagos.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            pagos.forEach(p => {
                const row = tbody.insertRow();
                row.innerHTML = `<td>${p.inquilino}</td><td>${formatDate(p.fecha)}</td><td class="currency">${formatCurrency(p.monto)}</td>`;
            });
            
            if (pagos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:var(--text-light)">No hay ingresos</td></tr>';
            } else {
                const row = tbody.insertRow();
                row.style.fontWeight = 'bold';
                row.style.backgroundColor = '#d4edda';
                row.innerHTML = `<td colspan="2" style="text-align:right;padding:1rem">TOTAL:</td><td class="currency" style="color:var(--success);font-size:1.1rem">${formatCurrency(total)}</td>`;
            }
        }

        function renderHomeGastos(year, month) {
            const tbody = document.getElementById('homeGastosTable').querySelector('tbody');
            tbody.innerHTML = '';
            const gastos = [];
            let total = 0;
            
            proveedores.forEach(prov => {
                if (prov.facturas) {
                    prov.facturas.forEach(fact => {
                        if (fact.fechaPago) {
                            const pd = new Date(fact.fechaPago + 'T00:00:00');
                            if (pd.getFullYear() === year && (month === null || pd.getMonth() === month)) {
                                gastos.push({ proveedor: prov.nombre, fecha: fact.fechaPago, monto: fact.monto });
                                total += fact.monto;
                            }
                        }
                    });
                }
            });
            
            gastos.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            gastos.forEach(g => {
                const row = tbody.insertRow();
                row.innerHTML = `<td>${g.proveedor}</td><td>${formatDate(g.fecha)}</td><td class="currency">${formatCurrency(g.monto)}</td>`;
            });
            
            if (gastos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:var(--text-light)">No hay gastos</td></tr>';
            } else {
                const row = tbody.insertRow();
                row.style.fontWeight = 'bold';
                row.style.backgroundColor = '#fed7d7';
                row.innerHTML = `<td colspan="2" style="text-align:right;padding:1rem">TOTAL:</td><td class="currency" style="color:var(--danger);font-size:1.1rem">${formatCurrency(total)}</td>`;
            }
        }
function renderInquilinosTable() {
            const tbody = document.getElementById('inquilinosTable').querySelector('tbody');
            tbody.innerHTML = '';
            
            inquilinos.forEach(inq => {
                const row = tbody.insertRow();
                row.style.cursor = 'pointer';
                row.onclick = () => alert('Ver detalles de ' + inq.nombre);
                row.innerHTML = `
                    <td>${inq.nombre}</td>
                    <td class="currency">${formatCurrency(inq.renta)}</td>
                    <td>${formatDate(inq.fechaVencimiento)}</td>
                `;
            });
            
            if (inquilinos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:var(--text-light)">No hay inquilinos registrados</td></tr>';
            }
        }
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ðŸš€ ESWU con Supabase iniciado');
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const username = document.getElementById('username').value;
                    if (username) login(username);
                    else alert('Seleccione un usuario');
                });
            }
        });
    </script>
</body>
</html>
