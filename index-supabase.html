<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESWU</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary: #1a365d; --primary-dark: #0f2744; --secondary: #2c5282;
            --accent: #3182ce; --success: #38a169; --danger: #e53e3e; --warning: #dd6b20;
            --bg: #f7fafc; --card-bg: #ffffff; --text: #2d3748; --text-light: #718096;
            --border: #e2e8f0; --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --inquilinos-light: #4a90e2; --proveedores-dark: #0d47a1; --admin-color: #6b46c1;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); line-height: 1.6; }
        body.logged-in { padding-top: 80px; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center; z-index: 10000; }
        .loading-overlay.hidden { display: none; }
        .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .login-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); padding: 0; margin: 0; }
        .login-container.hidden { display: none; }
        .login-box { background: white; padding: 3rem; border-radius: 12px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); width: 90%; max-width: 400px; }
        .login-box h1 { color: var(--primary); margin-bottom: 2rem; text-align: center; font-size: 2rem; }
        .app-container { display: none; min-height: 100vh; }
        .app-container.active { display: block; }
        .header { background: var(--primary); color: white; padding: 1rem 2rem; box-shadow: var(--shadow); display: flex; justify-content: space-between; align-items: center; position: fixed; top: 0; left: 0; right: 0; z-index: 999; }
        .header-left { display: flex; align-items: center; gap: 1rem; }
        .header-title { font-size: 2rem; font-weight: 700; flex: 1; text-align: center; }
        .header-right { display: flex; align-items: center; gap: 1rem; }
        .header-icon { font-size: 1.8rem; cursor: pointer; color: white; text-decoration: none; font-weight: 300; }
        .header-icon:hover { opacity: 0.8; }
        .main-content { padding: 2rem; max-width: 1400px; margin: 0 auto; }
        .page { display: none; }
        .page.active { display: block; }
        .card { background: var(--card-bg); border-radius: 8px; box-shadow: var(--shadow); margin-bottom: 2rem; overflow: hidden; }
        .card-header { padding: 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .card-title { font-size: 1.5rem; color: var(--primary); font-weight: 600; }
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .summary-card { background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: white; padding: 1.5rem; border-radius: 8px; box-shadow: var(--shadow); cursor: pointer; transition: transform 0.2s; }
        .summary-card:hover { transform: translateY(-2px); }
        .summary-card.active { border: 3px solid white; }
        .summary-label { font-size: 0.875rem; margin-bottom: 0.5rem; opacity: 0.9; }
        .summary-value { font-size: 2rem; font-weight: 700; }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; table-layout: auto; }
        thead { background: var(--bg); }
        th { padding: 1rem; text-align: left; font-weight: 600; color: var(--text); border-bottom: 2px solid var(--border); white-space: nowrap; }
        td { padding: 1rem; border-bottom: 1px solid var(--border); white-space: nowrap; }
        tr:hover { background: var(--bg); }
        tr.clickable { cursor: pointer; }
        .currency { text-align: right; font-variant-numeric: tabular-nums; }
        .vencimiento-proximo { color: var(--danger); font-weight: bold; }
        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 6px; font-size: 1rem; font-weight: 500; cursor: pointer; transition: all 0.2s; text-decoration: none; display: inline-block; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { filter: brightness(1.1); }
        .btn-secondary { background: var(--text-light); color: white; }
        .btn-secondary:hover { filter: brightness(0.9); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { filter: brightness(1.1); }
        .btn-sm { padding: 0.5rem 1rem; font-size: 0.875rem; }
        .btn-link { background: none; color: var(--primary); text-decoration: underline; padding: 0.25rem 0.5rem; border: 1px solid transparent; border-radius: 4px; }
        .btn-link:hover { opacity: 0.8; background: rgba(49, 130, 206, 0.1); }
        .pdf-link { background: #e6f2ff; color: var(--primary); padding: 0.25rem 0.75rem; border-radius: 4px; text-decoration: none; border: 1px solid #b3d9ff; display: inline-block; font-size: 0.875rem; }
        .pdf-link:hover { background: #cce5ff; }
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text); }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 6px; font-size: 1rem; font-family: inherit; transition: border-color 0.2s; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--primary); }
        .form-group textarea { resize: vertical; min-height: 100px; }
        .filter-section { display: flex; gap: 1rem; margin-bottom: 1.5rem; align-items: center; flex-wrap: wrap; }
        .filter-section label { font-weight: 500; }
        .filter-section select { padding: 0.5rem 1rem; border: 2px solid var(--border); border-radius: 6px; font-size: 1rem; }
        .hidden { display: none !important; }
        .tables-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 2rem; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000; overflow-y: auto; }
        .modal.active { display: flex; align-items: center; justify-content: center; padding: 2rem; }
        .modal-content { background: white; border-radius: 12px; width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); }
        .modal-header { padding: 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; position: relative; }
        .modal-header-left { display: flex; align-items: center; gap: 2rem; }
        .modal-title { font-size: 1.25rem; color: var(--primary); font-weight: 600; flex: 1; padding-right: 2rem; }
        .close-modal { background: none; border: none; font-size: 1.8rem; color: var(--danger); cursor: pointer; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; position: absolute; right: 1.5rem; }
        .close-modal:hover { opacity: 0.8; }
        .modal-content form { padding: 1.5rem; }
        .modal-actions { padding: 1.5rem; border-top: 1px solid var(--border); display: flex; gap: 1rem; justify-content: flex-end; }
        .file-upload { border: 2px dashed var(--border); border-radius: 6px; padding: 2rem; text-align: center; cursor: pointer; transition: all 0.2s; }
        .file-upload:hover { border-color: var(--primary); background: var(--bg); }
        .file-upload input[type="file"] { display: none; }
        .info-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1rem; }
        .info-item { padding: 0.75rem; background: var(--bg); border-radius: 6px; }
        .info-label { font-size: 0.875rem; color: var(--text-light); margin-bottom: 0.25rem; }
        .info-value { font-weight: 600; color: var(--text); }
        .info-box { padding: 1rem; background: var(--bg); border-radius: 6px; margin-bottom: 1rem; }
        .info-box-title { font-weight: 600; color: var(--primary); margin-bottom: 0.5rem; font-size: 0.875rem; }
        .info-box-content { color: var(--text); }
        .contactos-list { margin-top: 1rem; }
        .contacto-item { padding: 1rem; background: white; border: 1px solid var(--border); border-radius: 6px; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center; }
        .contacto-info { flex: 1; }
        .payment-item { display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-bottom: 1px solid var(--border); transition: background 0.2s; gap: 1rem; }
        .payment-item:hover { background: var(--bg); }
        .payment-item-content { flex: 1; }
        .payment-item-actions { display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; }
        .doc-item { cursor: pointer; transition: background 0.2s; }
        .doc-item:hover { background: var(--bg); }
        .badge { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.875rem; font-weight: 500; }
        .badge-success { background: #c6f6d5; color: #22543d; }
        .badge-warning { background: #feebc8; color: #7c2d12; }
        .badge-danger { background: #fed7d7; color: #742a2a; }
        .dropdown { position: relative; display: inline-block; }
        .dropdown-toggle { background: var(--primary); color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 6px; cursor: pointer; font-size: 1.2rem; font-weight: 500; }
        .dropdown-toggle:hover { background: var(--primary-dark); }
        .dropdown-content { display: none; position: absolute; left: 0; background: white; min-width: 220px; box-shadow: 0 8px 16px rgba(0,0,0,0.2); z-index: 1000; border-radius: 6px; overflow: hidden; margin-top: 0.5rem; }
        .dropdown-content.show { display: block; }
        .dropdown-content a { color: var(--text); padding: 12px 16px; text-decoration: none; display: block; transition: background 0.2s; }
        .dropdown-content a:hover { background: var(--bg); }
        .photo-gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; margin: 1rem 0; }
        .photo-item { position: relative; border-radius: 8px; overflow: hidden; aspect-ratio: 1; }
        .photo-item img { width: 100%; height: 100%; object-fit: cover; }
        .main-menu-dropdown { position: relative; }
        .main-menu-content { display: none; position: absolute; left: 0; top: 100%; background: white; min-width: 200px; box-shadow: 0 8px 16px rgba(0,0,0,0.2); z-index: 1000; border-radius: 6px; overflow: hidden; margin-top: 0.5rem; }
        .main-menu-content.show { display: block; }
        .main-menu-content a { color: var(--text); padding: 12px 16px; text-decoration: none; display: block; transition: background 0.2s; font-weight: 500; }
        .main-menu-content a:hover { background: var(--bg); }
        .main-menu-content.inquilinos-menu { border: 3px solid var(--inquilinos-light); }
        .main-menu-content.proveedores-menu { border: 3px solid var(--proveedores-dark); }
        .main-menu-content.admin-menu { border: 3px solid var(--admin-color); }
        .total-row { font-weight: bold; background: #e6f2ff; }
        .tabs-container { margin: 1.5rem 0; }
        .tabs { display: flex; gap: 0.5rem; border-bottom: 2px solid var(--border); }
        .tab { padding: 0.75rem 1.5rem; cursor: pointer; border: none; background: none; color: var(--text-light); font-weight: 500; transition: all 0.2s; border-bottom: 3px solid transparent; }
        .tab:hover { color: var(--primary); }
        .tab.active { color: var(--primary); border-bottom-color: var(--primary); }
        .tab-content { display: none; padding: 1.5rem 0; }
        .tab-content.active { display: block; }
        @media (max-width: 768px) {
            body.logged-in { padding-top: 70px; }
            .header { padding: 0.75rem 1rem; }
            .header-title { font-size: 1.3rem; }
            .header-icon { font-size: 1.5rem; }
            .main-content { padding: 1rem; }
            .summary-grid { grid-template-columns: 1fr; gap: 1rem; }
            .summary-card { padding: 1.25rem; }
            .summary-label { font-size: 0.875rem; }
            .summary-value { font-size: 1.5rem; }
            .tables-grid { grid-template-columns: 1fr; }
            .info-grid { grid-template-columns: 1fr; }
            table { font-size: 0.875rem; }
            th, td { padding: 0.5rem; }
            .card-header { flex-direction: column; gap: 1rem; align-items: flex-start; }
            .dropdown { display: none; }
            .proveedor-truncate { max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
            .modal-title { font-size: 1rem; padding-right: 1.5rem; }
            .close-modal { font-size: 1.4rem; right: 1rem; }
            .modal-header-left { gap: 0.75rem; }
            .payment-item { flex-direction: column; align-items: flex-start; }
            .payment-item-actions { width: 100%; justify-content: flex-start; }
        }
    </style>
</head>
<body>
    <div id="loadingOverlay" class="loading-overlay hidden"><div class="loading-spinner"></div></div>
    <div id="loginContainer" class="login-container">
        <div class="login-box">
            <h1>ESWU</h1>
            <form id="loginForm">
                <div class="form-group">
                    <select id="username" required style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 6px;">
                        <option value="">Usuario</option>
                        <option value="Anabel">Anabel</option>
                        <option value="Doris">Doris</option>
                        <option value="Miguel">Miguel</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Iniciar SesiÃ³n</button>
            </form>
        </div>
    </div>
    <div id="appContainer" class="app-container">
        <div class="header">
            <div class="header-left">
                <div class="main-menu-dropdown">
                    <button class="dropdown-toggle" onclick="toggleMainMenu()">â˜°</button>
                    <div id="mainMenuDropdown" class="main-menu-content"></div>
                </div>
            </div>
            <div class="header-title" id="headerTitle">ESWU</div>
            <div class="header-right">
                <a href="#" class="header-icon" id="chatIcon" onclick="event.preventDefault(); alert('Chat prÃ³ximamente');" title="Chat">ðŸ’¬</a>
                <a href="#" class="header-icon" id="homeIcon" onclick="event.preventDefault(); showPageFromMenu('home');" title="Home">âŒ‚</a>
            </div>
        </div>
        <div class="main-content">
            <div id="homePage" class="page active">
                <div class="summary-grid">
                    <div class="summary-card" onclick="toggleHomeTable('ingresos')">
                        <div class="summary-label">Ingresos</div>
                        <div class="summary-value currency" id="summaryIngresos">$0</div>
                    </div>
                    <div class="summary-card" onclick="toggleHomeTable('pagos')">
                        <div class="summary-label">Pagos a Terceros</div>
                        <div class="summary-value currency" id="summaryGastos">$0</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">Ingreso Neto</div>
                        <div class="summary-value currency" id="summaryNeto">$0</div>
                    </div>
                </div>
                <div class="filter-section">
                    <label>Ver por:</label>
                    <select id="homeFilter" onchange="updateHomeView()"><option value="anual">Anual</option><option value="mensual">Mensual</option></select>
                    <select id="homeYear" onchange="updateHomeView()"></select>
                    <select id="homeMonth" onchange="updateHomeView()" class="hidden">
                        <option value="0">Enero</option><option value="1">Febrero</option><option value="2">Marzo</option><option value="3">Abril</option>
                        <option value="4">Mayo</option><option value="5">Junio</option><option value="6">Julio</option><option value="7">Agosto</option>
                        <option value="8">Septiembre</option><option value="9">Octubre</option><option value="10">Noviembre</option><option value="11">Diciembre</option>
                    </select>
                </div>
                <div id="homeTablesContainer">
                    <div id="homeIngresosContainer" class="hidden">
                        <div class="card">
                            <div class="card-header"><h2 class="card-title">Ingresos por Renta</h2></div>
                            <div class="table-container"><table id="homeIngresosTable"><thead><tr><th>Inquilino</th><th>Fecha</th><th>Monto</th></tr></thead><tbody></tbody></table></div>
                        </div>
                    </div>
                    <div id="homePagosContainer" class="hidden">
                        <div class="card">
                            <div class="card-header"><h2 class="card-title">Facturas Por Pagar</h2></div>
                            <div class="table-container"><table id="homeFacturasPorPagarTable"><thead><tr><th>Proveedor</th><th>Monto</th><th>Vencimiento</th></tr></thead><tbody></tbody></table></div>
                        </div>
                        <div class="card">
                            <div class="card-header"><h2 class="card-title">Facturas Pagadas</h2></div>
                            <div class="table-container"><table id="homeFacturasPagadasTable"><thead><tr><th>Proveedor</th><th>Monto</th><th>Fecha Pago</th></tr></thead><tbody></tbody></table></div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="inquilinosPage" class="page">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title" id="inquilinosTitulo">Inquilinos - Listado</h2>
                    </div>
                    <div id="inquilinosListView">
                        <div class="table-container">
                            <table id="inquilinosTable">
                                <thead><tr><th>Empresa</th><th style="text-align:right">Renta Mensual</th><th>Vencimiento Contrato</th><th>Contrato</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                    <div id="inquilinosRentasRecibidasView" class="hidden">
                        <div style="padding: 1rem;">
                            <div class="filter-section">
                                <select id="inquilinosRentasFilter" onchange="renderInquilinosRentasRecibidas()"><option value="anual">Anual</option><option value="mensual">Mensual</option></select>
                                <select id="inquilinosRentasYear" onchange="renderInquilinosRentasRecibidas()"></select>
                                <select id="inquilinosRentasMonth" onchange="renderInquilinosRentasRecibidas()" class="hidden">
                                    <option value="0">Enero</option><option value="1">Febrero</option><option value="2">Marzo</option><option value="3">Abril</option>
                                    <option value="4">Mayo</option><option value="5">Junio</option><option value="6">Julio</option><option value="7">Agosto</option>
                                    <option value="8">Septiembre</option><option value="9">Octubre</option><option value="10">Noviembre</option><option value="11">Diciembre</option>
                                </select>
                            </div>
                            <div class="table-container">
                                <table id="inquilinosRentasRecibidasTable">
                                    <thead><tr><th>Empresa</th><th>Renta Recibida</th><th>Fecha de Pago</th></tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div id="inquilinosVencimientoContratosView" class="hidden">
                        <div style="padding: 1rem;">
                            <div class="table-container">
                                <table id="inquilinosVencimientoContratosTable">
                                    <thead><tr><th>Inquilino</th><th>Fecha Inicio</th><th>Fecha Vencimiento</th><th>DÃ­as Restantes</th><th>Estado</th></tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="proveedoresPage" class="page">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title" id="proveedoresTitulo">Proveedores - Listado</h2>
                    </div>
                    <div id="proveedoresListView">
                        <div class="table-container">
                            <table id="proveedoresTable">
                                <thead><tr><th style="width:35%;max-width:250px">Nombre</th><th>Servicio</th><th style="width:35%;max-width:250px">Contacto</th><th>TelÃ©fono</th><th>Email</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                    <div id="proveedoresFacturasPagadasView" class="hidden">
                        <div style="padding: 1rem;">
                            <div class="filter-section">
                                <label>Ver por:</label>
                                <select id="provFactPagFilter" onchange="renderProveedoresFacturasPagadas()"><option value="anual">Anual</option><option value="mensual">Mensual</option></select>
                                <select id="provFactPagYear" onchange="renderProveedoresFacturasPagadas()"></select>
                                <select id="provFactPagMonth" onchange="renderProveedoresFacturasPagadas()" class="hidden">
                                    <option value="0">Enero</option><option value="1">Febrero</option><option value="2">Marzo</option><option value="3">Abril</option>
                                    <option value="4">Mayo</option><option value="5">Junio</option><option value="6">Julio</option><option value="7">Agosto</option>
                                    <option value="8">Septiembre</option><option value="9">Octubre</option><option value="10">Noviembre</option><option value="11">Diciembre</option>
                                </select>
                            </div>
                            <div class="table-container">
                                <table id="proveedoresFacturasPagadasTable">
                                    <thead><tr><th style="width:35%;max-width:250px">Proveedor</th><th>Factura</th><th style="text-align:right">Monto</th><th>Fecha Pago</th></tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div id="proveedoresFacturasPorPagarView" class="hidden">
                        <div style="padding: 1rem;">
                            <div class="filter-section">
                                <label>Ver por:</label>
                                <select id="provFactPorPagFilter" onchange="renderProveedoresFacturasPorPagar()"><option value="anual">Anual</option><option value="mensual">Mensual</option></select>
                                <select id="provFactPorPagYear" onchange="renderProveedoresFacturasPorPagar()"></select>
                                <select id="provFactPorPagMonth" onchange="renderProveedoresFacturasPorPagar()" class="hidden">
                                    <option value="0">Enero</option><option value="1">Febrero</option><option value="2">Marzo</option><option value="3">Abril</option>
                                    <option value="4">Mayo</option><option value="5">Junio</option><option value="6">Julio</option><option value="7">Agosto</option>
                                    <option value="8">Septiembre</option><option value="9">Octubre</option><option value="10">Noviembre</option><option value="11">Diciembre</option>
                                </select>
                            </div>
                            <div class="table-container">
                                <table id="proveedoresFacturasPorPagarTable">
                                    <thead><tr><th style="width:35%;max-width:250px">Proveedor</th><th>Factura</th><th style="text-align:right">Monto</th><th>Vencimiento</th><th>PDF</th></tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="activosPage" class="page">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Activos</h2>
                    </div>
                    <div class="table-container">
                        <table id="activosTable">
                            <thead><tr><th>Nombre</th><th>Ãšltimo Mantenimiento</th><th>PrÃ³ximo Mantenimiento</th><th>Proveedor</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div id="adminPage" class="page">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title" id="adminTitulo">AdministraciÃ³n</h2>
                    </div>
                    <div id="adminUsuariosView" class="hidden">
                        <div style="padding: 1rem;">
                            <div class="table-container">
                                <table id="usuariosTable">
                                    <thead><tr><th>Usuario</th><th>Password</th><th>Estado</th></tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div id="adminBancosView" class="hidden">
                        <div style="padding: 1rem;">
                            <div style="margin-bottom: 1rem;">
                                <button class="btn btn-success" onclick="showAddBancoModal()">Agregar Documento</button>
                            </div>
                            <div class="table-container">
                                <table id="bancosTable">
                                    <thead><tr><th>Tipo</th><th>Fecha Subida</th><th>Usuario</th><th>PDF</th></tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
<div id="addInquilinoModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title" id="addInquilinoTitle">Agregar Inquilino</h2>
                        <button class="close-modal" onclick="closeModal('addInquilinoModal')">Ã—</button>
                    </div>
                    <form id="inquilinoForm" onsubmit="saveInquilino(event)">
                        <div class="form-group"><label>Nombre de la Empresa *</label><input type="text" id="inquilinoNombre" required autocomplete="off"></div>
                        
                        <div class="form-group">
                            <label>Contactos</label>
                            <div id="inquilinoContactosList" class="contactos-list"></div>
                            <button type="button" class="btn btn-sm btn-secondary" onclick="showAddContactoInquilinoModal()">+ Agregar Contacto</button>
                        </div>
                        
                        <div class="form-group"><label>CLABE</label><input type="text" id="inquilinoClabe" autocomplete="off"></div>
                        <div class="form-group"><label>RFC</label><input type="text" id="inquilinoRFC" autocomplete="off"></div>
                        <div class="form-group"><label>MÂ²</label><input type="text" id="inquilinoM2" autocomplete="off"></div>
                        <div class="form-group"><label>Renta Mensual *</label><input type="number" id="inquilinoRenta" step="0.01" required autocomplete="off"></div>
                        <div class="form-group"><label>Fecha Inicio Contrato *</label><input type="date" id="inquilinoFechaInicio" required></div>
                        <div class="form-group"><label>Fecha Vencimiento Contrato *</label><input type="date" id="inquilinoFechaVenc" required></div>
                        <div class="form-group">
                            <label>Contrato (PDF)</label>
                            <div class="file-upload" onclick="document.getElementById('inquilinoContrato').click()">
                                <input type="file" id="inquilinoContrato" accept=".pdf">
                                <p>Click para seleccionar PDF del contrato</p>
                                <p id="contratoFileName" style="color: var(--success); margin-top: 0.5rem;"></p>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Documentos Adicionales (PDF)</label>
                            <div class="file-upload" onclick="document.getElementById('inquilinoDocAdicional').click()">
                                <input type="file" id="inquilinoDocAdicional" accept=".pdf">
                                <p>Click para seleccionar PDF adicional</p>
                                <p id="docAdicionalFileName" style="color: var(--success); margin-top: 0.5rem;"></p>
                            </div>
                        </div>
                        <div class="form-group hidden" id="nombreDocGroup">
                            <label>Nombre del Documento *</label>
                            <input type="text" id="inquilinoNombreDoc" autocomplete="off">
                        </div>
                        <div class="form-group"><label>Notas</label><textarea id="inquilinoNotas"></textarea></div>
                        <div class="modal-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeModal('addInquilinoModal')">Cancelar</button>
                            <button type="submit" class="btn btn-success">Guardar</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <div id="addContactoInquilinoModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title">Agregar Contacto</h2>
                        <button class="close-modal" onclick="closeModal('addContactoInquilinoModal')">Ã—</button>
                    </div>
                    <form id="contactoInquilinoForm" onsubmit="saveContactoInquilino(event)">
                        <div class="form-group"><label>Nombre *</label><input type="text" id="contactoInquilinoNombre" required autocomplete="off"></div>
                        <div class="form-group"><label>TelÃ©fono</label><input type="tel" id="contactoInquilinoTelefono" autocomplete="off"></div>
                        <div class="form-group"><label>Email</label><input type="email" id="contactoInquilinoEmail" autocomplete="off"></div>
                        <div class="modal-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeModal('addContactoInquilinoModal')">Cancelar</button>
                            <button type="submit" class="btn btn-success">Guardar</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <div id="inquilinoDetailModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-header-left">
                            <div class="dropdown">
                                <button class="dropdown-toggle" onclick="toggleDropdown('inquilinoDetailDropdown')" style="font-size: 1rem; padding: 0.5rem 1rem;">â˜°</button>
                                <div id="inquilinoDetailDropdown" class="dropdown-content">
                                    <a href="#" onclick="event.preventDefault(); showRegistrarPagoModal();">Dar Renta X Pagada</a>
                                    <a href="#" onclick="event.preventDefault(); editInquilino();">Modificar</a>
                                    <a href="#" onclick="event.preventDefault(); deleteInquilino();">Eliminar</a>
                                </div>
                            </div>
                        </div>
                        <h2 class="modal-title" id="inquilinoDetailNombre"></h2>
                        <button class="close-modal" onclick="closeModal('inquilinoDetailModal')">Ã—</button>
                    </div>
                    <div style="padding: 1.5rem;">
                        <div class="info-box">
                            <div class="info-box-title">CONTACTOS</div>
                            <div id="detailContactosList"></div>
                        </div>
                        <div class="info-box">
                            <div class="info-box-content">
                                <strong>RFC:</strong> <span id="detailRFC"></span> &nbsp;&nbsp;&nbsp; <strong>CLABE:</strong> <span id="detailClabe"></span>
                            </div>
                        </div>
                        <div class="tabs-container">
                            <div class="tabs">
                                <button class="tab active" onclick="switchTab('inquilino', 'renta')">Datos de Renta</button>
                                <button class="tab" onclick="switchTab('inquilino', 'pagos')">Historial de Pagos</button>
                                <button class="tab" onclick="switchTab('inquilino', 'docs')">Documentos Adicionales</button>
                            </div>
                            <div id="inquilinoRentaTab" class="tab-content active">
                                <div class="info-grid">
                                    <div class="info-item"><div class="info-label">Renta Mensual</div><div class="info-value currency" id="detailRenta"></div></div>
                                    <div class="info-item"><div class="info-label">MÂ²</div><div class="info-value" id="detailM2"></div></div>
                                    <div class="info-item"><div class="info-label">Fecha Inicio</div><div class="info-value" id="detailFechaInicio"></div></div>
                                    <div class="info-item"><div class="info-label">Fecha Vencimiento</div><div class="info-value" id="detailFechaVenc"></div></div>
                                </div>
                                <div id="contratoSection" class="hidden" style="margin-top: 1rem;">
                                    <button class="btn btn-sm btn-primary" onclick="viewContrato()">Ver Contrato PDF</button>
                                </div>
                            </div>
                            <div id="inquilinoPagosTab" class="tab-content">
                                <div id="historialPagos"></div>
                            </div>
                            <div id="inquilinoDocsTab" class="tab-content">
                                <div id="documentosAdicionales"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="registrarPagoModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title">Dar Renta X Pagada</h2>
                        <button class="close-modal" onclick="closeModal('registrarPagoModal')">Ã—</button>
                    </div>
                    <form onsubmit="savePagoRenta(event)">
                        <div style="padding: 1.5rem;">
                            <div class="form-group"><label>Fecha de Pago *</label><input type="date" id="pagoFecha" required></div>
                            <div class="form-group">
                                <label>Â¿Pago Completo? *</label>
                                <select id="pagoCompleto" onchange="toggleMontoInput()">
                                    <option value="si">SÃ­</option>
                                    <option value="no">No</option>
                                </select>
                            </div>
                            <div class="form-group hidden" id="pagoMontoGroup">
                                <label>Monto Pagado *</label>
                                <input type="number" id="pagoMonto" step="0.01">
                            </div>
                        </div>
                        <div class="modal-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeModal('registrarPagoModal')">Cancelar</button>
                            <button type="submit" class="btn btn-success">Guardar Pago</button>
                        </div>
                    </form>
                </div>
            </div>
            <div id="addProveedorModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title" id="addProveedorTitle">Agregar Proveedor</h2>
                        <button class="close-modal" onclick="closeModal('addProveedorModal')">Ã—</button>
                    </div>
                    <form id="proveedorForm" onsubmit="saveProveedor(event)">
                        <div class="form-group"><label>Nombre *</label><input type="text" id="proveedorNombre" required autocomplete="off"></div>
                        <div class="form-group"><label>Servicio *</label><input type="text" id="proveedorServicio" required autocomplete="off"></div>
                        
                        <div class="form-group">
                            <label>Contactos</label>
                            <div id="proveedorContactosList" class="contactos-list"></div>
                            <button type="button" class="btn btn-sm btn-secondary" onclick="showAddContactoProveedorModal()">+ Agregar Contacto</button>
                        </div>
                        
                        <div class="form-group"><label>CLABE</label><input type="text" id="proveedorClabe" autocomplete="off"></div>
                        <div class="form-group"><label>RFC</label><input type="text" id="proveedorRFC" autocomplete="off"></div>
                        <div class="form-group">
                            <label>Documentos Adicionales (PDF)</label>
                            <div class="file-upload" onclick="document.getElementById('proveedorDocAdicional').click()">
                                <input type="file" id="proveedorDocAdicional" accept=".pdf">
                                <p>Click para seleccionar PDF adicional</p>
                                <p id="provDocAdicionalFileName" style="color: var(--success); margin-top: 0.5rem;"></p>
                            </div>
                        </div>
                        <div class="form-group hidden" id="nombreProvDocGroup">
                            <label>Nombre del Documento *</label>
                            <input type="text" id="proveedorNombreDoc" autocomplete="off">
                        </div>
                        <div class="form-group"><label>Notas</label><textarea id="proveedorNotas"></textarea></div>
                        <div class="modal-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeModal('addProveedorModal')">Cancelar</button>
                            <button type="submit" class="btn btn-success">Guardar</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <div id="addContactoProveedorModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title">Agregar Contacto</h2>
                        <button class="close-modal" onclick="closeModal('addContactoProveedorModal')">Ã—</button>
                    </div>
                    <form id="contactoProveedorForm" onsubmit="saveContactoProveedor(event)">
                        <div class="form-group"><label>Nombre *</label><input type="text" id="contactoProveedorNombre" required autocomplete="off"></div>
                        <div class="form-group"><label>TelÃ©fono</label><input type="tel" id="contactoProveedorTelefono" autocomplete="off"></div>
                        <div class="form-group"><label>Email</label><input type="email" id="contactoProveedorEmail" autocomplete="off"></div>
                        <div class="modal-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeModal('addContactoProveedorModal')">Cancelar</button>
                            <button type="submit" class="btn btn-success">Guardar</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <div id="proveedorDetailModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-header-left">
                            <div class="dropdown">
                                <button class="dropdown-toggle" onclick="toggleDropdown('proveedorDetailDropdown')" style="font-size: 1rem; padding: 0.5rem 1rem;">â˜°</button>
                                <div id="proveedorDetailDropdown" class="dropdown-content">
                                    <a href="#" onclick="event.preventDefault(); showRegistrarFacturaModal();">Registrar Factura</a>
                                    <a href="#" onclick="event.preventDefault(); editProveedor();">Modificar Datos</a>
                                    <a href="#" onclick="event.preventDefault(); deleteProveedor();">Eliminar</a>
                                </div>
                            </div>
                        </div>
                        <h2 class="modal-title" id="proveedorDetailNombre"></h2>
                        <button class="close-modal" onclick="closeModal('proveedorDetailModal')">Ã—</button>
                    </div>
                    <div style="padding: 1.5rem;">
                        <div class="info-grid">
                            <div class="info-item"><div class="info-label">Servicio</div><div class="info-value" id="detailServicio"></div></div>
                        </div>
                        <div class="info-box">
                            <div class="info-box-title">CONTACTOS</div>
                            <div id="detailProvContactosList"></div>
                        </div>
                        <div class="info-box">
                            <div class="info-box-content">
                                <strong>RFC:</strong> <span id="detailProvRFC"></span> &nbsp;&nbsp;&nbsp; <strong>CLABE:</strong> <span id="detailProvClabe"></span>
                            </div>
                        </div>
                        <div class="tabs-container">
                            <div class="tabs">
                                <button class="tab active" onclick="switchTab('proveedor', 'pagadas')">Facturas Pagadas</button>
                                <button class="tab" onclick="switchTab('proveedor', 'porpagar')">Facturas X Pagar</button>
                                <button class="tab" onclick="switchTab('proveedor', 'docs')">Documentos Adicionales</button>
                            </div>
                            <div id="proveedorPagadasTab" class="tab-content active">
                                <div id="facturasPagadas"></div>
                            </div>
                            <div id="proveedorPorPagarTab" class="tab-content">
                                <div id="facturasPorPagar"></div>
                            </div>
                            <div id="proveedorDocsTab" class="tab-content">
                                <div id="proveedorDocumentosAdicionales"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="facturaDetailModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title">Detalle de Factura</h2>
                        <button class="close-modal" onclick="closeModal('facturaDetailModal')">Ã—</button>
                    </div>
                    <div style="padding: 1.5rem;">
                        <div class="info-grid">
                            <div class="info-item"><div class="info-label">Proveedor</div><div class="info-value" id="factDetailProveedor"></div></div>
                            <div class="info-item"><div class="info-label">NÃºmero</div><div class="info-value" id="factDetailNumero"></div></div>
                            <div class="info-item"><div class="info-label">Fecha</div><div class="info-value" id="factDetailFecha"></div></div>
                            <div class="info-item"><div class="info-label">Vencimiento</div><div class="info-value" id="factDetailVencimiento"></div></div>
                            <div class="info-item"><div class="info-label">Monto</div><div class="info-value currency" id="factDetailMonto"></div></div>
                            <div class="info-item"><div class="info-label">IVA</div><div class="info-value currency" id="factDetailIVA"></div></div>
                        </div>
                        <div style="margin-top: 1.5rem; text-align: center;">
                            <button class="btn btn-success" onclick="showPagarFacturaModalFromDetail()">Dar X Pagada</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="registrarFacturaModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title">Registrar Factura</h2>
                        <button class="close-modal" onclick="closeModal('registrarFacturaModal')">Ã—</button>
                    </div>
                    <form onsubmit="saveFactura(event)">
                        <div style="padding: 1.5rem;">
                            <div class="form-group"><label>NÃºmero de Factura</label><input type="text" id="facturaNumero" autocomplete="off"></div>
                            <div class="form-group"><label>Fecha Factura *</label><input type="date" id="facturaFecha" required></div>
                            <div class="form-group"><label>Vencimiento *</label><input type="date" id="facturaVencimiento" required></div>
                            <div class="form-group"><label>Monto *</label><input type="number" id="facturaMonto" step="0.01" required autocomplete="off" onchange="calculateIVA()"></div>
                            <div class="form-group"><label>IVA</label><input type="number" id="facturaIVA" step="0.01" autocomplete="off"></div>
                            <div class="form-group">
                                <label>Factura (PDF)</label>
                                <div class="file-upload" onclick="document.getElementById('facturaDocumento').click()">
                                    <input type="file" id="facturaDocumento" accept=".pdf">
                                    <p>Click para seleccionar PDF de la factura</p>
                                    <p id="facturaDocumentoFileName" style="color: var(--success); margin-top: 0.5rem;"></p>
                                </div>
                            </div>
                        </div>
                        <div class="modal-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeModal('registrarFacturaModal')">Cancelar</button>
                            <button type="submit" class="btn btn-success">Guardar</button>
                        </div>
                    </form>
                </div>
            </div>
            <div id="pagarFacturaModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title">Dar Factura X Pagada</h2>
                        <button class="close-modal" onclick="closeModal('pagarFacturaModal')">Ã—</button>
                    </div>
                    <form onsubmit="savePagoFactura(event)">
                        <div style="padding: 1.5rem;">
                            <div class="form-group"><label>Fecha de Pago *</label><input type="date" id="fechaPagoFactura" required></div>
                            <div class="form-group">
                                <label>Comprobante de Pago (PDF)</label>
                                <div class="file-upload" onclick="document.getElementById('pagoPDFFactura').click()">
                                    <input type="file" id="pagoPDFFactura" accept=".pdf">
                                    <p>Click para seleccionar PDF del comprobante</p>
                                    <p id="pagoPDFFacturaFileName" style="color: var(--success); margin-top: 0.5rem;"></p>
                                </div>
                            </div>
                        </div>
                        <div class="modal-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeModal('pagarFacturaModal')">Cancelar</button>
                            <button type="submit" class="btn btn-success">Guardar Pago</button>
                        </div>
                    </form>
                </div>
            </div>
            <div id="addActivoModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title" id="addActivoTitle">Agregar Activo</h2>
                        <button class="close-modal" onclick="closeModal('addActivoModal')">Ã—</button>
                    </div>
                    <form id="activoForm" onsubmit="saveActivo(event)">
                        <div class="form-group"><label>Nombre *</label><input type="text" id="activoNombre" required autocomplete="off"></div>
                        <div class="form-group"><label>Ãšltimo Mantenimiento</label><input type="date" id="activoUltimoMant"></div>
                        <div class="form-group"><label>PrÃ³ximo Mantenimiento</label><input type="date" id="activoProximoMant"></div>
                        <div class="form-group">
                            <label>Proveedor</label>
                            <select id="activoProveedor">
                                <option value="">-- Seleccione un proveedor --</option>
                            </select>
                        </div>
                        <div class="form-group"><label>Notas</label><textarea id="activoNotas"></textarea></div>
                        <div class="form-group">
                            <label>Fotos</label>
                            <div class="file-upload" onclick="document.getElementById('activoFotos').click()">
                                <input type="file" id="activoFotos" accept="image/*" multiple>
                                <p>Click para seleccionar fotos</p>
                                <p id="activoFotosFileName" style="color: var(--success); margin-top: 0.5rem;"></p>
                            </div>
                        </div>
                        <div class="modal-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeModal('addActivoModal')">Cancelar</button>
                            <button type="submit" class="btn btn-success">Guardar</button>
                        </div>
                    </form>
                </div>
            </div>
            <div id="activoDetailModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title" id="activoDetailNombre"></h2>
                        <button class="close-modal" onclick="closeModal('activoDetailModal')">Ã—</button>
                    </div>
                    <div style="padding: 1.5rem;">
                        <div class="info-grid">
                            <div class="info-item"><div class="info-label">Ãšltimo Mantenimiento</div><div class="info-value" id="detailUltimoMant"></div></div>
                            <div class="info-item"><div class="info-label">PrÃ³ximo Mantenimiento</div><div class="info-value" id="detailProximoMant"></div></div>
                            <div class="info-item"><div class="info-label">Proveedor</div><div class="info-value" id="detailActivoProveedor"></div></div>
                        </div>
                        <div class="info-item" style="margin-top: 1rem;"><div class="info-label">Notas</div><div class="info-value" id="detailActivoNotas"></div></div>
                        <h3 style="margin: 1.5rem 0 1rem 0;">Fotos</h3>
                        <div id="photoGallery" class="photo-gallery"></div>
                        <div class="modal-actions" style="margin-top: 1.5rem;">
                            <button class="btn btn-primary" onclick="editActivo()">Editar</button>
                            <button class="btn btn-danger" onclick="deleteActivo()">Eliminar</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="addUsuarioModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title" id="addUsuarioTitle">Agregar Usuario</h2>
                        <button class="close-modal" onclick="closeModal('addUsuarioModal')">Ã—</button>
                    </div>
                    <form id="usuarioForm" onsubmit="saveUsuario(event)">
                        <div class="form-group"><label>Nombre *</label><input type="text" id="usuarioNombre" required autocomplete="off"></div>
                        <div class="form-group"><label>Password *</label><input type="password" id="usuarioPassword" required autocomplete="new-password"></div>
                        <div class="modal-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeModal('addUsuarioModal')">Cancelar</button>
                            <button type="submit" class="btn btn-success">Guardar</button>
                        </div>
                    </form>
                </div>
            </div>
            <div id="addBancoModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title">Subir Documento Banco</h2>
                        <button class="close-modal" onclick="closeModal('addBancoModal')">Ã—</button>
                    </div>
                    <form id="bancoForm" onsubmit="saveBancoDoc(event)">
                        <div class="form-group">
                            <label>Tipo de Documento *</label>
                            <select id="bancoTipo" required>
                                <option value="">-- Seleccione --</option>
                                <option value="Estado de Cuenta">Estado de Cuenta</option>
                                <option value="Consulta de Movimientos">Consulta de Movimientos</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Documento (PDF) *</label>
                            <div class="file-upload" onclick="document.getElementById('bancoDocumento').click()">
                                <input type="file" id="bancoDocumento" accept=".pdf" required>
                                <p>Click para seleccionar PDF</p>
                                <p id="bancoDocumentoFileName" style="color: var(--success); margin-top: 0.5rem;"></p>
                            </div>
                        </div>
                        <div class="modal-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeModal('addBancoModal')">Cancelar</button>
                            <button type="submit" class="btn btn-success">Guardar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <script>
        const SUPABASE_URL = 'https://tzuvoceilkqurnujrraq.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR6dXZvY2VpbGtxdXJudWpycmFxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1Mjg3NDIsImV4cCI6MjA4NTEwNDc0Mn0.2bGNuh7nVhAFGULlXBT85wsKUMgJJbEEGtUq0jerqno';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let currentUser = '';
        let inquilinos = [];
        let proveedores = [];
        let activos = [];
        let usuarios = [];
        let bancosDocumentos = [];
        let currentInquilinoId = null;
        let currentProveedorId = null;
        let currentActivoId = null;
        let currentFacturaId = null;
        let currentUsuarioId = null;
        let isEditMode = false;
        let currentContratoFile = null;
        let currentFacturaDocFile = null;
        let currentPagoFacturaFile = null;
        let currentActivoFotos = [];
        let currentPageContext = 'home';
        let currentHomeTable = null;
        let currentDocAdicionalFile = null;
        let currentProvDocAdicionalFile = null;
        let tempInquilinoContactos = [];
        let tempProveedorContactos = [];
        let currentContactoEditIndex = null;

        function showLoading() { document.getElementById('loadingOverlay').classList.remove('hidden'); }
        function hideLoading() { document.getElementById('loadingOverlay').classList.add('hidden'); }

        function login(username) {
            if (!username) return;
            currentUser = username;
            document.getElementById('loginContainer').classList.add('hidden');
            document.getElementById('appContainer').classList.add('active');
            document.body.classList.add('logged-in');
            updateMainMenuForPage();
            setTimeout(() => loadAllData(), 100);
        }

        function logout() {
            if (!confirm('Â¿Cerrar sesiÃ³n?')) return;
            currentUser = '';
            document.getElementById('username').value = '';
            document.getElementById('loginContainer').classList.remove('hidden');
            document.getElementById('appContainer').classList.remove('active');
            document.body.classList.remove('logged-in');
        }

        function toggleMainMenu() {
            const dropdown = document.getElementById('mainMenuDropdown');
            dropdown.classList.toggle('show');
        }

        function showPageFromMenu(pageName) {
            currentPageContext = pageName;
            document.getElementById('mainMenuDropdown').classList.remove('show');
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageName + 'Page').classList.add('active');
            
            const titleMap = {
                'home': 'ESWU',
                'inquilinos': 'ESWU - Inquilinos',
                'proveedores': 'ESWU - Proveedores',
                'activos': 'ESWU - Activos',
                'admin': 'ESWU - AdministraciÃ³n'
            };
            document.getElementById('headerTitle').textContent = titleMap[pageName];
            
            const homeIcon = document.getElementById('homeIcon');
            if (pageName === 'home') {
                homeIcon.style.display = 'none';
            } else {
                homeIcon.style.display = 'block';
            }
            
            if (pageName === 'home') updateHomeView();
            if (pageName === 'inquilinos') showInquilinosView('list');
            if (pageName === 'proveedores') showProveedoresView('list');
            if (pageName === 'activos') renderActivosTable();
            if (pageName === 'admin') showAdminView('usuarios');
            updateMainMenuForPage();
        }

        function updateMainMenuForPage() {
            const mainMenu = document.getElementById('mainMenuDropdown');
            mainMenu.innerHTML = '';
            mainMenu.className = 'main-menu-content';
            
            if (currentPageContext === 'inquilinos') {
                mainMenu.classList.add('inquilinos-menu');
                const links = [
                    { text: 'Listado Inquilinos', action: () => showInquilinosView('list') },
                    { text: 'Agregar Inquilino', action: () => showAddInquilinoModal() },
                    { text: 'Rentas Recibidas', action: () => showInquilinosView('rentasRecibidas') },
                    { text: 'Vencimiento Contratos', action: () => showInquilinosView('vencimientoContratos') }
                ];
                links.forEach(link => {
                    const a = document.createElement('a');
                    a.href = '#';
                    a.textContent = link.text;
                    a.onclick = (e) => { e.preventDefault(); document.getElementById('mainMenuDropdown').classList.remove('show'); link.action(); };
                    mainMenu.appendChild(a);
                });
            } else if (currentPageContext === 'proveedores') {
                mainMenu.classList.add('proveedores-menu');
                const links = [
                    { text: 'Listado Proveedores', action: () => showProveedoresView('list') },
                    { text: 'Agregar Proveedor', action: () => showAddProveedorModal() },
                    { text: 'Facturas Pagadas', action: () => showProveedoresView('facturasPagadas') },
                    { text: 'Facturas Por Pagar', action: () => showProveedoresView('facturasPorPagar') }
                ];
                links.forEach(link => {
                    const a = document.createElement('a');
                    a.href = '#';
                    a.textContent = link.text;
                    a.onclick = (e) => { e.preventDefault(); document.getElementById('mainMenuDropdown').classList.remove('show'); link.action(); };
                    mainMenu.appendChild(a);
                });
            } else if (currentPageContext === 'activos') {
                const a = document.createElement('a');
                a.href = '#';
                a.textContent = 'Agregar Activo';
                a.onclick = (e) => { e.preventDefault(); document.getElementById('mainMenuDropdown').classList.remove('show'); showAddActivoModal(); };
                mainMenu.appendChild(a);
            } else if (currentPageContext === 'admin') {
                mainMenu.classList.add('admin-menu');
                const links = [
                    { text: 'Usuarios', action: () => showAdminView('usuarios') },
                    { text: 'Bancos', action: () => showAdminView('bancos') }
                ];
                links.forEach(link => {
                    const a = document.createElement('a');
                    a.href = '#';
                    a.textContent = link.text;
                    a.onclick = (e) => { e.preventDefault(); document.getElementById('mainMenuDropdown').classList.remove('show'); link.action(); };
                    mainMenu.appendChild(a);
                });
            } else {
                const pages = [
                    { id: 'inquilinos', name: 'Inquilinos' },
                    { id: 'proveedores', name: 'Proveedores' },
                    { id: 'activos', name: 'Activos' },
                    { id: 'admin', name: 'AdministraciÃ³n' }
                ];
                pages.forEach(page => {
                    const a = document.createElement('a');
                    a.href = '#';
                    a.textContent = page.name;
                    a.onclick = (e) => { e.preventDefault(); showPageFromMenu(page.id); };
                    mainMenu.appendChild(a);
                });
                
                const logoutLink = document.createElement('a');
                logoutLink.href = '#';
                logoutLink.textContent = 'Salir';
                logoutLink.onclick = (e) => { e.preventDefault(); logout(); };
                mainMenu.appendChild(logoutLink);
            }
        }

        async function loadAllData() {
            showLoading();
            try {
                await Promise.all([loadInquilinos(), loadProveedores(), loadActivos(), loadUsuarios(), loadBancosDocumentos()]);
                populateYearSelect();
                populateInquilinosYearSelects();
                populateProveedoresYearSelects();
                updateHomeView();
                console.log('âœ… Datos cargados');
            } catch (error) {
                console.error('Error cargando datos:', error);
                alert('Error al cargar datos. Por favor recarga la pÃ¡gina.');
            } finally {
                hideLoading();
            }
        }

        async function loadInquilinos() {
            try {
                const { data, error } = await supabaseClient
                    .from('inquilinos')
                    .select('*, pagos_inquilinos(*), inquilinos_documentos(*), inquilinos_contactos(*)')
                    .order('nombre');
                if (error) throw error;
                
                inquilinos = data.map(inq => ({
                    id: inq.id, 
                    nombre: inq.nombre, 
                    clabe: inq.clabe, 
                    rfc: inq.rfc, 
                    m2: inq.m2,
                    renta: parseFloat(inq.renta || 0), 
                    fechaInicio: inq.fecha_inicio,
                    fechaVencimiento: inq.fecha_vencimiento, 
                    notas: inq.notas,
                    contratoFile: inq.contrato_file, 
                    contratoFileName: inq.contrato_filename,
                    contactos: inq.inquilinos_contactos ? inq.inquilinos_contactos.map(c => ({
                        id: c.id, nombre: c.nombre, telefono: c.telefono, email: c.email
                    })) : [],
                    pagos: inq.pagos_inquilinos ? inq.pagos_inquilinos.map(p => ({
                        id: p.id, fecha: p.fecha, monto: parseFloat(p.monto),
                        completo: p.completo, pagoFile: p.pago_file, pagoFileName: p.pago_filename
                    })).sort((a, b) => new Date(b.fecha) - new Date(a.fecha)) : [],
                    documentos: inq.inquilinos_documentos ? inq.inquilinos_documentos.map(d => ({
                        id: d.id, nombre: d.nombre_documento, archivo: d.archivo_pdf, 
                        fecha: d.fecha_guardado, usuario: d.usuario_guardo
                    })).sort((a, b) => (a.nombre || '').localeCompare(b.nombre || '')) : []
                }));
            } catch (error) { 
                console.error('Error loading inquilinos:', error); 
                throw error; 
            }
        }

        async function loadProveedores() {
            try {
                const { data, error } = await supabaseClient
                    .from('proveedores')
                    .select('*, facturas(*), proveedores_documentos(*), proveedores_contactos(*)')
                    .order('nombre');
                if (error) throw error;
                
                proveedores = data.map(prov => ({
                    id: prov.id, 
                    nombre: prov.nombre, 
                    servicio: prov.servicio,
                    clabe: prov.clabe, 
                    rfc: prov.rfc, 
                    notas: prov.notas,
                    contactos: prov.proveedores_contactos ? prov.proveedores_contactos.map(c => ({
                        id: c.id, nombre: c.nombre, telefono: c.telefono, email: c.email
                    })) : [],
                    facturas: prov.facturas ? prov.facturas.map(f => ({
                        id: f.id, numero: f.numero, fecha: f.fecha, vencimiento: f.vencimiento,
                        monto: parseFloat(f.monto), iva: parseFloat(f.iva || 0), fechaPago: f.fecha_pago,
                        documentoFile: f.documento_file, documentoFileName: f.documento_filename,
                        pagoFile: f.pago_file, pagoFileName: f.pago_filename
                    })).sort((a, b) => new Date(b.fecha) - new Date(a.fecha)) : [],
                    documentos: prov.proveedores_documentos ? prov.proveedores_documentos.map(d => ({
                        id: d.id, nombre: d.nombre_documento, archivo: d.archivo_pdf,
                        fecha: d.fecha_guardado, usuario: d.usuario_guardo
                    })).sort((a, b) => (a.nombre || '').localeCompare(b.nombre || '')) : []
                }));
            } catch (error) { 
                console.error('Error loading proveedores:', error); 
                throw error; 
            }
        }

        async function loadActivos() {
            try {
                const { data, error } = await supabaseClient.from('activos').select('*, activos_fotos(*)').order('nombre');
                if (error) throw error;
                activos = data.map(act => ({
                    id: act.id, nombre: act.nombre, ultimoMant: act.ultimo_mant,
                    proximoMant: act.proximo_mant, proveedor: act.proveedor, notas: act.notas,
                    fotos: act.activos_fotos ? act.activos_fotos.map(f => ({ id: f.id, data: f.foto_data, name: f.foto_name })) : []
                }));
            } catch (error) { console.error('Error loading activos:', error); throw error; }
        }

        async function loadUsuarios() {
            try {
                const { data, error } = await supabaseClient.from('usuarios').select('*').order('nombre');
                if (error) throw error;
                usuarios = data.map(u => ({
                    id: u.id, nombre: u.nombre, password: u.password, activo: u.activo
                }));
            } catch (error) { console.error('Error loading usuarios:', error); throw error; }
        }

        async function loadBancosDocumentos() {
            try {
                const { data, error } = await supabaseClient.from('bancos_documentos').select('*').order('fecha_subida', { ascending: false });
                if (error) throw error;
                bancosDocumentos = data.map(b => ({
                    id: b.id, tipo: b.tipo, archivoPdf: b.archivo_pdf, fechaSubida: b.fecha_subida, usuarioSubio: b.usuario_subio
                }));
            } catch (error) { console.error('Error loading bancos:', error); throw error; }
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(amount);
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString + 'T00:00:00');
            const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
            return `${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear()}`;
        }

        function formatDateVencimiento(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString + 'T00:00:00');
            const today = new Date(); today.setHours(0, 0, 0, 0);
            const diffDays = Math.ceil((date - today) / (1000 * 60 * 60 * 24));
            const formatted = formatDate(dateString);
            if (diffDays <= 7 && diffDays >= 0) {
                return `<span class="vencimiento-proximo">${formatted}</span>`;
            }
            return formatted;
        }

        function populateYearSelect() {
            const currentYear = new Date().getFullYear();
            const yearSelect = document.getElementById('homeYear');
            yearSelect.innerHTML = '';
            for (let year = currentYear - 5; year <= currentYear + 1; year++) {
                const option = document.createElement('option');
                option.value = year; option.textContent = year;
                if (year === currentYear) option.selected = true;
                yearSelect.appendChild(option);
            }
        }

        function populateInquilinosYearSelects() {
            const currentYear = new Date().getFullYear();
            const select = document.getElementById('inquilinosRentasYear');
            select.innerHTML = '';
            for (let year = currentYear - 5; year <= currentYear + 1; year++) {
                const option = document.createElement('option');
                option.value = year; option.textContent = year;
                if (year === currentYear) option.selected = true;
                select.appendChild(option);
            }
        }

        function populateProveedoresYearSelects() {
            const currentYear = new Date().getFullYear();
            ['provFactPagYear', 'provFactPorPagYear'].forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '';
                    for (let year = currentYear - 5; year <= currentYear + 1; year++) {
                        const option = document.createElement('option');
                        option.value = year; option.textContent = year;
                        if (year === currentYear) option.selected = true;
                        select.appendChild(option);
                    }
                }
            });
        }

        function toggleHomeTable(tableName) {
            const ingresosContainer = document.getElementById('homeIngresosContainer');
            const pagosContainer = document.getElementById('homePagosContainer');
            
            if (currentHomeTable === tableName) {
                ingresosContainer.classList.add('hidden');
                pagosContainer.classList.add('hidden');
                currentHomeTable = null;
            } else {
                if (tableName === 'ingresos') {
                    ingresosContainer.classList.remove('hidden');
                    pagosContainer.classList.add('hidden');
                    renderHomeIngresos();
                } else if (tableName === 'pagos') {
                    ingresosContainer.classList.add('hidden');
                    pagosContainer.classList.remove('hidden');
                    renderHomePagosDetalle();
                }
                currentHomeTable = tableName;
            }
        }

        function updateHomeView() {
            const filterType = document.getElementById('homeFilter').value;
            const year = parseInt(document.getElementById('homeYear').value);
            const monthSelect = document.getElementById('homeMonth');
            
            if (filterType === 'mensual') monthSelect.classList.remove('hidden');
            else monthSelect.classList.add('hidden');
            
            const month = filterType === 'mensual' ? parseInt(monthSelect.value) : null;
            let totalIngresos = 0, totalGastos = 0;
            
            inquilinos.forEach(inq => {
                if (inq.pagos) {
                    inq.pagos.forEach(pago => {
                        const pd = new Date(pago.fecha + 'T00:00:00');
                        if (pd.getFullYear() === year && (month === null || pd.getMonth() === month)) totalIngresos += pago.monto;
                    });
                }
            });
            
            proveedores.forEach(prov => {
                if (prov.facturas) {
                    prov.facturas.forEach(fact => {
                        if (fact.fechaPago) {
                            const pd = new Date(fact.fechaPago + 'T00:00:00');
                            if (pd.getFullYear() === year && (month === null || pd.getMonth() === month)) totalGastos += fact.monto;
                        }
                    });
                }
            });
            
            document.getElementById('summaryIngresos').textContent = formatCurrency(totalIngresos);
            document.getElementById('summaryGastos').textContent = formatCurrency(totalGastos);
            document.getElementById('summaryNeto').textContent = formatCurrency(totalIngresos - totalGastos);
            
            if (currentHomeTable === 'ingresos') {
                renderHomeIngresos();
            } else if (currentHomeTable === 'pagos') {
                renderHomePagosDetalle();
            }
        }

        function renderHomeIngresos() {
            const filterType = document.getElementById('homeFilter').value;
            const year = parseInt(document.getElementById('homeYear').value);
            const month = filterType === 'mensual' ? parseInt(document.getElementById('homeMonth').value) : null;
            
            const tbody = document.getElementById('homeIngresosTable').querySelector('tbody');
            tbody.innerHTML = '';
            const pagos = [];
            let total = 0;
            
            inquilinos.forEach(inq => {
                if (inq.pagos) {
                    inq.pagos.forEach(pago => {
                        const pd = new Date(pago.fecha + 'T00:00:00');
                        if (pd.getFullYear() === year && (month === null || pd.getMonth() === month)) {
                            pagos.push({ inquilino: inq.nombre, inquilinoId: inq.id, fecha: pago.fecha, monto: pago.monto });
                            total += pago.monto;
                        }
                    });
                }
            });
            
            pagos.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            pagos.forEach(p => {
                const row = tbody.insertRow();
                row.className = 'clickable';
                row.onclick = () => showInquilinoDetail(p.inquilinoId);
                row.innerHTML = `<td>${p.inquilino}</td><td>${formatDate(p.fecha)}</td><td class="currency">${formatCurrency(p.monto)}</td>`;
            });
            
            if (pagos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:var(--text-light)">No hay ingresos</td></tr>';
            } else {
                const row = tbody.insertRow();
                row.style.fontWeight = 'bold'; row.style.backgroundColor = '#d4edda';
                row.innerHTML = `<td colspan="2" style="text-align:right;padding:1rem">TOTAL:</td><td class="currency" style="color:var(--success);font-size:1.1rem"><strong>${formatCurrency(total)}</strong></td>`;
            }
        }

        function renderHomePagosDetalle() {
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth();
            const currentYear = currentDate.getFullYear();
            
            const tbodyPorPagar = document.getElementById('homeFacturasPorPagarTable').querySelector('tbody');
            const tbodyPagadas = document.getElementById('homeFacturasPagadasTable').querySelector('tbody');
            tbodyPorPagar.innerHTML = '';
            tbodyPagadas.innerHTML = '';
            
            const porPagar = [];
            const pagadas = [];
            let totalPorPagar = 0;
            let totalPagadas = 0;
            
            proveedores.forEach(prov => {
                if (prov.facturas) {
                    prov.facturas.forEach(f => {
                        if (!f.fechaPago) {
                            porPagar.push({ proveedor: prov.nombre, proveedorId: prov.id, monto: f.monto, vencimiento: f.vencimiento });
                            totalPorPagar += f.monto;
                        } else {
                            const pd = new Date(f.fechaPago + 'T00:00:00');
                            if (pd.getMonth() === currentMonth && pd.getFullYear() === currentYear) {
                                pagadas.push({ proveedor: prov.nombre, proveedorId: prov.id, monto: f.monto, fecha: f.fechaPago });
                                totalPagadas += f.monto;
                            }
                        }
                    });
                }
            });
            
            porPagar.sort((a, b) => new Date(a.vencimiento) - new Date(b.vencimiento));
            const isMobile = window.innerWidth <= 768;
            porPagar.forEach(f => {
                const row = tbodyPorPagar.insertRow();
                row.className = 'clickable';
                row.onclick = () => showProveedorDetail(f.proveedorId);
                const proveedorText = isMobile && f.proveedor.length > 22 ? f.proveedor.substring(0, 22) + '...' : f.proveedor;
                row.innerHTML = `<td class="proveedor-truncate">${proveedorText}</td><td class="currency">${formatCurrency(f.monto)}</td><td>${formatDateVencimiento(f.vencimiento)}</td>`;
            });
            if (porPagar.length === 0) {
                tbodyPorPagar.innerHTML = '<tr><td colspan="3" style="text-align:center;color:var(--text-light)">No hay facturas por pagar</td></tr>';
            } else {
                const row = tbodyPorPagar.insertRow();
                row.className = 'total-row';
                row.innerHTML = `<td style="text-align:right;padding:1rem"><strong>TOTAL:</strong></td><td class="currency"><strong>${formatCurrency(totalPorPagar)}</strong></td><td></td>`;
            }
            
            pagadas.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            pagadas.forEach(f => {
                const row = tbodyPagadas.insertRow();
                row.className = 'clickable';
                row.onclick = () => showProveedorDetail(f.proveedorId);
                const proveedorText = isMobile && f.proveedor.length > 22 ? f.proveedor.substring(0, 22) + '...' : f.proveedor;
                row.innerHTML = `<td class="proveedor-truncate">${proveedorText}</td><td class="currency">${formatCurrency(f.monto)}</td><td>${formatDate(f.fecha)}</td>`;
            });
            if (pagadas.length === 0) {
                tbodyPagadas.innerHTML = '<tr><td colspan="3" style="text-align:center;color:var(--text-light)">No hay facturas pagadas este mes</td></tr>';
            } else {
                const row = tbodyPagadas.insertRow();
                row.className = 'total-row';
                row.innerHTML = `<td style="text-align:right;padding:1rem"><strong>TOTAL:</strong></td><td class="currency"><strong>${formatCurrency(totalPagadas)}</strong></td><td></td>`;
            }
        }

        function toggleDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            document.querySelectorAll('.dropdown-content').forEach(dd => {
                if (dd.id !== dropdownId) dd.classList.remove('show');
            });
            dropdown.classList.toggle('show');
        }

        window.onclick = function(event) {
            if (!event.target.matches('.dropdown-toggle')) {
                document.querySelectorAll('.dropdown-content').forEach(dd => dd.classList.remove('show'));
                document.querySelectorAll('.main-menu-content').forEach(dd => dd.classList.remove('show'));
            }
        }

        function switchTab(type, tabName) {
            if (type === 'inquilino') {
                document.querySelectorAll('#inquilinoDetailModal .tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('#inquilinoDetailModal .tab-content').forEach(tc => tc.classList.remove('active'));
                
                if (tabName === 'renta') {
                    document.querySelector('#inquilinoDetailModal .tab:nth-child(1)').classList.add('active');
                    document.getElementById('inquilinoRentaTab').classList.add('active');
                } else if (tabName === 'pagos') {
                    document.querySelector('#inquilinoDetailModal .tab:nth-child(2)').classList.add('active');
                    document.getElementById('inquilinoPagosTab').classList.add('active');
                } else if (tabName === 'docs') {
                    document.querySelector('#inquilinoDetailModal .tab:nth-child(3)').classList.add('active');
                    document.getElementById('inquilinoDocsTab').classList.add('active');
                }
            } else if (type === 'proveedor') {
                document.querySelectorAll('#proveedorDetailModal .tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('#proveedorDetailModal .tab-content').forEach(tc => tc.classList.remove('active'));
                
                if (tabName === 'pagadas') {
                    document.querySelector('#proveedorDetailModal .tab:nth-child(1)').classList.add('active');
                    document.getElementById('proveedorPagadasTab').classList.add('active');
                } else if (tabName === 'porpagar') {
                    document.querySelector('#proveedorDetailModal .tab:nth-child(2)').classList.add('active');
                    document.getElementById('proveedorPorPagarTab').classList.add('active');
                } else if (tabName === 'docs') {
                    document.querySelector('#proveedorDetailModal .tab:nth-child(3)').classList.add('active');
                    document.getElementById('proveedorDocsTab').classList.add('active');
                }
            }
        }

        function renderContactosList(contactos, containerId, deleteCallback) {
            const container = document.getElementById(containerId);
            if (!contactos || contactos.length === 0) {
                container.innerHTML = '<p style="color:var(--text-light);font-size:0.875rem">No hay contactos agregados</p>';
                return;
            }
            
            container.innerHTML = contactos.map((c, idx) => `
                <div class="contacto-item">
                    <div class="contacto-info">
                        <strong>${c.nombre}</strong><br>
                        <small>Tel: ${c.telefono || '-'} | Email: ${c.email || '-'}</small>
                    </div>
                    <button type="button" class="btn btn-sm btn-danger" onclick="${deleteCallback}(${idx})">Ã—</button>
                </div>
            `).join('');
        }

        function showAddContactoInquilinoModal() {
            document.getElementById('contactoInquilinoForm').reset();
            document.getElementById('addContactoInquilinoModal').classList.add('active');
        }

        function saveContactoInquilino(event) {
            event.preventDefault();
            const contacto = {
                nombre: document.getElementById('contactoInquilinoNombre').value,
                telefono: document.getElementById('contactoInquilinoTelefono').value,
                email: document.getElementById('contactoInquilinoEmail').value
            };
            tempInquilinoContactos.push(contacto);
            renderContactosList(tempInquilinoContactos, 'inquilinoContactosList', 'deleteInquilinoContacto');
            closeModal('addContactoInquilinoModal');
        }

        function deleteInquilinoContacto(index) {
            tempInquilinoContactos.splice(index, 1);
            renderContactosList(tempInquilinoContactos, 'inquilinoContactosList', 'deleteInquilinoContacto');
        }

        function showAddContactoProveedorModal() {
            document.getElementById('contactoProveedorForm').reset();
            document.getElementById('addContactoProveedorModal').classList.add('active');
        }

        function saveContactoProveedor(event) {
            event.preventDefault();
            const contacto = {
                nombre: document.getElementById('contactoProveedorNombre').value,
                telefono: document.getElementById('contactoProveedorTelefono').value,
                email: document.getElementById('contactoProveedorEmail').value
            };
            tempProveedorContactos.push(contacto);
            renderContactosList(tempProveedorContactos, 'proveedorContactosList', 'deleteProveedorContacto');
            closeModal('addContactoProveedorModal');
        }

        function deleteProveedorContacto(index) {
            tempProveedorContactos.splice(index, 1);
            renderContactosList(tempProveedorContactos, 'proveedorContactosList', 'deleteProveedorContacto');
        }

        function showInquilinosView(view) {
            document.getElementById('inquilinosListView').classList.add('hidden');
            document.getElementById('inquilinosRentasRecibidasView').classList.add('hidden');
            document.getElementById('inquilinosVencimientoContratosView').classList.add('hidden');
            
            const titulo = document.getElementById('inquilinosTitulo');
            if (view === 'list') {
                titulo.textContent = 'Inquilinos - Listado';
                document.getElementById('inquilinosListView').classList.remove('hidden');
                renderInquilinosTable();
            } else if (view === 'rentasRecibidas') {
                titulo.textContent = 'Inquilinos - Rentas Recibidas';
                document.getElementById('inquilinosRentasRecibidasView').classList.remove('hidden');
                renderInquilinosRentasRecibidas();
            } else if (view === 'vencimientoContratos') {
                titulo.textContent = 'Inquilinos - Vencimiento Contratos';
                document.getElementById('inquilinosVencimientoContratosView').classList.remove('hidden');
                renderInquilinosVencimientoContratos();
            }
        }

        function renderInquilinosTable() {
            const tbody = document.getElementById('inquilinosTable').querySelector('tbody');
            tbody.innerHTML = '';
            inquilinos.forEach(inq => {
                const row = tbody.insertRow();
                row.style.cursor = 'pointer';
                row.onclick = () => showInquilinoDetail(inq.id);
                const contratoBtn = inq.contratoFile ? `<button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); viewContratoDirect(${inq.id})">PDF</button>` : '-';
                row.innerHTML = `<td>${inq.nombre}</td><td class="currency">${formatCurrency(inq.renta)}</td><td>${formatDateVencimiento(inq.fechaVencimiento)}</td><td>${contratoBtn}</td>`;
            });
            if (inquilinos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--text-light)">No hay inquilinos</td></tr>';
            }
        }

        function renderInquilinosRentasRecibidas() {
            const tbody = document.getElementById('inquilinosRentasRecibidasTable').querySelector('tbody');
            tbody.innerHTML = '';
            const filterType = document.getElementById('inquilinosRentasFilter').value;
            const year = parseInt(document.getElementById('inquilinosRentasYear').value);
            const monthSelect = document.getElementById('inquilinosRentasMonth');
            
            if (filterType === 'mensual') monthSelect.classList.remove('hidden');
            else monthSelect.classList.add('hidden');
            
            const month = filterType === 'mensual' ? parseInt(monthSelect.value) : null;
            const rentas = [];
            let totalPeriodo = 0;
            
            inquilinos.forEach(inq => {
                if (inq.pagos) {
                    inq.pagos.forEach(pago => {
                        const pd = new Date(pago.fecha + 'T00:00:00');
                        if (pd.getFullYear() === year && (month === null || pd.getMonth() === month)) {
                            rentas.push({ empresa: inq.nombre, monto: pago.monto, fecha: pago.fecha });
                            totalPeriodo += pago.monto;
                        }
                    });
                }
            });
            
            rentas.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            rentas.forEach(r => {
                const row = tbody.insertRow();
                row.innerHTML = `<td>${r.empresa}</td><td class="currency">${formatCurrency(r.monto)}</td><td>${formatDate(r.fecha)}</td>`;
            });
            
            if (rentas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:var(--text-light)">No hay rentas</td></tr>';
            } else {
                const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                if (filterType === 'mensual') {
                    const row = tbody.insertRow();
                    row.style.fontWeight = 'bold'; row.style.backgroundColor = '#e6f2ff';
                    row.innerHTML = `<td style="text-align:right;padding:1rem;font-size:1.1rem">TOTAL ${monthNames[month].toUpperCase()} ${year}:</td><td class="currency" style="color:var(--primary);font-size:1.2rem">${formatCurrency(totalPeriodo)}</td><td></td>`;
                }
                let totalAnual = 0;
                inquilinos.forEach(inq => {
                    if (inq.pagos) {
                        inq.pagos.forEach(pago => {
                            const pd = new Date(pago.fecha + 'T00:00:00');
                            if (pd.getFullYear() === year) totalAnual += pago.monto;
                        });
                    }
                });
                const rowAnual = tbody.insertRow();
                rowAnual.style.fontWeight = 'bold'; rowAnual.style.backgroundColor = '#d4edda';
                rowAnual.innerHTML = `<td style="text-align:right;padding:1rem;font-size:1.1rem">TOTAL ${year}:</td><td class="currency" style="color:var(--success);font-size:1.2rem">${formatCurrency(totalAnual)}</td><td></td>`;
            }
        }

        function renderInquilinosVencimientoContratos() {
            const tbody = document.getElementById('inquilinosVencimientoContratosTable').querySelector('tbody');
            tbody.innerHTML = '';
            const today = new Date(); today.setHours(0, 0, 0, 0);
            
            inquilinos.forEach(inq => {
                const venc = new Date(inq.fechaVencimiento + 'T00:00:00');
                const diffDays = Math.ceil((venc - today) / (1000 * 60 * 60 * 24));
                let estado = '', badgeClass = '';
                if (diffDays < 0) { estado = 'Vencido'; badgeClass = 'badge-danger'; }
                else if (diffDays <= 30) { estado = 'PrÃ³ximo a vencer'; badgeClass = 'badge-warning'; }
                else { estado = 'Vigente'; badgeClass = 'badge-success'; }
                
                const row = tbody.insertRow();
                row.innerHTML = `<td>${inq.nombre}</td><td>${formatDate(inq.fechaInicio)}</td><td>${formatDateVencimiento(inq.fechaVencimiento)}</td><td>${diffDays}</td><td><span class="badge ${badgeClass}">${estado}</span></td>`;
            });
            
            if (inquilinos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--text-light)">No hay contratos</td></tr>';
            }
        }

        function showAddInquilinoModal() {
            isEditMode = false; 
            currentInquilinoId = null; 
            currentContratoFile = null; 
            currentDocAdicionalFile = null;
            tempInquilinoContactos = [];
            
            document.getElementById('addInquilinoTitle').textContent = 'Agregar Inquilino';
            document.getElementById('inquilinoForm').reset();
            document.getElementById('contratoFileName').textContent = '';
            document.getElementById('docAdicionalFileName').textContent = '';
            document.getElementById('nombreDocGroup').classList.add('hidden');
            renderContactosList([], 'inquilinoContactosList', 'deleteInquilinoContacto');
            document.getElementById('addInquilinoModal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        async function saveInquilino(event) {
            event.preventDefault();
            
            if (tempInquilinoContactos.length === 0) {
                alert('Debes agregar al menos un contacto');
                return;
            }
            
            showLoading();
            try {
                let contratoData = currentContratoFile;
                let contratoName = null;
                const contratoInput = document.getElementById('inquilinoContrato');
                if (contratoInput.files.length > 0) {
                    contratoData = await fileToBase64(contratoInput.files[0]);
                    contratoName = contratoInput.files[0].name;
                }
                
                const inquilinoData = {
                    nombre: document.getElementById('inquilinoNombre').value,
                    clabe: document.getElementById('inquilinoClabe').value,
                    rfc: document.getElementById('inquilinoRFC').value,
                    m2: document.getElementById('inquilinoM2').value,
                    renta: parseFloat(document.getElementById('inquilinoRenta').value),
                    fecha_inicio: document.getElementById('inquilinoFechaInicio').value,
                    fecha_vencimiento: document.getElementById('inquilinoFechaVenc').value,
                    notas: document.getElementById('inquilinoNotas').value,
                    contrato_file: contratoData,
                    contrato_filename: contratoName
                };
                
                let inquilinoId = currentInquilinoId;
                if (isEditMode) {
                    const { error } = await supabaseClient.from('inquilinos').update(inquilinoData).eq('id', currentInquilinoId);
                    if (error) throw error;
                    
                    // Borrar contactos existentes
                    await supabaseClient.from('inquilinos_contactos').delete().eq('inquilino_id', currentInquilinoId);
                } else {
                    const { data, error } = await supabaseClient.from('inquilinos').insert([inquilinoData]).select().single();
                    if (error) throw error;
                    inquilinoId = data.id;
                }
                
                // Guardar contactos
                for (const contacto of tempInquilinoContactos) {
                    const { error } = await supabaseClient.from('inquilinos_contactos').insert([{
                        inquilino_id: inquilinoId,
                        nombre: contacto.nombre,
                        telefono: contacto.telefono,
                        email: contacto.email
                    }]);
                    if (error) throw error;
                }
                
                const docAdicionalInput = document.getElementById('inquilinoDocAdicional');
                if (docAdicionalInput.files.length > 0) {
                    const nombreDoc = document.getElementById('inquilinoNombreDoc').value;
                    if (!nombreDoc) {
                        alert('Por favor ingrese un nombre para el documento');
                        hideLoading();
                        return;
                    }
                    const docData = await fileToBase64(docAdicionalInput.files[0]);
                    const { error } = await supabaseClient.from('inquilinos_documentos').insert([{
                        inquilino_id: inquilinoId,
                        nombre_documento: nombreDoc,
                        archivo_pdf: docData,
                        usuario_guardo: currentUser,
                        fecha_guardado: new Date().toISOString().split('T')[0]
                    }]);
                    if (error) throw error;
                }
                
                await loadInquilinos();
                renderInquilinosTable();
                closeModal('addInquilinoModal');
                isEditMode = false; 
                currentInquilinoId = null; 
                currentContratoFile = null; 
                currentDocAdicionalFile = null;
                tempInquilinoContactos = [];
            } catch (error) {
                console.error('Error:', error);
                alert('Error al guardar: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function showInquilinoDetail(id) {
            const inq = inquilinos.find(i => i.id === id);
            currentInquilinoId = id;
            document.getElementById('inquilinoDetailNombre').textContent = inq.nombre;
            
            const contactosList = document.getElementById('detailContactosList');
            if (inq.contactos && inq.contactos.length > 0) {
                contactosList.innerHTML = inq.contactos.map(c => `
                    <div style="margin-bottom:0.5rem;padding:0.5rem;background:white;border-radius:4px">
                        <strong>${c.nombre}</strong><br>
                        <small><strong>Tel:</strong> ${c.telefono || '-'} | <strong>Email:</strong> ${c.email || '-'}</small>
                    </div>
                `).join('');
            } else {
                contactosList.innerHTML = '<p style="color:var(--text-light)">No hay contactos</p>';
            }
            
            document.getElementById('detailRFC').textContent = inq.rfc || '-';
            document.getElementById('detailClabe').textContent = inq.clabe || '-';
            document.getElementById('detailRenta').textContent = formatCurrency(inq.renta);
            document.getElementById('detailM2').textContent = inq.m2 || '-';
            document.getElementById('detailFechaInicio').textContent = formatDate(inq.fechaInicio);
            document.getElementById('detailFechaVenc').innerHTML = formatDateVencimiento(inq.fechaVencimiento);
            
            if (inq.contratoFile) {
                document.getElementById('contratoSection').classList.remove('hidden');
            } else {
                document.getElementById('contratoSection').classList.add('hidden');
            }
            
            const historialDiv = document.getElementById('historialPagos');
            if (inq.pagos && inq.pagos.length > 0) {
                historialDiv.innerHTML = inq.pagos.map(p => `
                    <div class="payment-item">
                        <div><strong>${formatDate(p.fecha)}</strong><br>${formatCurrency(p.monto)}</div>
                        <div><span class="badge badge-success">Pagado</span><br><small style="color:var(--text-light)">${formatDate(p.fecha)}</small></div>
                    </div>
                `).join('');
            } else {
                historialDiv.innerHTML = '<p style="color:var(--text-light);text-align:center;padding:2rem">No hay pagos</p>';
            }
            
            const docsDiv = document.getElementById('documentosAdicionales');
            if (inq.documentos && inq.documentos.length > 0) {
                docsDiv.innerHTML = '<table style="width:100%"><thead><tr><th>Nombre</th><th>Fecha</th><th>Usuario</th></tr></thead><tbody>' +
                    inq.documentos.map(d => `
                        <tr class="doc-item" onclick="viewDocumento('${d.archivo}')">
                            <td>${d.nombre}</td>
                            <td>${formatDate(d.fecha)}</td>
                            <td>${d.usuario}</td>
                        </tr>
                    `).join('') + '</tbody></table>';
            } else {
                docsDiv.innerHTML = '<p style="color:var(--text-light);text-align:center;padding:2rem">No hay documentos adicionales</p>';
            }
            
            document.getElementById('inquilinoDetailModal').classList.add('active');
            switchTab('inquilino', 'renta');
        }

        function viewContrato() {
            const inq = inquilinos.find(i => i.id === currentInquilinoId);
            if (inq.contratoFile) {
                const newWindow = window.open();
                newWindow.document.write(`<iframe width='100%' height='100%' src='${inq.contratoFile}'></iframe>`);
            }
        }

        function viewContratoDirect(id) {
            const inq = inquilinos.find(i => i.id === id);
            if (inq.contratoFile) {
                const newWindow = window.open();
                newWindow.document.write(`<iframe width='100%' height='100%' src='${inq.contratoFile}'></iframe>`);
            }
        }

        function viewDocumento(archivo) {
            if (archivo) {
                const newWindow = window.open();
                newWindow.document.write(`<iframe width='100%' height='100%' src='${archivo}'></iframe>`);
            }
        }

        function editInquilino() {
            const inq = inquilinos.find(i => i.id === currentInquilinoId);
            isEditMode = true;
            currentContratoFile = inq.contratoFile;
            tempInquilinoContactos = [...inq.contactos];
            
            document.getElementById('addInquilinoTitle').textContent = 'Editar Inquilino';
            document.getElementById('inquilinoNombre').value = inq.nombre;
            document.getElementById('inquilinoClabe').value = inq.clabe || '';
            document.getElementById('inquilinoRFC').value = inq.rfc || '';
            document.getElementById('inquilinoM2').value = inq.m2 || '';
            document.getElementById('inquilinoRenta').value = inq.renta;
            document.getElementById('inquilinoFechaInicio').value = inq.fechaInicio;
            document.getElementById('inquilinoFechaVenc').value = inq.fechaVencimiento;
            document.getElementById('inquilinoNotas').value = inq.notas || '';
            if (inq.contratoFileName) {
                document.getElementById('contratoFileName').textContent = inq.contratoFileName;
            }
            renderContactosList(tempInquilinoContactos, 'inquilinoContactosList', 'deleteInquilinoContacto');
            closeModal('inquilinoDetailModal');
            document.getElementById('addInquilinoModal').classList.add('active');
        }

        async function deleteInquilino() {
            if (!confirm('Â¿Eliminar este inquilino?')) return;
            showLoading();
            try {
                const { error } = await supabaseClient.from('inquilinos').delete().eq('id', currentInquilinoId);
                if (error) throw error;
                await loadInquilinos();
                renderInquilinosTable();
                closeModal('inquilinoDetailModal');
            } catch (error) {
                console.error('Error:', error);
            } finally {
                hideLoading();
            }
        }

        function showRegistrarPagoModal() {
            const inq = inquilinos.find(i => i.id === currentInquilinoId);
            document.getElementById('pagoMonto').value = inq.renta;
            document.getElementById('pagoFecha').value = new Date().toISOString().split('T')[0];
            document.getElementById('pagoCompleto').value = 'si';
            document.getElementById('pagoMontoGroup').classList.add('hidden');
            document.getElementById('registrarPagoModal').classList.add('active');
        }

        function toggleMontoInput() {
            const completo = document.getElementById('pagoCompleto').value;
            const montoGroup = document.getElementById('pagoMontoGroup');
            if (completo === 'no') {
                montoGroup.classList.remove('hidden');
                document.getElementById('pagoMonto').required = true;
            } else {
                montoGroup.classList.add('hidden');
                document.getElementById('pagoMonto').required = false;
            }
        }

        async function savePagoRenta(event) {
            event.preventDefault();
            showLoading();
            try {
                const inq = inquilinos.find(i => i.id === currentInquilinoId);
                const completo = document.getElementById('pagoCompleto').value === 'si';
                const monto = completo ? inq.renta : parseFloat(document.getElementById('pagoMonto').value);
                
                const { error } = await supabaseClient.from('pagos_inquilinos').insert([{
                    inquilino_id: currentInquilinoId,
                    fecha: document.getElementById('pagoFecha').value,
                    monto: monto,
                    completo: completo
                }]);
                if (error) throw error;
                await loadInquilinos();
                showInquilinoDetail(currentInquilinoId);
                closeModal('registrarPagoModal');
            } catch (error) {
                console.error('Error:', error);
            } finally {
                hideLoading();
            }
        }

        function showProveedoresView(view) {
            document.getElementById('proveedoresListView').classList.add('hidden');
            document.getElementById('proveedoresFacturasPagadasView').classList.add('hidden');
            document.getElementById('proveedoresFacturasPorPagarView').classList.add('hidden');
            
            const titulo = document.getElementById('proveedoresTitulo');
            if (view === 'list') {
                titulo.textContent = 'Proveedores - Listado';
                document.getElementById('proveedoresListView').classList.remove('hidden');
                renderProveedoresTable();
            } else if (view === 'facturasPagadas') {
                titulo.textContent = 'Proveedores - Facturas Pagadas';
                document.getElementById('proveedoresFacturasPagadasView').classList.remove('hidden');
                renderProveedoresFacturasPagadas();
            } else if (view === 'facturasPorPagar') {
                titulo.textContent = 'Proveedores - Facturas Por Pagar';
                document.getElementById('proveedoresFacturasPorPagarView').classList.remove('hidden');
                renderProveedoresFacturasPorPagar();
            }
        }

        function renderProveedoresTable() {
            const tbody = document.getElementById('proveedoresTable').querySelector('tbody');
            tbody.innerHTML = '';
            proveedores.forEach(prov => {
                const row = tbody.insertRow();
                row.style.cursor = 'pointer';
                row.onclick = () => showProveedorDetail(prov.id);
                const primerContacto = prov.contactos && prov.contactos.length > 0 ? prov.contactos[0] : {};
                row.innerHTML = `<td style="max-width:250px;overflow:hidden;text-overflow:ellipsis">${prov.nombre}</td><td>${prov.servicio}</td><td style="max-width:250px;overflow:hidden;text-overflow:ellipsis">${primerContacto.nombre || '-'}</td><td>${primerContacto.telefono || '-'}</td><td>${primerContacto.email || '-'}</td>`;
            });
            if (proveedores.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--text-light)">No hay proveedores</td></tr>';
            }
        }

        function renderProveedoresFacturasPagadas() {
            const tbody = document.getElementById('proveedoresFacturasPagadasTable').querySelector('tbody');
            tbody.innerHTML = '';
            
            const filterType = document.getElementById('provFactPagFilter').value;
            const year = parseInt(document.getElementById('provFactPagYear').value);
            const monthSelect = document.getElementById('provFactPagMonth');
            
            if (filterType === 'mensual') monthSelect.classList.remove('hidden');
            else monthSelect.classList.add('hidden');
            
            const month = filterType === 'mensual' ? parseInt(monthSelect.value) : null;
            
            const pagadas = [];
            let totalPagadas = 0;
            
            proveedores.forEach(prov => {
                if (prov.facturas) {
                    prov.facturas.forEach(f => {
                        if (f.fechaPago) {
                            const pd = new Date(f.fechaPago + 'T00:00:00');
                            if (pd.getFullYear() === year && (month === null || pd.getMonth() === month)) {
                                pagadas.push({ proveedor: prov.nombre, numero: f.numero || 'S/N', monto: f.monto, fecha: f.fechaPago });
                                totalPagadas += f.monto;
                            }
                        }
                    });
                }
            });
            
            pagadas.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            pagadas.forEach(f => {
                const row = tbody.insertRow();
                row.innerHTML = `<td style="max-width:250px;overflow:hidden;text-overflow:ellipsis">${f.proveedor}</td><td>${f.numero}</td><td class="currency">${formatCurrency(f.monto)}</td><td>${formatDate(f.fecha)}</td>`;
            });
            
            if (pagadas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--text-light)">No hay facturas pagadas</td></tr>';
            } else {
                const row = tbody.insertRow();
                row.className = 'total-row';
                row.innerHTML = `<td colspan="2" style="text-align:right;padding:1rem"><strong>TOTAL:</strong></td><td class="currency"><strong>${formatCurrency(totalPagadas)}</strong></td><td></td>`;
            }
        }

        function renderProveedoresFacturasPorPagar() {
            const tbody = document.getElementById('proveedoresFacturasPorPagarTable').querySelector('tbody');
            tbody.innerHTML = '';
            
            const filterType = document.getElementById('provFactPorPagFilter').value;
            const year = parseInt(document.getElementById('provFactPorPagYear').value);
            const monthSelect = document.getElementById('provFactPorPagMonth');
            
            if (filterType === 'mensual') monthSelect.classList.remove('hidden');
            else monthSelect.classList.add('hidden');
            
            const month = filterType === 'mensual' ? parseInt(monthSelect.value) : null;
            
            const porPagar = [];
            let totalPorPagar = 0;
            
            proveedores.forEach(prov => {
                if (prov.facturas) {
                    prov.facturas.forEach(f => {
                        if (!f.fechaPago) {
                            const vd = new Date(f.vencimiento + 'T00:00:00');
                            if (vd.getFullYear() === year && (month === null || month === vd.getMonth())) {
                                porPagar.push({ 
                                    provId: prov.id, 
                                    factId: f.id, 
                                    proveedor: prov.nombre, 
                                    numero: f.numero || 'S/N', 
                                    monto: f.monto, 
                                    vencimiento: f.vencimiento, 
                                    documentoFile: f.documentoFile 
                                });
                                totalPorPagar += f.monto;
                            }
                        }
                    });
                }
            });
            
            porPagar.sort((a, b) => new Date(a.vencimiento) - new Date(b.vencimiento));
            porPagar.forEach(f => {
                const row = tbody.insertRow();
                const pdfLink = f.documentoFile ? `<a href="#" class="pdf-link" onclick="event.preventDefault(); viewFacturaDoc('${f.documentoFile}')">PDF</a>` : '-';
                row.innerHTML = `<td style="max-width:250px;overflow:hidden;text-overflow:ellipsis">${f.proveedor}</td><td>${f.numero}</td><td class="currency">${formatCurrency(f.monto)}</td><td>${formatDateVencimiento(f.vencimiento)}</td><td>${pdfLink}</td>`;
            });
            
            if (porPagar.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--text-light)">No hay facturas por pagar</td></tr>';
            } else {
                const row = tbody.insertRow();
                row.className = 'total-row';
                row.innerHTML = `<td colspan="2" style="text-align:right;padding:1rem"><strong>TOTAL:</strong></td><td class="currency"><strong>${formatCurrency(totalPorPagar)}</strong></td><td colspan="2"></td>`;
            }
        }

        function showAddProveedorModal() {
            isEditMode = false; 
            currentProveedorId = null; 
            currentProvDocAdicionalFile = null;
            tempProveedorContactos = [];
            
            document.getElementById('addProveedorTitle').textContent = 'Agregar Proveedor';
            document.getElementById('proveedorForm').reset();
            document.getElementById('provDocAdicionalFileName').textContent = '';
            document.getElementById('nombreProvDocGroup').classList.add('hidden');
            renderContactosList([], 'proveedorContactosList', 'deleteProveedorContacto');
            document.getElementById('addProveedorModal').classList.add('active');
        }

        async function saveProveedor(event) {
            event.preventDefault();
            
            if (tempProveedorContactos.length === 0) {
                alert('Debes agregar al menos un contacto');
                return;
            }
            
            showLoading();
            try {
                const provData = {
                    nombre: document.getElementById('proveedorNombre').value,
                    servicio: document.getElementById('proveedorServicio').value,
                    clabe: document.getElementById('proveedorClabe').value,
                    rfc: document.getElementById('proveedorRFC').value,
                    notas: document.getElementById('proveedorNotas').value
                };
                
                let proveedorId = currentProveedorId;
                if (isEditMode) {
                    const { error } = await supabaseClient.from('proveedores').update(provData).eq('id', currentProveedorId);
                    if (error) throw error;
                    
                    // Borrar contactos existentes
                    await supabaseClient.from('proveedores_contactos').delete().eq('proveedor_id', currentProveedorId);
                } else {
                    const { data, error } = await supabaseClient.from('proveedores').insert([provData]).select().single();
                    if (error) throw error;
                    proveedorId = data.id;
                }
                
                // Guardar contactos
                for (const contacto of tempProveedorContactos) {
                    const { error } = await supabaseClient.from('proveedores_contactos').insert([{
                        proveedor_id: proveedorId,
                        nombre: contacto.nombre,
                        telefono: contacto.telefono,
                        email: contacto.email
                    }]);
                    if (error) throw error;
                }
                
                const docAdicionalInput = document.getElementById('proveedorDocAdicional');
                if (docAdicionalInput.files.length > 0) {
                    const nombreDoc = document.getElementById('proveedorNombreDoc').value;
                    if (!nombreDoc) {
                        alert('Por favor ingrese un nombre para el documento');
                        hideLoading();
                        return;
                    }
                    const docData = await fileToBase64(docAdicionalInput.files[0]);
                    const { error } = await supabaseClient.from('proveedores_documentos').insert([{
                        proveedor_id: proveedorId,
                        nombre_documento: nombreDoc,
                        archivo_pdf: docData,
                        usuario_guardo: currentUser,
                        fecha_guardado: new Date().toISOString().split('T')[0]
                    }]);
                    if (error) throw error;
                }
                
                await loadProveedores();
                renderProveedoresTable();
                closeModal('addProveedorModal');
                isEditMode = false; 
                currentProveedorId = null; 
                currentProvDocAdicionalFile = null;
                tempProveedorContactos = [];
            } catch (error) {
                console.error('Error:', error);
                alert('Error al guardar: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function showProveedorDetail(id) {
            const prov = proveedores.find(p => p.id === id);
            currentProveedorId = id;
            document.getElementById('proveedorDetailNombre').textContent = prov.nombre;
            document.getElementById('detailServicio').textContent = prov.servicio;
            
            const contactosList = document.getElementById('detailProvContactosList');
            if (prov.contactos && prov.contactos.length > 0) {
                contactosList.innerHTML = prov.contactos.map(c => `
                    <div style="margin-bottom:0.5rem;padding:0.5rem;background:white;border-radius:4px">
                        <strong>${c.nombre}</strong><br>
                        <small><strong>Tel:</strong> ${c.telefono || '-'} | <strong>Email:</strong> ${c.email || '-'}</small>
                    </div>
                `).join('');
            } else {
                contactosList.innerHTML = '<p style="color:var(--text-light)">No hay contactos</p>';
            }
            
            document.getElementById('detailProvClabe').textContent = prov.clabe || '-';
            document.getElementById('detailProvRFC').textContent = prov.rfc || '-';
            
            const facturasPagadasDiv = document.getElementById('facturasPagadas');
            const facturasPagadas = prov.facturas.filter(f => f.fechaPago);
            let totalPagadas = 0;
            if (facturasPagadas.length > 0) {
                facturasPagadasDiv.innerHTML = facturasPagadas.map(f => {
                    totalPagadas += f.monto;
                    const facturaLink = f.documentoFile ? `<a href="#" class="pdf-link" onclick="event.preventDefault(); viewFacturaDoc('${f.documentoFile}')">Factura</a>` : '';
                    const pagoLink = f.pagoFile ? `<a href="#" class="pdf-link" onclick="event.preventDefault(); viewFacturaDoc('${f.pagoFile}')">Pago</a>` : '';
                    return `
                    <div class="payment-item">
                        <div class="payment-item-content">
                            <div><strong>Factura ${f.numero || 'S/N'}</strong> del <strong>${formatDate(f.fecha)}</strong> pagada el <strong>${formatDate(f.fechaPago)}</strong></div>
                            <div style="margin-top:0.5rem">${facturaLink} ${pagoLink}</div>
                        </div>
                        <div style="text-align:right"><strong>${formatCurrency(f.monto)}</strong></div>
                    </div>
                `}).join('') + `<div style="text-align:right;padding:1rem;background:#e6f2ff;font-weight:bold;margin-top:1rem">TOTAL: <strong>${formatCurrency(totalPagadas)}</strong></div>`;
            } else {
                facturasPagadasDiv.innerHTML = '<p style="color:var(--text-light);text-align:center;padding:2rem">No hay facturas pagadas</p>';
            }
            
            const facturasPorPagarDiv = document.getElementById('facturasPorPagar');
            const facturasPorPagar = prov.facturas.filter(f => !f.fechaPago);
            let totalPorPagar = 0;
            const isMobile = window.innerWidth <= 768;
            if (facturasPorPagar.length > 0) {
                if (isMobile) {
                    facturasPorPagarDiv.innerHTML = facturasPorPagar.map(f => {
                        totalPorPagar += f.monto;
                        const verLink = f.documentoFile ? `<button class="btn btn-sm btn-secondary" onclick="viewFacturaDoc('${f.documentoFile}')">Ver</button>` : '';
                        return `
                        <div class="payment-item">
                            <div class="payment-item-content" style="width:100%">
                                <div><strong>Factura ${f.numero || 'S/N'}</strong> del <strong>${formatDate(f.fecha)}</strong>, vence el <strong>${formatDate(f.vencimiento)}</strong></div>
                                <div style="margin-top:0.5rem;display:flex;gap:0.5rem;flex-wrap:wrap">
                                    ${verLink}
                                    <button class="btn btn-sm btn-primary" onclick="showPagarFacturaModal(${f.id})">Dar X Pagada</button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteFactura(${f.id})">Eliminar</button>
                                </div>
                                <div style="margin-top:0.5rem;text-align:right"><strong>${formatCurrency(f.monto)}</strong></div>
                            </div>
                        </div>
                    `}).join('') + `<div style="text-align:right;padding:1rem;background:#e6f2ff;font-weight:bold;margin-top:1rem">TOTAL: <strong>${formatCurrency(totalPorPagar)}</strong></div>`;
                } else {
                    facturasPorPagarDiv.innerHTML = facturasPorPagar.map(f => {
                        totalPorPagar += f.monto;
                        const verLink = f.documentoFile ? `<button class="btn btn-sm btn-secondary" onclick="viewFacturaDoc('${f.documentoFile}')">Ver</button>` : '';
                        return `
                        <div class="payment-item">
                            <div class="payment-item-content">
                                <div><strong>Factura ${f.numero || 'S/N'}</strong> del <strong>${formatDate(f.fecha)}</strong></div>
                                <div>Vence: ${formatDateVencimiento(f.vencimiento)}</div>
                                <div style="margin-top:0.5rem"><strong>${formatCurrency(f.monto)}</strong></div>
                            </div>
                            <div class="payment-item-actions">
                                ${verLink}
                                <button class="btn btn-sm btn-primary" onclick="showPagarFacturaModal(${f.id})">Dar X Pagada</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteFactura(${f.id})">Eliminar</button>
                            </div>
                        </div>
                    `}).join('') + `<div style="text-align:right;padding:1rem;background:#e6f2ff;font-weight:bold;margin-top:1rem">TOTAL: <strong>${formatCurrency(totalPorPagar)}</strong></div>`;
                }
            } else {
                facturasPorPagarDiv.innerHTML = '<p style="color:var(--text-light);text-align:center;padding:2rem">No hay facturas por pagar</p>';
            }
            
            const docsDiv = document.getElementById('proveedorDocumentosAdicionales');
            if (prov.documentos && prov.documentos.length > 0) {
                docsDiv.innerHTML = '<table style="width:100%;table-layout:fixed"><thead><tr><th style="width:50%">Nombre</th><th style="width:25%">Fecha</th><th style="width:25%">Usuario</th></tr></thead><tbody>' +
                    prov.documentos.map(d => `
                        <tr class="doc-item" onclick="viewDocumento('${d.archivo}')">
                            <td style="word-wrap:break-word">${d.nombre}</td>
                            <td>${formatDate(d.fecha)}</td>
                            <td>${d.usuario}</td>
                        </tr>
                    `).join('') + '</tbody></table>';
            } else {
                docsDiv.innerHTML = '<p style="color:var(--text-light);text-align:center;padding:2rem">No hay documentos adicionales</p>';
            }
            
            document.getElementById('proveedorDetailModal').classList.add('active');
            switchTab('proveedor', 'pagadas');
        }

        function viewFacturaDoc(archivo) {
            if (archivo) {
                const newWindow = window.open();
                newWindow.document.write(`<iframe width='100%' height='100%' src='${archivo}'></iframe>`);
            }
        }

        async function deleteFactura(facturaId) {
            if (!confirm('Â¿EstÃ¡s seguro que deseas eliminar esta factura?')) return;
            showLoading();
            try {
                const { error } = await supabaseClient.from('facturas').delete().eq('id', facturaId);
                if (error) throw error;
                await loadProveedores();
                showProveedorDetail(currentProveedorId);
            } catch (error) {
                console.error('Error:', error);
                alert('Error al eliminar factura: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function editProveedor() {
            const prov = proveedores.find(p => p.id === currentProveedorId);
            isEditMode = true;
            tempProveedorContactos = [...prov.contactos];
            
            document.getElementById('addProveedorTitle').textContent = 'Editar Proveedor';
            document.getElementById('proveedorNombre').value = prov.nombre;
            document.getElementById('proveedorServicio').value = prov.servicio;
            document.getElementById('proveedorClabe').value = prov.clabe || '';
            document.getElementById('proveedorRFC').value = prov.rfc || '';
            document.getElementById('proveedorNotas').value = prov.notas || '';
            renderContactosList(tempProveedorContactos, 'proveedorContactosList', 'deleteProveedorContacto');
            closeModal('proveedorDetailModal');
            document.getElementById('addProveedorModal').classList.add('active');
        }

        async function deleteProveedor() {
            if (!confirm('Â¿Eliminar este proveedor?')) return;
            showLoading();
            try {
                const { error } = await supabaseClient.from('proveedores').delete().eq('id', currentProveedorId);
                if (error) throw error;
                await loadProveedores();
                renderProveedoresTable();
                closeModal('proveedorDetailModal');
            } catch (error) {
                console.error('Error:', error);
            } finally {
                hideLoading();
            }
        }

        function calculateIVA() {
            const monto = parseFloat(document.getElementById('facturaMonto').value);
            if (!isNaN(monto) && monto > 0) {
                const iva = monto * 0.16 / 1.16;
                document.getElementById('facturaIVA').value = iva.toFixed(2);
            }
        }

        function showRegistrarFacturaModal() {
            currentFacturaDocFile = null;
            document.getElementById('facturaNumero').value = '';
            document.getElementById('facturaFecha').value = new Date().toISOString().split('T')[0];
            document.getElementById('facturaVencimiento').value = '';
            document.getElementById('facturaMonto').value = '';
            document.getElementById('facturaIVA').value = '';
            document.getElementById('facturaDocumentoFileName').textContent = '';
            document.getElementById('registrarFacturaModal').classList.add('active');
        }

        async function saveFactura(event) {
            event.preventDefault();
            showLoading();
            try {
                let docData = null, docName = null;
                const docInput = document.getElementById('facturaDocumento');
                if (docInput.files.length > 0) {
                    docData = await fileToBase64(docInput.files[0]);
                    docName = docInput.files[0].name;
                }
                
                const facturaData = {
                    proveedor_id: currentProveedorId,
                    numero: document.getElementById('facturaNumero').value,
                    fecha: document.getElementById('facturaFecha').value,
                    vencimiento: document.getElementById('facturaVencimiento').value,
                    monto: parseFloat(document.getElementById('facturaMonto').value),
                    iva: parseFloat(document.getElementById('facturaIVA').value || 0),
                    documento_file: docData,
                    documento_filename: docName
                };
                
                const { error } = await supabaseClient.from('facturas').insert([facturaData]);
                if (error) throw error;
                
                await loadProveedores();
                showProveedorDetail(currentProveedorId);
                closeModal('registrarFacturaModal');
            } catch (error) {
                console.error('Error:', error);
                alert('Error al guardar factura: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function showPagarFacturaModal(facturaId) {
            currentFacturaId = facturaId;
            currentPagoFacturaFile = null;
            document.getElementById('fechaPagoFactura').value = new Date().toISOString().split('T')[0];
            document.getElementById('pagoPDFFacturaFileName').textContent = '';
            document.getElementById('pagarFacturaModal').classList.add('active');
        }

        function showPagarFacturaModalFromDetail() {
            closeModal('facturaDetailModal');
            currentPagoFacturaFile = null;
            document.getElementById('fechaPagoFactura').value = new Date().toISOString().split('T')[0];
            document.getElementById('pagoPDFFacturaFileName').textContent = '';
            document.getElementById('pagarFacturaModal').classList.add('active');
        }

        async function savePagoFactura(event) {
            event.preventDefault();
            showLoading();
            try {
                let pagoData = null, pagoName = null;
                const pagoInput = document.getElementById('pagoPDFFactura');
                if (pagoInput.files.length > 0) {
                    pagoData = await fileToBase64(pagoInput.files[0]);
                    pagoName = pagoInput.files[0].name;
                }
                
                const { error } = await supabaseClient.from('facturas').update({
                    fecha_pago: document.getElementById('fechaPagoFactura').value,
                    pago_file: pagoData,
                    pago_filename: pagoName
                }).eq('id', currentFacturaId);
                if (error) throw error;
                await loadProveedores();
                if (currentProveedorId) {
                    showProveedorDetail(currentProveedorId);
                } else {
                    renderProveedoresFacturasPorPagar();
                }
                closeModal('pagarFacturaModal');
            } catch (error) {
                console.error('Error:', error);
            } finally {
                hideLoading();
            }
        }

        function populateProveedoresDropdown() {
            const select = document.getElementById('activoProveedor');
            select.innerHTML = '<option value="">-- Seleccione un proveedor --</option>';
            proveedores.forEach(prov => {
                const option = document.createElement('option');
                option.value = prov.nombre;
                option.textContent = prov.nombre;
                select.appendChild(option);
            });
        }

        function renderActivosTable() {
            const tbody = document.getElementById('activosTable').querySelector('tbody');
            tbody.innerHTML = '';
            activos.forEach(act => {
                const row = tbody.insertRow();
                row.style.cursor = 'pointer';
                row.onclick = () => showActivoDetail(act.id);
                row.innerHTML = `<td>${act.nombre}</td><td>${formatDate(act.ultimoMant)}</td><td>${formatDate(act.proximoMant)}</td><td>${act.proveedor || '-'}</td>`;
            });
            if (activos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--text-light)">No hay activos</td></tr>';
            }
        }

        function showAddActivoModal() {
            isEditMode = false; currentActivoId = null; currentActivoFotos = [];
            document.getElementById('addActivoTitle').textContent = 'Agregar Activo';
            document.getElementById('activoForm').reset();
            document.getElementById('activoFotosFileName').textContent = '';
            populateProveedoresDropdown();
            document.getElementById('addActivoModal').classList.add('active');
        }

        async function saveActivo(event) {
            event.preventDefault();
            showLoading();
            try {
                const actData = {
                    nombre: document.getElementById('activoNombre').value,
                    ultimo_mant: document.getElementById('activoUltimoMant').value,
                    proximo_mant: document.getElementById('activoProximoMant').value,
                    proveedor: document.getElementById('activoProveedor').value,
                    notas: document.getElementById('activoNotas').value
                };
                
                let activoId = currentActivoId;
                if (isEditMode) {
                    const { error } = await supabaseClient.from('activos').update(actData).eq('id', currentActivoId);
                    if (error) throw error;
                } else {
                    const { data, error } = await supabaseClient.from('activos').insert([actData]).select().single();
                    if (error) throw error;
                    activoId = data.id;
                }
                
                const fotosInput = document.getElementById('activoFotos');
                if (fotosInput.files.length > 0) {
                    for (const file of fotosInput.files) {
                        const fotoData = await fileToBase64(file);
                        const { error } = await supabaseClient.from('activos_fotos').insert([{
                            activo_id: activoId,
                            foto_data: fotoData,
                            foto_name: file.name
                        }]);
                        if (error) throw error;
                    }
                }
                
                await loadActivos();
                renderActivosTable();
                closeModal('addActivoModal');
                isEditMode = false; currentActivoId = null; currentActivoFotos = [];
            } catch (error) {
                console.error('Error:', error);
            } finally {
                hideLoading();
            }
        }

        function showActivoDetail(id) {
            const act = activos.find(a => a.id === id);
            currentActivoId = id;
            document.getElementById('activoDetailNombre').textContent = act.nombre;
            document.getElementById('detailUltimoMant').textContent = formatDate(act.ultimoMant);
            document.getElementById('detailProximoMant').textContent = formatDate(act.proximoMant);
            document.getElementById('detailActivoProveedor').textContent = act.proveedor || '-';
            document.getElementById('detailActivoNotas').textContent = act.notas || '-';
            
            const gallery = document.getElementById('photoGallery');
            if (act.fotos && act.fotos.length > 0) {
                gallery.innerHTML = act.fotos.map(f => `
                    <div class="photo-item">
                        <img src="${f.data}" alt="${f.name}">
                    </div>
                `).join('');
            } else {
                gallery.innerHTML = '<p style="color:var(--text-light);text-align:center">No hay fotos</p>';
            }
            
            document.getElementById('activoDetailModal').classList.add('active');
        }

        function editActivo() {
            const act = activos.find(a => a.id === currentActivoId);
            isEditMode = true;
            currentActivoFotos = act.fotos;
            document.getElementById('addActivoTitle').textContent = 'Editar Activo';
            document.getElementById('activoNombre').value = act.nombre;
            document.getElementById('activoUltimoMant').value = act.ultimoMant || '';
            document.getElementById('activoProximoMant').value = act.proximoMant || '';
            populateProveedoresDropdown();
            document.getElementById('activoProveedor').value = act.proveedor || '';
            document.getElementById('activoNotas').value = act.notas || '';
            closeModal('activoDetailModal');
            document.getElementById('addActivoModal').classList.add('active');
        }

        async function deleteActivo() {
            if (!confirm('Â¿Eliminar este activo?')) return;
            showLoading();
            try {
                const { error } = await supabaseClient.from('activos').delete().eq('id', currentActivoId);
                if (error) throw error;
                await loadActivos();
                renderActivosTable();
                closeModal('activoDetailModal');
            } catch (error) {
                console.error('Error:', error);
            } finally {
                hideLoading();
            }
        }

        function showAdminView(view) {
            document.getElementById('adminUsuariosView').classList.add('hidden');
            document.getElementById('adminBancosView').classList.add('hidden');
            
            const titulo = document.getElementById('adminTitulo');
            if (view === 'usuarios') {
                titulo.textContent = 'AdministraciÃ³n - Usuarios';
                document.getElementById('adminUsuariosView').classList.remove('hidden');
                renderUsuariosTable();
            } else if (view === 'bancos') {
                titulo.textContent = 'AdministraciÃ³n - Bancos';
                document.getElementById('adminBancosView').classList.remove('hidden');
                renderBancosTable();
            }
        }

        function renderUsuariosTable() {
            const tbody = document.getElementById('usuariosTable').querySelector('tbody');
            tbody.innerHTML = '';
            usuarios.forEach(u => {
                const row = tbody.insertRow();
                row.style.cursor = 'pointer';
                row.onclick = () => showUsuarioDetail(u.id);
                const estadoBadge = u.activo ? '<span class="badge badge-success">Activo</span>' : '<span class="badge badge-danger">Inactivo</span>';
                row.innerHTML = `<td>${u.nombre}</td><td>â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢</td><td>${estadoBadge}</td>`;
            });
            if (usuarios.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:var(--text-light)">No hay usuarios</td></tr>';
            }
        }

        function renderBancosTable() {
            const tbody = document.getElementById('bancosTable').querySelector('tbody');
            tbody.innerHTML = '';
            bancosDocumentos.forEach(b => {
                const row = tbody.insertRow();
                const pdfLink = `<a href="#" class="pdf-link" onclick="event.preventDefault(); viewDocumento('${b.archivoPdf}')">Ver PDF</a>`;
                const tipoAbreviado = b.tipo === 'Consulta de Movimientos' ? 'Mov' : 'EdeC';
                row.innerHTML = `<td>${tipoAbreviado}</td><td>${formatDate(b.fechaSubida)}</td><td>${b.usuarioSubio}</td><td>${pdfLink}</td>`;
            });
            if (bancosDocumentos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--text-light)">No hay documentos</td></tr>';
            }
        }

        function showUsuarioDetail(id) {
            const usuario = usuarios.find(u => u.id === id);
            currentUsuarioId = id;
            isEditMode = true;
            document.getElementById('addUsuarioTitle').textContent = 'Editar Usuario';
            document.getElementById('usuarioNombre').value = usuario.nombre;
            document.getElementById('usuarioPassword').value = usuario.password;
            document.getElementById('addUsuarioModal').classList.add('active');
        }

        function showAddUsuarioModal() {
            isEditMode = false; currentUsuarioId = null;
            document.getElementById('addUsuarioTitle').textContent = 'Agregar Usuario';
            document.getElementById('usuarioForm').reset();
            document.getElementById('addUsuarioModal').classList.add('active');
        }

        async function saveUsuario(event) {
            event.preventDefault();
            showLoading();
            try {
                const usuarioData = {
                    nombre: document.getElementById('usuarioNombre').value,
                    password: document.getElementById('usuarioPassword').value,
                    activo: true
                };
                
                if (isEditMode) {
                    const { error } = await supabaseClient.from('usuarios').update(usuarioData).eq('id', currentUsuarioId);
                    if (error) throw error;
                } else {
                    const { error } = await supabaseClient.from('usuarios').insert([usuarioData]);
                    if (error) throw error;
                }
                
                await loadUsuarios();
                renderUsuariosTable();
                closeModal('addUsuarioModal');
                isEditMode = false; currentUsuarioId = null;
            } catch (error) {
                console.error('Error:', error);
                alert('Error al guardar usuario: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function showAddBancoModal() {
            document.getElementById('bancoForm').reset();
            document.getElementById('bancoDocumentoFileName').textContent = '';
            document.getElementById('addBancoModal').classList.add('active');
        }

        async function saveBancoDoc(event) {
            event.preventDefault();
            showLoading();
            try {
                const docInput = document.getElementById('bancoDocumento');
                if (docInput.files.length === 0) {
                    alert('Por favor seleccione un documento PDF');
                    hideLoading();
                    return;
                }
                
                const docData = await fileToBase64(doc 
                                                   Input.files[0]);
                
                const bancoData = {
                    tipo: document.getElementById('bancoTipo').value,
                    archivo_pdf: docData,
                    usuario_subio: currentUser,
                    fecha_subida: new Date().toISOString().split('T')[0]
                };
                
                const { error } = await supabaseClient.from('bancos_documentos').insert([bancoData]);
                if (error) throw error;
                
                await loadBancosDocumentos();
                renderBancosTable();
                closeModal('addBancoModal');
            } catch (error) {
                console.error('Error:', error);
                alert('Error al guardar documento: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log('ðŸš€ ESWU iniciado');
            
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const username = document.getElementById('username').value;
                    if (username) login(username);
                });
            }
            
            const inquilinoContrato = document.getElementById('inquilinoContrato');
            if (inquilinoContrato) {
                inquilinoContrato.addEventListener('change', function(e) {
                    if (e.target.files.length > 0) {
                        document.getElementById('contratoFileName').textContent = e.target.files[0].name;
                    }
                });
            }
            
            const inquilinoDocAdicional = document.getElementById('inquilinoDocAdicional');
            if (inquilinoDocAdicional) {
                inquilinoDocAdicional.addEventListener('change', function(e) {
                    if (e.target.files.length > 0) {
                        document.getElementById('docAdicionalFileName').textContent = e.target.files[0].name;
                        document.getElementById('nombreDocGroup').classList.remove('hidden');
                    } else {
                        document.getElementById('nombreDocGroup').classList.add('hidden');
                    }
                });
            }
            
            const proveedorDocAdicional = document.getElementById('proveedorDocAdicional');
            if (proveedorDocAdicional) {
                proveedorDocAdicional.addEventListener('change', function(e) {
                    if (e.target.files.length > 0) {
                        document.getElementById('provDocAdicionalFileName').textContent = e.target.files[0].name;
                        document.getElementById('nombreProvDocGroup').classList.remove('hidden');
                    } else {
                        document.getElementById('nombreProvDocGroup').classList.add('hidden');
                    }
                });
            }
            
            const facturaDocumento = document.getElementById('facturaDocumento');
            if (facturaDocumento) {
                facturaDocumento.addEventListener('change', function(e) {
                    if (e.target.files.length > 0) {
                        document.getElementById('facturaDocumentoFileName').textContent = e.target.files[0].name;
                    }
                });
            }
            
            const pagoPDFFactura = document.getElementById('pagoPDFFactura');
            if (pagoPDFFactura) {
                pagoPDFFactura.addEventListener('change', function(e) {
                    if (e.target.files.length > 0) {
                        document.getElementById('pagoPDFFacturaFileName').textContent = e.target.files[0].name;
                    }
                });
            }
            
            const activoFotos = document.getElementById('activoFotos');
            if (activoFotos) {
                activoFotos.addEventListener('change', function(e) {
                    if (e.target.files.length > 0) {
                        document.getElementById('activoFotosFileName').textContent = `${e.target.files.length} foto(s) seleccionada(s)`;
                    }
                });
            }
            
            const bancoDocumento = document.getElementById('bancoDocumento');
            if (bancoDocumento) {
                bancoDocumento.addEventListener('change', function(e) {
                    if (e.target.files.length > 0) {
                        document.getElementById('bancoDocumentoFileName').textContent = e.target.files[0].name;
                    }
                });
            }
            
            document.getElementById('homeIcon').style.display = 'none';
        });
    </script>
</body>
</html>
